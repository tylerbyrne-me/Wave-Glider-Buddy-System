<!DOCTYPE html>
<html data-bs-theme="dark">
<head>
  <title>Wave Glider Status - {{ mission }}</title>
  <!-- Include Chart.js and its date adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
      <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/custom.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body class="container-fluid py-4" data-mission-id="{{ mission }}" data-is-realtime="{{ is_current_mission_realtime | lower }}">
  <!-- Project Title -->
  <div class="row mb-4">
    <div class="col-12 text-center">
      <h1>Wave Glider Buddy System</h1>
    </div>
  </div>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1>Current Mission Status: <span id="currentMissionDisplay">{{ mission }}</span></h1>
      <h6 class="text-muted fst-italic" id="dataSourceIndicator">
        {{ display_source_path }}
        {% if current_source_preference %}
          <br><small>(Requested source: {{ "Local" if current_source_preference == 'local' else "Remote" }})</small>
        {% endif %}
      </h6>
    </div>
    <div class="d-flex align-items-center">
      <!-- UTC Clock and Refresh Countdown -->
      <div id="utcClock" class="me-3" style="font-size: 0.9rem; color: #adb5bd;">
        Loading UTC time...
      </div>
      <div id="refreshCountdown" class="me-3" style="font-size: 0.9rem; color: #adb5bd; display: none;">
      </div>
      <!-- Group for Mission Selector -->
      <div class="d-flex align-items-center me-2">
        <label for="missionSelector" class="form-label mb-0 me-2">Select Mission:</label>
        <select id="missionSelector" class="form-select form-select-sm" style="width: auto;">
          {% for m_id in available_missions | sort %} {# Optional: Sort missions alphabetically #}
            <option value="{{ m_id }}" {% if m_id == mission %}selected{% endif %}>
              {{ m_id }}
            </option>
          {% endfor %}
        </select>
      </div>
      <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#dataSourceModal">
        Change Data Source
      </button>
      <button type="button" class="btn btn-sm btn-success ms-2" id="refreshDataBtn">
        Refresh Data
      </button>
    </div>
  </div>

  <!-- --- Data Source Modal --- -->
  <!-- Data Source Modal -->
  <div class="modal fade" id="dataSourceModal" tabindex="-1" aria-labelledby="dataSourceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="dataSourceModalLabel">Select Data Source</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="form-check mb-2"> {# Added margin-bottom #}
            <input class="form-check-input" type="radio" name="dataSourceOption" id="sourceRemote" value="remote" {% if not current_source or current_source == 'remote' %}checked{% endif %}>
            <label class="form-check-label" for="sourceRemote">
              Remote Data (Default: Remote first, then local fallback)
            </label>
          </div>
          <div class="form-check mb-2"> {# Added margin-bottom #}
            <input class="form-check-input" type="radio" name="dataSourceOption" id="sourceLocal" value="local" {% if current_source == 'local' %}checked{% endif %}>
            <label class="form-check-label" for="sourceLocal">
              Local Data Only
            </label>
          </div>
          <div class="mt-3" id="localPathInputGroup" style="display: {% if current_source == 'local' %}block{% else %}none{% endif %};">
            <label for="customLocalPath" class="form-label">Custom Local Data Path (optional):</label>
            <input type="text" class="form-control" id="customLocalPath" placeholder="e.g., C:\my_glider_data" value="{{ current_local_path or '' }}">
            <small class="form-text text-muted">If blank, uses default local path from system config.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="applyDataSource">Apply</button>
        </div>
      </div>
    </div>
  </div>

  <!-- --- General Error Display --- -->
  <!-- General Error Display Area -->
  <div id="generalErrorDisplay" class="alert alert-danger" style="display: none;" role="alert">
    An error occurred. Please check console for details or try again later.
  </div>

    <!-- New Two-Column Layout for Dashboard Content -->
  <div class="row" id="dashboard-main-content">
    <!-- Left Navigation Panel (Summary Cards) -->
    <div class="col-md-3" id="left-nav-panel">
      <!-- Power Summary Card -->
      <div class="summary-card active-card" data-category="power" data-mini-trend='{{ power_info.mini_trend | tojson | safe if power_info and "mini_trend" in power_info and power_info.mini_trend is not none else "[]" }}'>
        <div class="summary-card-main-content">
          <div class="mini-chart-container">
            <canvas id="miniPowerChart"></canvas>
          </div>
          <div class="summary-card-text-content">
            <h5>Power</h5>
            <div class="mini-summary">
              {% if power_info and power_info['values'] is not none %}
                Batt: {{ "%.0f"|format(power_info['values'].get('BatteryPercentage')) if power_info['values'].get('BatteryPercentage') is not none else 'N/A' }}%<br>
                Net: {{ "%.0f"|format(power_info['values']['NetPowerWatts']) if power_info['values']['NetPowerWatts'] is not none else 'N/A' }} W
              {% else %} N/A {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ power_info.time_ago_str if power_info else 'N/A' }}
        </div>
      </div>

      <!-- CTD Summary Card -->
      <div class="summary-card" data-category="ctd" data-mini-trend='{{ ctd_info.mini_trend | tojson | safe if ctd_info and "mini_trend" in ctd_info and ctd_info.mini_trend is not none else "[]" }}'>
        <div class="summary-card-main-content">
          <div class="mini-chart-container">
            <canvas id="miniCtdChart"></canvas>
          </div>
          <div class="summary-card-text-content">
            <h5>CTD</h5>
            <div class="mini-summary">
              {% if ctd_info and ctd_info['values'] is not none %}
                Temp: {{ "%.1f"|format(ctd_info['values']['WaterTemperature']) if ctd_info['values']['WaterTemperature'] is not none else 'N/A' }} °C<br>
                Sal: {{ "%.1f"|format(ctd_info['values']['Salinity']) if ctd_info['values']['Salinity'] is not none else 'N/A' }} PSU
              {% else %} N/A {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ ctd_info.time_ago_str if ctd_info else 'N/A' }}
        </div>
      </div>

      <!-- Weather Summary Card -->
      <div class="summary-card" data-category="weather" data-mini-trend='{{ weather_info.mini_trend | tojson | safe if weather_info and "mini_trend" in weather_info and weather_info.mini_trend is not none else "[]" }}'>
        <div class="summary-card-main-content">
          <div class="mini-chart-container">
            <canvas id="miniWeatherChart"></canvas>
          </div>
          <div class="summary-card-text-content">
            <h5>Weather</h5>
            <div class="mini-summary">
              {% if weather_info and weather_info['values'] is not none %}
                Air: {{ "%.1f"|format(weather_info['values']['AirTemperature']) if weather_info['values']['AirTemperature'] is not none else 'N/A' }} °C<br>
                Wind: {{ "%.1f"|format(weather_info['values']['WindSpeed']) if weather_info['values']['WindSpeed'] is not none else 'N/A' }} kt
              {% else %} N/A {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ weather_info.time_ago_str if weather_info else 'N/A' }}
        </div>
      </div>

      <!-- Waves Summary Card -->
      <div class="summary-card" data-category="waves" data-mini-trend='{{ wave_info.mini_trend | tojson | safe if wave_info and "mini_trend" in wave_info and wave_info.mini_trend is not none else "[]" }}'>
        <div class="summary-card-main-content">
          <div class="mini-chart-container">
            <canvas id="miniWaveChart"></canvas>
          </div>
          <div class="summary-card-text-content">
            <h5>Waves</h5>
            <div class="mini-summary">
              {% if wave_info and wave_info['values'] is not none %}
                Hs: {{ "%.1f"|format(wave_info['values']['SignificantWaveHeight']) if wave_info['values']['SignificantWaveHeight'] is not none else 'N/A' }} m<br>
                Dp: {{ "%.0f"|format(wave_info['values']['MeanDirection']) if wave_info['values']['MeanDirection'] is not none else 'N/A' }} °
              {% else %} N/A {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ wave_info.time_ago_str if wave_info else 'N/A' }}
        </div>
      </div>

      <!-- VR2C Summary Card -->
      <div class="summary-card" data-category="vr2c" data-mini-trend='{{ vr2c_info.mini_trend | tojson | safe if vr2c_info and "mini_trend" in vr2c_info and vr2c_info.mini_trend is not none else "[]" }}'>
        <div class="summary-card-main-content">
          <div class="mini-chart-container">
            <canvas id="miniVr2cChart"></canvas>
          </div>
          <div class="summary-card-text-content">
            <h5>VR2C-MRx</h5>
            <div class="mini-summary">
              {% if vr2c_info and vr2c_info['values'] is not none %}
                DC: {{ vr2c_info['values']['DetectionCount'] if vr2c_info['values']['DetectionCount'] is not none else 'N/A' }}<br>
                PC: {{ vr2c_info['values']['PingCount'] if vr2c_info['values']['PingCount'] is not none else 'N/A' }}
              {% else %} N/A {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ vr2c_info.time_ago_str if vr2c_info else 'N/A' }}
        </div>
      </div>

      <!-- Fluorometer Summary Card -->
      <div class="summary-card" data-category="fluorometer" data-mini-trend='{{ fluorometer_info.mini_trend | tojson | safe if fluorometer_info and "mini_trend" in fluorometer_info and fluorometer_info.mini_trend is not none else "[]" }}'>
        <div class="summary-card-main-content">
          <div class="mini-chart-container">
            <canvas id="miniFluorometerChart"></canvas>
          </div>
          <div class="summary-card-text-content">
            <h5>Fluorometer</h5>
            <div class="mini-summary">
              {% if fluorometer_info and fluorometer_info['values'] is not none %}
                C1: {{ "%.1f"|format(fluorometer_info['values']['C1_Avg']) if fluorometer_info['values']['C1_Avg'] is not none else 'N/A' }}<br>
                Temp: {{ "%.1f"|format(fluorometer_info['values']['Temperature_Fluor']) if fluorometer_info['values']['Temperature_Fluor'] is not none else 'N/A' }} °C
              {% else %} N/A {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ fluorometer_info.time_ago_str if fluorometer_info else 'N/A' }}
        </div>
      </div>

      <!-- AIS Summary Card -->
      <div class="summary-card" data-category="ais">
        <div class="summary-card-main-content">
          <div class="mini-chart-placeholder"></div> <!-- Placeholder for chart area -->
          <div class="summary-card-text-content">   <!-- Removed full-width -->
            <h5>AIS Contacts</h5>
            <div class="mini-summary">
              {% if ais_summary_data %}
                {{ ais_summary_data | length }} recent
              {% else %}
                No recent
              {% endif %}
              {% if has_ais_data %}
                <span class="text-danger ms-1">❗</span>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ ais_update_info.time_ago_str if ais_update_info else 'N/A' }}
        </div>
      </div>

      <!-- Errors Summary Card -->
      <div class="summary-card" data-category="errors">
        <div class="summary-card-main-content">
          <div class="mini-chart-placeholder"></div> <!-- Placeholder for chart area -->
          <div class="summary-card-text-content">   <!-- Removed full-width -->
            <h5>Errors</h5>
            <div class="mini-summary">
              {% if errors_summary_data %}
                {{ errors_summary_data | length }} recent
              {% else %}
                No recent
              {% endif %}
              {% if has_errors_data %}
                <span class="text-danger ms-1">❗</span>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ errors_update_info.time_ago_str if errors_update_info else 'N/A' }}
        </div>
      </div>

    </div> <!-- End Left Navigation Panel -->

    <!-- Right Main Display Area -->
    <div class="col-md-9" id="main-display-area">
      <div class="category-detail-view card mb-4" id="detail-ais" style="display: none;">
        <div class="card">
          <div class="card-header">
            <h2 class="mb-0">AIS Contacts</h2>
          </div>
          <div class="card-body">
            <ul class="list-unstyled scrollable-list-card">
              {% if ais_summary_data %} {# Updated variable name #}
                {% for v in ais_summary_data %} {# Updated variable name #}
                  <li>{{ v.ShipName or "Unknown Ship" }} (MMSI: {{ v.MMSI or "N/A" }}) — Last Seen: {{ v.LastSeenTimestamp.strftime('%Y-%m-%d %H:%M:%S UTC') if v.LastSeenTimestamp else "N/A" }}</li>
                {% endfor %}
              {% else %}
                <li>No recent AIS contacts.</li>
              {% endif %}
            </ul>
          </div>
          <div class="card-footer text-muted small">
            {% if ais_update_info and ais_update_info.latest_timestamp_str != "N/A" %}
              Last data: {{ ais_update_info.latest_timestamp_str }} ({{ ais_update_info.time_ago_str }})
            {% else %}
              Last data: N/A
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Errors Detail View (Initially Hidden) -->
      <div class="category-detail-view card mb-4" id="detail-errors" style="display: none;">
        <div class="card">
          <div class="card-header">
            <h2 class="mb-0">Errors</h2>
          </div>
          <div class="card-body">
            <ul class="list-unstyled scrollable-list-card">
              {% if errors_summary_data %} {# Updated variable name #}
                {% for err in errors_summary_data %} {# Updated variable name #}
                  <li>{{ err.Timestamp.strftime('%Y-%m-%d %H:%M:%S UTC') if err.Timestamp else "N/A" }} — {{ err.VehicleName or "N/A" }} — {{ err.ErrorMessage[:60] if err.ErrorMessage else "N/A" }}... (SelfCorrected: {{ err.SelfCorrected }})</li>
                {% endfor %}
              {% else %}
                <li>No recent errors.</li>
              {% endif %} {# Close the if/else for errors_summary_data #}
            </ul>
          </div>
          <div class="card-footer text-muted small">
            {% if errors_update_info and errors_update_info.latest_timestamp_str != "N/A" %}
              Last data: {{ errors_update_info.latest_timestamp_str }} ({{ errors_update_info.time_ago_str }})
            {% else %}
              Last data: N/A
            {% endif %}
          </div>
        </div>
      </div>
   <!-- Power Detail View (Initially Displayed or as per JS logic) -->
      <div class="category-detail-view card mb-4" id="detail-power" style="display: block;"> <!-- Default visible -->
      <div class="card h-100">
        <div class="card-header">
          <h2>Power</h2>
        </div>
        <div class="card-body">
          <div class="summary-content-area">
            {% if power_info and power_info['values'] is not none %}
            <div class="row mb-2"> <!-- First row of summary items -->
              <div class="col-md-3">
                <ul class="list-unstyled mb-0">
                  <li class="{% if power_info['values']['BatteryWattHours'] is not none and power_info['values']['BatteryWattHours'] < 200 %}text-danger fw-bold{% elif power_info['values']['BatteryWattHours'] is not none and power_info['values']['BatteryWattHours'] < 400 %}text-warning{% endif %}">
                    Batt (Wh): {{ "%.0f"|format(power_info['values']['BatteryWattHours']) if power_info['values']['BatteryWattHours'] is not none else '<span class="na-value">N/A</span>' | safe }}
                  </li>
                </ul>
              </div>
              <div class="col-md-3">
                <ul class="list-unstyled mb-0">
                  <li class="{% if power_info['values']['NetPowerWatts'] is not none and power_info['values']['NetPowerWatts'] < 0 %}text-warning{% elif power_info['values']['NetPowerWatts'] is not none and power_info['values']['NetPowerWatts'] > 5 %}text-success{% endif %}">
                    Net (W): {{ "%.1f"|format(power_info['values']['NetPowerWatts']) if power_info['values']['NetPowerWatts'] is not none else '<span class="na-value">N/A</span>' | safe }}
                    {% if power_info['values']['NetPowerWatts'] is not none and power_info['values']['NetPowerWatts'] < 0 %}
                      <span class="badge bg-warning text-dark ms-1 sm-badge">Discharging</span>
                    {% elif power_info['values']['NetPowerWatts'] is not none and power_info['values']['NetPowerWatts'] > 0 %}
                      <span class="badge bg-success ms-1 sm-badge">Charging</span>
                    {% endif %}
                  </li>
                </ul>
              </div>
              <div class="col-md-3">
                <ul class="list-unstyled mb-0">
                  <li>Draw (W): {{ "%.1f"|format(power_info['values']['PowerDrawWatts']) if power_info['values']['PowerDrawWatts'] is not none else '<span class="na-value">N/A</span>' | safe }}</li>
                </ul>
              </div>
              <div class="col-md-3">
                <ul class="list-unstyled mb-0"><li>&nbsp;</li></ul> <!-- Placeholder -->
              </div>
            </div>
            <div class="row"> <!-- Second row of summary items -->
              <div class="col-md-3">
                <ul class="list-unstyled mb-0">
                  <li>Solar (W): {{ "%.1f"|format(power_info['values']['SolarInputWatts']) if power_info['values']['SolarInputWatts'] is not none else '<span class="na-value">N/A</span>' | safe }}</li>
                </ul>
              </div>
              <div class="col-md-3">
                <ul class="list-unstyled mb-0">
                  <li>Panel 1 (W): {{ "%.1f"|format(power_info['values'].get('Panel1Power')) if power_info['values'].get('Panel1Power') is not none else '<span class="na-value">N/A</span>' | safe }}</li>
                </ul>
              </div>
              <div class="col-md-3">
                <ul class="list-unstyled mb-0">
                  <li>Panel 2 (W): {{ "%.1f"|format(power_info['values'].get('Panel2Power')) if power_info['values'].get('Panel2Power') is not none else '<span class="na-value">N/A</span>' | safe }}</li>
                </ul>
              </div>
              <div class="col-md-3">
                <ul class="list-unstyled mb-0">
                  <li>Panel 4 (W): {{ "%.1f"|format(power_info['values'].get('Panel4Power')) if power_info['values'].get('Panel4Power') is not none else '<span class="na-value">N/A</span>' | safe }}</li>
                </ul>
              </div>
            </div>
            {% elif power_info and power_info.latest_timestamp_str == "N/A" %} {# Check if info exists but no valid data #}
            <p>Data unavailable.</p>
            {% else %}
            <p>Loading data...</p> {# Or a more general loading state #}
            {% endif %}
          </div>
          <div class="mt-3 chart-container" style="position: relative; height: 300px; width: 100%">
            <h5>Power Trends (Last 72 hours, 1-hour avg)</h5>
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="powerChart"></canvas>
          </div>
          <!-- New Solar Panel Chart -->
          <hr class="my-4">
          <div class="mt-3 chart-container" style="position: relative; height: 300px; width: 100%">
            <h5>Individual Solar Panel Power (Last 72 hours, 1-hour avg)</h5>
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="solarPanelChart"></canvas>
          </div>
        </div>
         <div class="card-footer text-muted small">
          <!-- Ensure this footer content is not affecting the main body height for alignment -->
          {% if power_info and power_info.latest_timestamp_str != "N/A" %}
            Last data: {{ power_info.latest_timestamp_str }} ({{ power_info.time_ago_str }})
          {% else %}
            Last data: N/A
          {% endif %}
        </div>
      </div>
    </div>

      <!-- CTD Detail View (Initially Hidden) -->
      <div class="category-detail-view card mb-4" id="detail-ctd" style="display: none;">
      <div class="card h-100">
        <div class="card-header">
          <h2>CTD</h2>
        </div>
        <div class="card-body">
          <div class="summary-content-area">
            {% if ctd_info and ctd_info['values'] is not none %}
            <ul class="list-unstyled mb-3">
              <li class="{% if ctd_info['values']['WaterTemperature'] is not none and (ctd_info['values']['WaterTemperature'] < 5 or ctd_info['values']['WaterTemperature'] > 30) %}text-warning{% endif %}"> {# Added warning threshold #}
                Water Temperature (°C): {{ "%.2f"|format(ctd_info['values']['WaterTemperature']) if ctd_info['values']['WaterTemperature'] is not none else '<span class="na-value">N/A</span>' | safe }} {# Use safe filter for HTML #}
              </li>
              <li>
               Salinity (PSU): {{ "%.2f"|format(ctd_info['values']['Salinity']) if ctd_info['values']['Salinity'] is not none else '<span class="na-value">N/A</span>' | safe }} {# Use safe filter for HTML #}
              </li>
              <li>
                Conductivity (S/m): {{ "%.2f"|format(ctd_info['values']['Conductivity']) if ctd_info['values']['Conductivity'] is not none else '<span class="na-value">N/A</span>' | safe }} {# Use safe filter for HTML #}
              </li>
              <li>
                Dissolved Oxygen (Hz): {{ "%.2f"|format(ctd_info['values']['DissolvedOxygen']) if ctd_info['values']['DissolvedOxygen'] is not none else '<span class="na-value">N/A</span>' | safe }} {# Use safe filter for HTML #}
              </li>
               <li>
                Pressure (dbar): {{ "%.1f"|format(ctd_info['values']['Pressure']) if ctd_info['values']['Pressure'] is not none else '<span class="na-value">N/A</span>' | safe }} {# Use safe filter for HTML #}
              </li>
            </ul>
            {% elif ctd_info and ctd_info.latest_timestamp_str == "N/A" %} {# Check if info exists but no valid data #}
            <p>Data unavailable.</p>
            {% else %} 
            <p>Loading data...</p> {# Or a more general loading state #}
            {% endif %}
          </div>
          <div class="mt-3 chart-container" style="position: relative; height: 300px; width: 100%;">
            <h5>CTD Trends (Last 72 hours, 1-hour avg)</h5>
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="ctdChart"></canvas>
          </div>
        </div>
         <div class="card-footer text-muted small">
          {% if ctd_info and ctd_info.latest_timestamp_str != "N/A" %}
            Last data: {{ ctd_info.latest_timestamp_str }} ({{ ctd_info.time_ago_str }})
          {% else %}
            Last data: N/A
          {% endif %}
        </div>
      </div>
    </div>
  
      <!-- Weather Detail View (Initially Hidden) -->
      <div class="category-detail-view card mb-4" id="detail-weather" style="display: none;">
      <div class="card h-100">
        <div class="card-header">
          <h2>Weather Sensor</h2>
        </div>
        <div class="card-body">
          <div class="summary-content-area">
            {% if weather_info and weather_info['values'] is not none %} {# Check if info and values exist #}
            <ul class="list-unstyled mb-3">
              <li> {# No specific threshold for Air Temp #}
                Air Temperature (°C): {{ "%.1f"|format(weather_info['values']['AirTemperature']) if weather_info['values']['AirTemperature'] is not none else '<span class="na-value">N/A</span>' | safe }} {# Use safe filter for HTML #}
              </li>
               <li class="{% if weather_info['values']['WindSpeed'] is not none and weather_info['values']['WindSpeed'] > 20 %}text-warning{% elif weather_info['values']['WindSpeed'] is not none and weather_info['values']['WindSpeed'] > 30 %}text-danger fw-bold{% endif %}">
                Wind Speed (kt): {{ "%.1f"|format(weather_info['values']['WindSpeed']) if weather_info['values']['WindSpeed'] is not none else '<span class="na-value">N/A</span>' | safe }} {# Use safe filter for HTML #}
              </li>
               <li class="{% if weather_info['values']['WindGust'] is not none and weather_info['values']['WindGust'] > 25 %}text-warning{% elif weather_info['values']['WindGust'] is not none and weather_info['values']['WindGust'] > 35 %}text-danger fw-bold{% endif %}">
                Wind Gust (kt): {{ "%.1f"|format(weather_info['values']['WindGust']) if weather_info['values']['WindGust'] is not none else '<span class="na-value">N/A</span>' | safe }} {# Use safe filter for HTML #}
              </li>
              <li> {# No specific threshold for Wind Dir #}
                Wind Direction (°): {{ "%.0f"|format(weather_info['values']['WindDirection']) if weather_info['values']['WindDirection'] is not none else '<span class="na-value">N/A</span>' | safe }} {# Use safe filter for HTML #}
              </li>
            </ul>
            {% elif weather_info and weather_info.latest_timestamp_str == "N/A" %} {# Check if info exists but no valid data #}
            <p>Data unavailable.</p> {# Display this if weather_info exists but has no valid data #}
            {% else %}
            <p>Loading data...</p> {# Or a more general loading state #}
            {% endif %}
          </div>
          <div class="mt-3 chart-container" style="position: relative; height: 300px; width: 100%;">
            <h5>Weather Sensor Trends (Last 72 hours, 1-hour avg)</h5>
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="weatherSensorChart"></canvas>
          </div>
          <!-- Weather Forecast Embedded -->
          <hr class="my-4"> <!-- Add a visual separator -->
          <h4 class="mb-3">Weather Forecast</h4>
          <div id="forecastDisplay">
            <div id="forecastInitial" class="table-responsive" style="display: none;">
                <p class="text-muted">Loading initial forecast...</p>
            </div>
            <button class="btn btn-outline-secondary btn-sm mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#forecastExtended" aria-expanded="false" aria-controls="forecastExtended" id="toggleForecastBtn" style="display: none;">
              Show More
            </button>
            <div class="collapse mt-2" id="forecastExtended">
              <div id="forecastExtendedContent" class="table-responsive">
                <!-- Extended forecast will be rendered here by JS -->
              </div>
            </div>
          </div>
          <div class="text-muted small mt-2" id="forecastMetaInfo" style="display: none;">
            <!-- Forecast metadata will be injected here by JavaScript -->
          </div>
          <!-- End Weather Forecast Embedded -->

        </div>
        <div class="card-footer text-muted small">
          {% if weather_info and weather_info.latest_timestamp_str != "N/A" %}
            Last data: {{ weather_info.latest_timestamp_str }} ({{ weather_info.time_ago_str }})
          {% else %}
            Last data: N/A
          {% endif %}
        </div>
      </div>
    </div>
      <!-- Wave Detail View (Initially Hidden) -->
      <div class="category-detail-view card mb-4" id="detail-waves" style="display: none;">
      <div class="card h-100">
        <div class="card-header">
          <h2>Wave</h2>
        </div>
        <div class="card-body">
          <div class="summary-content-area">
            {% if wave_info and wave_info['values'] is not none %} {# Check if info and values exist #}
            <ul class="list-unstyled mb-3">
              <li class="{% if wave_info['values']['SignificantWaveHeight'] is not none and wave_info['values']['SignificantWaveHeight'] > 2 %}text-warning{% elif wave_info['values']['SignificantWaveHeight'] is not none and wave_info['values']['SignificantWaveHeight'] > 3.5 %}text-danger fw-bold{% endif %}">
                Significant Wave Height (m): {{ "%.2f"|format(wave_info['values']['SignificantWaveHeight']) if wave_info['values']['SignificantWaveHeight'] is not none else '<span class="na-value">N/A</span>' | safe }} {# Use safe filter for HTML #}
              </li>
              <li> {# No specific threshold for Wave Period #}
               Wave Period (s): {{ "%.1f"|format(wave_info['values']['WavePeriod']) if wave_info['values']['WavePeriod'] is not none else '<span class="na-value">N/A</span>' | safe }} {# Use safe filter for HTML #}
              </li>
              <li> {# No specific threshold for Mean Wave Direction #}
                Mean Wave Direction (°): {{ "%.0f"|format(wave_info['values']['MeanDirection']) if wave_info['values']['MeanDirection'] is not none else '<span class="na-value">N/A</span>' | safe }} {# Use safe filter for HTML #}
              </li>
            </ul>
            {% elif wave_info and wave_info.latest_timestamp_str == "N/A" %} {# Check if info exists but no valid data #}
            <p>Data unavailable.</p>
            {% else %}
            <p>Loading data...</p>
            {% endif %}
          </div>
          <div class="mt-3 chart-container" style="position: relative; height: 300px; width: 100%;">
            <h5>Wave Trends (Last 72 hours, 1-hour avg)</h5>
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="waveChart"></canvas>
          </div>
        </div>
        <div class="card-footer text-muted small">
          {% if wave_info and wave_info.latest_timestamp_str != "N/A" %}
            Last data: {{ wave_info.latest_timestamp_str }} ({{ wave_info.time_ago_str }})
          {% else %}
            Last data: N/A
          {% endif %}
        </div>
      </div>
    </div>

      <!-- VR2C Detail View (Initially Hidden) -->
      <div class="category-detail-view card mb-4" id="detail-vr2c" style="display: none;">
      <div class="card h-100">
        <div class="card-header">
          <h2>VR2C-MRx Acoustic Receiver</h2>
        </div>
        <div class="card-body">
          <div class="summary-content-area">
            {% if vr2c_info and vr2c_info['values'] is not none %}
            <ul class="list-unstyled mb-3">
              <li>
                Serial Number: {{ vr2c_info['values']['SerialNumber'] if vr2c_info['values']['SerialNumber'] is not none else '<span class="na-value">N/A</span>' | safe }}
              </li>
              <li>
                Detection Count (DC): {{ vr2c_info['values']['DetectionCount'] if vr2c_info['values']['DetectionCount'] is not none else '<span class="na-value">N/A</span>' | safe }}
              </li>
              <li>
                Ping Count (PC): {{ vr2c_info['values']['PingCount'] if vr2c_info['values']['PingCount'] is not none else '<span class="na-value">N/A</span>' | safe }}
              </li>
            </ul>
            {% elif vr2c_info and vr2c_info.latest_timestamp_str == "N/A" %}
            <p>Data unavailable.</p>
            {% else %}
            <p>Loading data...</p>
            {% endif %}
          </div>
          <div class="mt-3 chart-container" style="position: relative; height: 300px; width: 100%;">
            <h5>VR2C Trends (Last 72 hours, 1-hour avg)</h5>
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="vr2cChart"></canvas>
          </div>
        </div>
        <div class="card-footer text-muted small">
          {% if vr2c_info and vr2c_info.latest_timestamp_str != "N/A" %}
            Last data: {{ vr2c_info.latest_timestamp_str }} ({{ vr2c_info.time_ago_str }})
          {% else %}
            Last data: N/A
          {% endif %}
        </div>
      </div>
    </div>
    
      <!-- Fluorometer Detail View (Initially Hidden) -->
      <div class="category-detail-view card mb-4" id="detail-fluorometer" style="display: none;">
      <div class="card h-100">
        <div class="card-header">
          <h2>C3 Fluorometer</h2>
        </div>
        <div class="card-body">
          <div class="summary-content-area">
            {% if fluorometer_info and fluorometer_info['values'] is not none %}
            <ul class="list-unstyled mb-3">
              <li>
                C1 Avg: {{ "%.2f"|format(fluorometer_info['values']['C1_Avg']) if fluorometer_info['values']['C1_Avg'] is not none else '<span class="na-value">N/A</span>' | safe }}
              </li>
              <li>
                C2 Avg: {{ "%.2f"|format(fluorometer_info['values']['C2_Avg']) if fluorometer_info['values']['C2_Avg'] is not none else '<span class="na-value">N/A</span>' | safe }}
              </li>
              <li>
                C3 Avg: {{ "%.2f"|format(fluorometer_info['values']['C3_Avg']) if fluorometer_info['values']['C3_Avg'] is not none else '<span class="na-value">N/A</span>' | safe }}
              </li>
              <li>
                Temperature (°C): {{ "%.2f"|format(fluorometer_info['values']['Temperature_Fluor']) if fluorometer_info['values']['Temperature_Fluor'] is not none else '<span class="na-value">N/A</span>' | safe }}
              </li>
            </ul>
            {% elif fluorometer_info and fluorometer_info.latest_timestamp_str == "N/A" %}
            <p>Data unavailable.</p>
            {% else %}
            <p>Loading data...</p>
            {% endif %}
          </div>
          <div class="mt-3 chart-container" style="position: relative; height: 300px; width: 100%;">
            <h5>Fluorometer Trends (Last 72 hours, 1-hour avg)</h5>
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="fluorometerChart"></canvas>
          </div>
        </div>
        <div class="card-footer text-muted small">
          {% if fluorometer_info and fluorometer_info.latest_timestamp_str != "N/A" %}
            Last data: {{ fluorometer_info.latest_timestamp_str }} ({{ fluorometer_info.time_ago_str }})
          {% else %}
            Last data: N/A
          {% endif %}
        </div>
      </div>
    </div>
    </div> <!-- End Right Main Display Area -->
  </div> <!-- End New Two-Column Layout / End Right Main Display Area -->
    <!-- --- Footer --- -->
  <hr>
  <footer class="mt-4 mb-4">
    <small class="text-muted">
      Weather forecast data generated using ICON Wave forecast from the German Weather Service DWD.
      <a href="https://open-meteo.com/" target="_blank">Open-Meteo.com</a>.
      Development assisted by Google's Gemini models.
    </small>
  </footer>


  <!-- Link to external JavaScript File -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/js/dashboard.js"></script>

</body>
</html>
