{% extends "base.html" %}

{% block title %}Wave Glider Status - {{ mission }}{% endblock %}

{% block head_extra_css %}
  {# Chart.js and its adapter are now loaded globally in base.html #}
{% endblock %}

{% block body_class %}container-fluid{% endblock %} {# Removed py-4. Body padding is handled by base.html for fixed-top navbar. #}

{% block body_data_attributes %}
  data-mission-id="{{ mission }}"
  data-is-historical="{{ 'true' if is_historical_mission else 'false' }}"
  data-enabled-sensors="{{ enabled_sensor_cards | join(',') }}"
{% endblock %}

{% block content %}
  {# The main content of index.html starts here. The body padding for fixed-top navbar is handled by base.html #}
  <div class="modal fade" id="dataSourceModal" tabindex="-1" aria-labelledby="dataSourceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="dataSourceModalLabel">Select Data Source</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="alert alert-info small" role="alert">
            <strong>Currently Loading From:</strong><br>
            <span class="font-monospace">{{ display_source_path }}</span>
            {% if current_source_preference %}
              <br><strong>Requested Source Type:</strong> {{ "Local" if current_source_preference == 'local' else "Remote" }}
            {% endif %}
          </div>
          <hr>
          <div class="form-check mb-2"> {# Added margin-bottom #}
            <input class="form-check-input" type="radio" name="dataSourceOption" id="sourceRemote" value="remote" {% if not current_source_preference or current_source_preference == 'remote' %}checked{% endif %}>
            <label class="form-check-label" for="sourceRemote">
              Remote Data (Default: Remote first, then local fallback)
            </label>
          </div>
          <div class="form-check mb-2"> {# Added margin-bottom #}
            <input class="form-check-input" type="radio" name="dataSourceOption" id="sourceLocal" value="local" {% if current_source_preference == 'local' %}checked{% endif %}>
            <label class="form-check-label" for="sourceLocal">
              Local Data Only
            </label>
          </div>
          <div class="mt-3" id="localPathInputGroup" style="display: {% if current_source == 'local' %}block{% else %}none{% endif %};">
            <label for="customLocalPath" class="form-label">Custom Local Data Path (optional):</label>
            <input type="text" class="form-control" id="customLocalPath" placeholder="e.g., C:\my_glider_data" value="{{ current_local_path or '' }}">
            <small class="form-text text-muted">If blank, uses default local path from system config.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="applyDataSource">Apply</button>
        </div>
      </div>
    </div>
  </div>

  <!-- General Error Display Area -->
  <div id="generalErrorDisplay" class="alert alert-danger" style="display: none;" role="alert">
    An error occurred. Please check console for details or try again later.
  </div>

    <!-- New Two-Column Layout for Dashboard Content -->
  {% set nav_values = navigation_info['values'] if navigation_info and navigation_info['values'] else {} %}
  {% set power_values = power_info['values'] if power_info and power_info['values'] else {} %}
  {% set ctd_values = ctd_info['values'] if ctd_info and ctd_info['values'] else {} %}
  {% set weather_values = weather_info['values'] if weather_info and weather_info['values'] else {} %}
  {% set wave_values = wave_info['values'] if wave_info and wave_info['values'] else {} %}
  {% set vr2c_values = vr2c_info['values'] if vr2c_info and vr2c_info['values'] else {} %}
  {% set fluorometer_values = fluorometer_info['values'] if fluorometer_info and fluorometer_info['values'] else {} %}
  {% set wg_vm4_values = wg_vm4_info['values'] if wg_vm4_info and wg_vm4_info['values'] else {} %}
  <div class="row mt-3" id="dashboard-main-content"> {# Added mt-3 for spacing below new banner #}
    <!-- Left Navigation Panel (Summary Cards) -->
    <div class="col-md-3" id="left-nav-panel">
      <!-- Overview Summary Card -->
      <div class="summary-card active-card" data-category="overview">
        <div class="summary-card-main-content">
          <div class="summary-card-text-content">
            <h5>Overview</h5>
            <div class="mini-summary">
              Mission summary and media
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ mission }}
        </div>
      </div>

      <!-- Navigation Summary Card -->
      {% if "navigation" in enabled_sensor_cards %}
      <div class="summary-card" data-category="navigation" data-mini-trend='{{ navigation_info.mini_trend | tojson | safe if navigation_info and "mini_trend" in navigation_info and navigation_info.mini_trend is not none else "[]" }}'>
        <div class="summary-card-main-content">
          <div class="mini-chart-container">
            <canvas id="miniNavigationChart"></canvas>
          </div>
          <div class="summary-card-text-content">
            <h5>Navigation</h5>
            <div class="mini-summary">
              {% if navigation_info and nav_values %}
                SOG: {{ "%.1f kn"|format(nav_values.get('SpeedOverGround')) if nav_values.get('SpeedOverGround') is not none else 'N/A' }}<br>
                POG: {{ "%.0f °"|format(nav_values.get('GliderHeading')) if nav_values.get('GliderHeading') is not none else 'N/A' }}
              {% else %} N/A {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ navigation_info.time_ago_str if navigation_info else 'N/A' }}
        </div>
      </div>
      {% endif %}

      <!-- Power Summary Card -->
      {% if "power" in enabled_sensor_cards %}
      <div class="summary-card" data-category="power" data-mini-trend='{{ power_info.mini_trend | tojson | safe if power_info and "mini_trend" in power_info and power_info.mini_trend is not none else "[]" }}'>
        <div class="summary-card-main-content">
          <div class="mini-chart-container">
            <canvas id="miniPowerChart"></canvas>
          </div>
          <div class="summary-card-text-content">
            <h5>Power</h5>
            <div class="mini-summary">
              {% if power_info and power_values %}
                Batt: {{ "%.0f"|format(power_values.get('BatteryPercentage')) if power_values.get('BatteryPercentage') is not none else 'N/A' }}%<br>
                Net: {{ "%.1f"|format(power_values.get('BatteryChargeRateW')) if power_values.get('BatteryChargeRateW') is not none else 'N/A' }} W
              {% else %} N/A {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ power_info.time_ago_str if power_info else 'N/A' }}
        </div>
      </div>
      {% endif %}

      <!-- CTD Summary Card -->
      {% if "ctd" in enabled_sensor_cards %}
      <div class="summary-card" data-category="ctd" data-mini-trend='{{ ctd_info.mini_trend | tojson | safe if ctd_info and "mini_trend" in ctd_info and ctd_info.mini_trend is not none else "[]" }}'>
        <div class="summary-card-main-content">
          <div class="mini-chart-container">
            <canvas id="miniCtdChart"></canvas>
          </div>
          <div class="summary-card-text-content">
            <h5>CTD</h5>
            <div class="mini-summary">
              {% if ctd_info and ctd_values %}
                Temp: {{ "%.1f"|format(ctd_values.get('WaterTemperature')) if ctd_values.get('WaterTemperature') is not none else 'N/A' }} °C<br>
                Sal: {{ "%.1f"|format(ctd_values.get('Salinity')) if ctd_values.get('Salinity') is not none else 'N/A' }} PSU
              {% else %} N/A {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ ctd_info.time_ago_str if ctd_info else 'N/A' }}
        </div>
      </div>
      {% endif %}

      <!-- Weather Summary Card -->
      {% if "weather" in enabled_sensor_cards %}
      <div class="summary-card" data-category="weather" data-mini-trend='{{ weather_info.mini_trend | tojson | safe if weather_info and "mini_trend" in weather_info and weather_info.mini_trend is not none else "[]" }}'>
        <div class="summary-card-main-content">
          <div class="mini-chart-container">
            <canvas id="miniWeatherChart"></canvas>
          </div>
          <div class="summary-card-text-content">
            <h5>Weather</h5>
            <div class="mini-summary">
              {% if weather_info and weather_values %}
                Air: {{ "%.1f"|format(weather_values.get('AirTemperature')) if weather_values.get('AirTemperature') is not none else 'N/A' }} °C<br>
                Wind: {{ "%.1f"|format(weather_values.get('WindSpeed')) if weather_values.get('WindSpeed') is not none else 'N/A' }} kt
              {% else %} N/A {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ weather_info.time_ago_str if weather_info else 'N/A' }}
        </div>
      </div>
      {% endif %}

      <!-- Waves Summary Card -->
      {% if "waves" in enabled_sensor_cards %}
      <div class="summary-card" data-category="waves" data-mini-trend='{{ wave_info.mini_trend | tojson | safe if wave_info and "mini_trend" in wave_info and wave_info.mini_trend is not none else "[]" }}'>
        <div class="summary-card-main-content">
          <div class="mini-chart-container">
            <canvas id="miniWaveChart"></canvas>
          </div>
          <div class="summary-card-text-content">
            <h5>Waves</h5>
            <div class="mini-summary">
              {% if wave_info and wave_values %}
                Hs: {{ "%.1f"|format(wave_values.get('SignificantWaveHeight')) if wave_values.get('SignificantWaveHeight') is not none else 'N/A' }} m<br>
                Dp: <span {% if wave_values.get('MeanDirectionStatus') == 'outlier' %}
                          title="Latest data point was an invalid outlier (e.g., 9999)."
                          class="text-warning"
                         {% endif %}>{{ wave_values.get('MeanDirectionDisplay', 'N/A') }}</span>
              {% else %} N/A {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ wave_info.time_ago_str if wave_info else 'N/A' }}
        </div>
      </div>
      {% endif %}

      <!-- VR2C Summary Card -->
      {% if "vr2c" in enabled_sensor_cards %}
      <div class="summary-card" data-category="vr2c" data-mini-trend='{{ vr2c_info.mini_trend | tojson | safe if vr2c_info and "mini_trend" in vr2c_info and vr2c_info.mini_trend is not none else "[]" }}'>
        <div class="summary-card-main-content">
          <div class="mini-chart-container">
            <canvas id="miniVr2cChart"></canvas>
          </div>
          <div class="summary-card-text-content">
            <h5>VR2C-MRx</h5>
            <div class="mini-summary">
              {% if vr2c_info and vr2c_values %}
                DC: {{ vr2c_values.get('DetectionCount') if vr2c_values.get('DetectionCount') is not none else 'N/A' }}<br>
                PC: {{ vr2c_values.get('PingCount') if vr2c_values.get('PingCount') is not none else 'N/A' }}
              {% else %} N/A {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ vr2c_info.time_ago_str if vr2c_info else 'N/A' }}
        </div>
      </div>
      {% endif %}

      <!-- Fluorometer Summary Card -->
      {% if "fluorometer" in enabled_sensor_cards %}
      <div class="summary-card" data-category="fluorometer" data-mini-trend='{{ fluorometer_info.mini_trend | tojson | safe if fluorometer_info and "mini_trend" in fluorometer_info and fluorometer_info.mini_trend is not none else "[]" }}'>
        <div class="summary-card-main-content">
          <div class="mini-chart-container">
            <canvas id="miniFluorometerChart"></canvas>
          </div>
          <div class="summary-card-text-content">
            <h5>Fluorometer</h5>
            <div class="mini-summary">
              {% if fluorometer_info and fluorometer_values %}
                C1: {{ "%.1f"|format(fluorometer_values.get('C1_Avg')) if fluorometer_values.get('C1_Avg') is not none else 'N/A' }}<br>
                Temp: {{ "%.1f"|format(fluorometer_values.get('Temperature_Fluor')) if fluorometer_values.get('Temperature_Fluor') is not none else 'N/A' }} °C
              {% else %} N/A {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ fluorometer_info.time_ago_str if fluorometer_info else 'N/A' }}
        </div>
      </div>
      {% endif %}

      <!-- WG-VM4 Summary Card -->
      {% if "wg_vm4" in enabled_sensor_cards %}
      <div class="summary-card" data-category="wg_vm4" data-mini-trend='{{ wg_vm4_info.mini_trend | tojson | safe if wg_vm4_info and "mini_trend" in wg_vm4_info and wg_vm4_info.mini_trend is not none else "[]" }}'>
        <div class="summary-card-main-content">
          <div class="mini-chart-container">
            <canvas id="miniWgVm4Chart"></canvas>
          </div>
          <div class="summary-card-text-content">
            <h5>WG-VM4</h5>
            <div class="mini-summary">
              {% if wg_vm4_info and wg_vm4_values %}
                SN: {{ wg_vm4_values.get('SerialNumber') if wg_vm4_values.get('SerialNumber') is not none else 'N/A' }}<br>
                Ch0 DC: {{ wg_vm4_values.get('Channel0DetectionCount') if wg_vm4_values.get('Channel0DetectionCount') is not none else 'N/A' }}
              {% else %} N/A {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ wg_vm4_info.time_ago_str if wg_vm4_info else 'N/A' }}
        </div>
      </div>
      {% endif %}

      <!-- AIS Summary Card -->
      {% if "ais" in enabled_sensor_cards %}
      <div class="summary-card" data-category="ais">
        <div class="summary-card-main-content">
          <div class="mini-chart-placeholder"> <!-- Error list will go here -->
            {% if not ais_summary_data %}
              <span class="no-errors-message">No recent contacts.</span>
            {% else %}
              <ul class="error-message-list">
                {% for v in ais_summary_data[:2] %} {# Display up to the two most recent contacts #}
                  <li>
                    <small class="text-muted">{{ v.LastSeenTimestamp.strftime('%m-%d %H:%M') if v.LastSeenTimestamp else "N/A" }}:</small>
                    <span class="badge bg-{{ v.CategoryColor }} me-1" style="font-size: 0.7em;">{{ v.Group }}</span>
                    <span class="badge bg-{{ v.AISClassColor }} me-1" style="font-size: 0.7em;">{{ v.AISClassDisplay }}</span>
                    {% if v.IsHazardous %}
                      <span class="badge bg-danger me-1" style="font-size: 0.7em;">⚠️</span>
                    {% endif %}
                    {{ v.ShipName[:20] if v.ShipName else "Unknown" }}{% if v.ShipName and v.ShipName|length > 20 %}...{% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
          </div>
          <div class="summary-card-text-content">   <!-- Removed full-width -->
            <h5>AIS Contacts</h5>
            <div class="mini-summary">
              {% if ais_summary_data %}
                {{ ais_summary_data | length }} recent
              {% else %}
                0 recent
              {% endif %}
              {% if has_ais_data %}
                <span class="text-danger ms-1">❗</span>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ ais_update_info.time_ago_str if ais_update_info else 'N/A' }}
        </div>
      </div>
      {% endif %}

      <!-- Errors Summary Card -->
      {% if "errors" in enabled_sensor_cards %}
      <div class="summary-card" data-category="errors">
        <div class="summary-card-main-content">
          <div class="mini-chart-placeholder"> <!-- Error list will go here -->
            {% if not recent_errors_list %}
              <span class="no-errors-message">No recent errors.</span>
            {% else %}
              <ul class="error-message-list">
                {% for err in recent_errors_list[:2] %} {# Display up to the two most recent errors #}
                  <li>
                    <small class="text-muted">{{ err.Timestamp.strftime('%m-%d %H:%M') if err.Timestamp else "N/A" }}:</small>
                    <span class="error-category-badge badge bg-{{ 'primary' if err.category == 'navigation' else 'warning' if err.category == 'communication' else 'danger' if err.category == 'system_operations' else 'info' if err.category == 'environmental' else 'secondary' }} me-1">{{ err.category.title() if err.category else 'Unknown' }}</span>
                    {{ err.ErrorMessage[:20] if err.ErrorMessage else "N/A" }}{% if err.ErrorMessage and err.ErrorMessage|length > 20 %}...{% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
          </div>
          <div class="summary-card-text-content">   <!-- Removed full-width -->
            <h5>Errors</h5>
            <div class="mini-summary">
              {% if recent_errors_list %}
                {{ recent_errors_list | length }} recent
              {% else %}
                0 recent
              {% endif %}
              {% if has_errors_data %}
                <span class="text-danger ms-1">❗</span>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ errors_update_info.time_ago_str if errors_update_info else 'N/A' }}
        </div>
      </div>
      {% endif %}

    </div> <!-- End Left Navigation Panel -->

    <!-- Right Main Display Area -->
    <div class="col-md-9" id="main-display-area">
      <div class="category-detail-view card mb-4" id="detail-overview" style="display: block;">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <h2 class="mb-0">Mission Overview</h2>
            {% if is_historical_mission %}
              <span class="badge bg-secondary">Historical Mission</span>
            {% else %}
              <span class="badge bg-success">Active Mission</span>
            {% endif %}
          </div>
          {% if current_user %}
          <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#missionMediaUploadCollapse" aria-expanded="false" aria-controls="missionMediaUploadCollapse">
            <i class="fas fa-camera"></i> Add Media
          </button>
          {% endif %}
        </div>
        <div class="card-body">
          <div class="mb-3">
            <h5>Formal Plan Document</h5>
            <div id="overviewPlanContainer" style="display: none;">
              <a href="#" id="overviewPlanLink" target="_blank" rel="noopener noreferrer"></a>
            </div>
            <div id="overviewPlanEmpty" class="text-muted small">No formal plan document uploaded.</div>
          </div>

          <div class="mb-3">
            <h5>Mission Reports</h5>
            <div id="overviewWeeklyReportContainer" style="display: none;">
              <strong>Weekly Report:</strong>
              <a href="#" id="overviewWeeklyReportLink" target="_blank" rel="noopener noreferrer"></a>
            </div>
            <div id="overviewEndReportContainer" style="display: none;">
              <strong>End of Mission Report:</strong>
              <a href="#" id="overviewEndReportLink" target="_blank" rel="noopener noreferrer"></a>
            </div>
            <div id="overviewNoReports" class="text-muted small">No reports available yet.</div>
          </div>

          <div class="mb-3">
            <h5>Sensor Tracker Metadata</h5>
            <div id="overviewSensorTrackerContainer" style="display: none;">
              <dl class="row mb-0">
                <dt class="col-sm-4">Title:</dt>
                <dd class="col-sm-8" id="overviewStTitle">-</dd>
                <dt class="col-sm-4">Start:</dt>
                <dd class="col-sm-8" id="overviewStStart">-</dd>
                <dt class="col-sm-4">End:</dt>
                <dd class="col-sm-8" id="overviewStEnd">-</dd>
                <dt class="col-sm-4">Platform:</dt>
                <dd class="col-sm-8" id="overviewStPlatform">-</dd>
                <dt class="col-sm-4">Data Repository:</dt>
                <dd class="col-sm-8" id="overviewStDataRepo">-</dd>
              </dl>
              <div class="mt-2">
                <strong>Deployment Description:</strong>
                <p class="text-muted small mb-0" id="overviewStDescription" style="white-space: pre-wrap;">-</p>
              </div>
              <div class="mt-3" id="overviewStInstruments" style="display: none;">
                <h6 class="mb-2">Instruments</h6>
                <ul class="list-unstyled small mb-0" id="overviewStInstrumentsList"></ul>
              </div>
            </div>
            <div id="overviewSensorTrackerEmpty" class="text-muted small">No Sensor Tracker metadata available.</div>
          </div>

          <div class="row mt-4">
            <div class="col-lg-7">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">Mission Comments</h4>
              </div>
              <div class="mission-notes-container">
                <ul class="list-group mission-notes-list" id="dashboardMissionNotesList">
                  <li class="list-group-item text-muted no-mission-notes-placeholder">No mission comments have been added.</li>
                </ul>
                {% if current_user %}
                <div class="card mt-3">
                  <div class="card-body p-2">
                    <textarea class="form-control new-mission-note-content" rows="2" placeholder="Add a new mission comment..."></textarea>
                    <button class="btn btn-sm btn-primary mt-2 add-mission-note-btn">Add Comment</button>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
            <div class="col-lg-5">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">Mission Goals</h4>
                {% if current_user and current_user.role == 'admin' %}
                <button class="btn btn-sm btn-primary add-goal-btn" title="Add New Goal"><i class="fas fa-plus"></i> Add Goal</button>
                {% endif %}
              </div>
              <ul class="list-group mission-goals-list" id="dashboardMissionGoalsList">
                <li class="list-group-item text-muted no-mission-goals-placeholder">No mission goals have been defined.</li>
              </ul>
            </div>
          </div>

          {% if current_user %}
          <div class="collapse mb-3" id="missionMediaUploadCollapse">
            <form id="missionMediaUploadForm">
              <div class="row g-2 align-items-end">
                <div class="col-md-5">
                  <label for="missionMediaFile" class="form-label small">Select File</label>
                  <input type="file" class="form-control form-control-sm" id="missionMediaFile" accept="image/*,video/*" required>
                </div>
                <div class="col-md-3">
                  <label for="missionMediaOperation" class="form-label small">Operation Type</label>
                  <select class="form-select form-select-sm" id="missionMediaOperation">
                    <option value="">Not specified</option>
                    <option value="deployment">Deployment</option>
                    <option value="recovery">Recovery</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label for="missionMediaCaption" class="form-label small">Caption</label>
                  <input type="text" class="form-control form-control-sm" id="missionMediaCaption" placeholder="Optional caption">
                </div>
              </div>
              <div class="mt-2 d-flex align-items-center gap-2">
                <button type="submit" class="btn btn-sm btn-primary" id="missionMediaUploadBtn">
                  <i class="fas fa-upload"></i> Upload
                </button>
                <span id="missionMediaUploadSpinner" class="text-muted small" style="display: none;">
                  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                  Uploading...
                </span>
              </div>
            </form>
          </div>
          {% endif %}
          <div id="missionMediaGallery" class="row g-3">
            <div class="text-muted small">Loading media...</div>
          </div>
        </div>
      </div>

      <div class="category-detail-view card mb-4" id="detail-ais" style="display: none;">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="mb-0">{{ mission }} - AIS Contacts</h2>
            <div class="d-flex align-items-center">
              <!-- Download Dropdown -->
              <div class="dropdown">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-download me-1"></i> Download CSV
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item" href="/api/ais/csv/recent?mission={{ mission }}&hours=24" target="_blank">Recent Contacts (24h)</a></li>
                  <li><a class="dropdown-item" href="/api/ais/csv/all?mission={{ mission }}" target="_blank">All Mission Contacts</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="card-body">
            <!-- AIS Summary Statistics -->
            {% if ais_summary_stats %}
            <div class="row mb-4">
              <div class="col-md-6">
                <h5>Vessel Summary <small class="text-muted">(Last 24 Hours)</small></h5>
                <div class="row">
                  <div class="col-6 mb-2">
                    <div class="card border-primary">
                      <div class="card-body p-2">
                        <h6 class="card-title mb-1">Total Vessels</h6>
                        <p class="card-text mb-1">
                          <strong>{{ ais_summary_stats.total_vessels }}</strong> contacts
                        </p>
                      </div>
                    </div>
                  </div>
                  <div class="col-6 mb-2">
                    <div class="card border-info">
                      <div class="card-body p-2">
                        <h6 class="card-title mb-1">AIS Classes</h6>
                        <p class="card-text mb-1">
                          <strong>{{ ais_summary_stats.class_a_count }}</strong> Class A<br>
                          <strong>{{ ais_summary_stats.class_b_count }}</strong> Class B
                        </p>
                      </div>
                    </div>
                  </div>
                  {% if ais_summary_stats.hazardous_count > 0 %}
                  <div class="col-6 mb-2">
                    <div class="card border-danger">
                      <div class="card-body p-2">
                        <h6 class="card-title mb-1">Hazardous</h6>
                        <p class="card-text mb-1">
                          <strong>{{ ais_summary_stats.hazardous_count }}</strong> vessels
                        </p>
                      </div>
                    </div>
                  </div>
                  {% endif %}
                </div>
              </div>
              <div class="col-md-6">
                <h5>Vessel Types <small class="text-muted">(Last 24 Hours)</small></h5>
                {% if ais_summary_stats.group_breakdown %}
                <div class="d-flex flex-wrap gap-1">
                  {% for group, count in ais_summary_stats.group_breakdown.items() %}
                    <span class="badge bg-{{ 'primary' if group == 'Commercial' else 'success' if group == 'Fishing' else 'info' if group == 'Special' else 'secondary' if group == 'Recreational' else 'warning' if group == 'Military' else 'danger' if group == 'High Speed' else 'dark' if group == 'WIG' else 'light' if group == 'Operations' else 'outline-secondary' if group == 'Local' else 'secondary' }}">{{ group }}: {{ count }}</span>
                  {% endfor %}
                </div>
                {% else %}
                <div class="text-muted text-center" style="padding: 20px;">
                  <i class="fas fa-ship fa-2x mb-2"></i>
                  <p>No vessel type data available</p>
                </div>
                {% endif %}
              </div>
            </div>
            {% endif %}
            
            <!-- AIS Contacts List -->
            <h5>Recent AIS Targets <small class="text-muted">(24hr)</small></h5>
            <div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Vessel</th>
                    <th>MMSI</th>
                    <th>Type</th>
                    <th>AIS Class</th>
                    <th>Speed</th>
                    <th>Course</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% if ais_summary_data %}
                    {% for v in ais_summary_data %}
                    <tr>
                      <td>{{ v.LastSeenTimestamp.strftime('%m-%d %H:%M') if v.LastSeenTimestamp else "N/A" }}</td>
                      <td>
                        <strong>{{ v.ShipName or "Unknown" }}</strong>
                        {% if v.IsHazardous %}
                          <span class="badge bg-danger ms-1" style="font-size: 0.6em;">⚠️</span>
                        {% endif %}
                      </td>
                      <td>{{ v.MMSI or "N/A" }}</td>
                      <td>
                        <span class="badge bg-{{ v.CategoryColor }}">{{ v.Group }}</span>
                      </td>
                      <td>
                        <span class="badge bg-{{ v.AISClassColor }}">{{ v.AISClassDisplay }}</span>
                      </td>
                      <td>
                        {% if v.get('SpeedOverGround') is not none %}
                          {{ "%.1f kn"|format(v.get('SpeedOverGround')) }}
                        {% else %}
                          N/A
                        {% endif %}
                      </td>
                      <td>
                        {% if v.get('CourseOverGround') is not none %}
                          {{ "%.0f°"|format(v.get('CourseOverGround')) }}
                        {% else %}
                          N/A
                        {% endif %}
                      </td>
                      <td>
                        {% if v.get('NavigationStatus') is not none %}
                          <span class="badge bg-secondary">{{ v.get('NavigationStatus') }}</span>
                        {% else %}
                          N/A
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="8" class="text-center text-muted">No recent AIS contacts.</td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
            
            <!-- All AIS Targets Collapsible Section -->
            <div class="mt-4">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>All AIS Targets</h5>
                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#allAisCollapse" aria-expanded="false" aria-controls="allAisCollapse">
                  <i class="fas fa-chevron-down" id="allAisChevron"></i> Toggle All AIS Targets
                </button>
              </div>
              <div class="collapse" id="allAisCollapse">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                  <table class="table table-sm table-hover">
                    <thead class="sticky-top bg-light">
                      <tr>
                        <th>Time</th>
                        <th>Vessel</th>
                        <th>MMSI</th>
                        <th>Type</th>
                        <th>AIS Class</th>
                        <th>Speed</th>
                        <th>Course</th>
                        <th>Status</th>
                        <th>Hazardous</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% if all_ais_list %}
                        {% for v in all_ais_list %}
                        <tr>
                          <td>{{ v.LastSeenTimestamp.strftime('%m-%d %H:%M') if v.LastSeenTimestamp else "N/A" }}</td>
                          <td>
                            <strong>{{ v.ShipName or "Unknown" }}</strong>
                            {% if v.IsHazardous %}
                              <span class="badge bg-danger ms-1" style="font-size: 0.6em;">⚠️</span>
                            {% endif %}
                          </td>
                          <td>{{ v.MMSI or "N/A" }}</td>
                          <td>
                            <span class="badge bg-{{ v.CategoryColor }}">{{ v.Group }}</span>
                          </td>
                          <td>
                            <span class="badge bg-{{ v.AISClassColor }}">{{ v.AISClassDisplay }}</span>
                          </td>
                          <td>
                            {% if v.get('SpeedOverGround') is not none %}
                              {{ "%.1f kn"|format(v.get('SpeedOverGround')) }}
                            {% else %}
                              N/A
                            {% endif %}
                          </td>
                          <td>
                            {% if v.get('CourseOverGround') is not none %}
                              {{ "%.0f°"|format(v.get('CourseOverGround')) }}
                            {% else %}
                              N/A
                            {% endif %}
                          </td>
                          <td>
                            {% if v.get('NavigationStatus') is not none %}
                              <span class="badge bg-secondary">{{ v.get('NavigationStatus') }}</span>
                            {% else %}
                              N/A
                            {% endif %}
                          </td>
                          <td>
                            {% if v.IsHazardous %}
                              <span class="badge bg-danger">⚠️ Yes</span>
                            {% else %}
                              <span class="text-muted">No</span>
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                      {% else %}
                        <tr>
                          <td colspan="9" class="text-center text-muted">No AIS data available.</td>
                        </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div class="card-footer text-muted small">
            {% if ais_update_info and ais_update_info.latest_timestamp_str != "N/A" %}
              Last data: {{ ais_update_info.latest_timestamp_str }} ({{ ais_update_info.time_ago_str }})
            {% else %}
              Last data: N/A
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Errors Detail View (Initially Hidden) -->
      <div class="category-detail-view card mb-4" id="detail-errors" style="display: none;">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="mb-0">{{ mission }} - Error Analysis</h2>
            <div class="d-flex align-items-center">
              <!-- Download Dropdown -->
              <div class="dropdown">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-download me-1"></i> Download CSV
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item" href="/api/errors/csv/recent?mission={{ mission }}&hours=24" target="_blank">Recent Errors (24h)</a></li>
                  <li><a class="dropdown-item" href="/api/errors/csv/all?mission={{ mission }}" target="_blank">All Mission Errors</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="card-body">
            <!-- Error Analysis Summary -->
            <div class="row mb-4">
              <div class="col-md-6">
                <h5>Error Categories <small class="text-muted">(All Mission)</small></h5>
                {% if error_analysis and error_analysis.categories %}
                <div class="row">
                  {% for category, data in error_analysis.categories.items() %}
                  <div class="col-6 mb-2">
                    <div class="card border-{{ 'primary' if category == 'navigation' else 'warning' if category == 'communication' else 'danger' if category == 'system_operations' else 'info' if category == 'environmental' else 'secondary' }}">
                      <div class="card-body p-2">
                        <h6 class="card-title mb-1">{{ category.title() }}</h6>
                        <p class="card-text mb-1">
                          <strong>{{ data.count }}</strong> errors
                          <br><small class="text-muted">Confidence: {{ (data.confidence_avg * 100) | round(1) }}%</small>
                        </p>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
                {% else %}
                <div class="text-muted text-center" style="padding: 50px;">
                  <i class="fas fa-chart-bar fa-3x mb-3"></i>
                  <p>No error data available for analysis</p>
                </div>
                {% endif %}
              </div>
              <div class="col-md-6">
                <h5>Error Distribution <small class="text-muted">(All Mission)</small></h5>
                <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                  <canvas id="errorCategoryChart"></canvas>
                </div>
                <div id="noErrorDataMessage" class="text-muted text-center" style="display: none; padding: 50px;">
                  <i class="fas fa-chart-pie fa-3x mb-3"></i>
                  <p>No error data available for chart</p>
                </div>
              </div>
            </div>
            
            <!-- Error List with Classification -->
            <h5>Recent Errors <small class="text-muted">(Last 24 Hours)</small></h5>
            <div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Vehicle</th>
                    <th>Category</th>
                    <th>Message</th>
                    <th>Self-Corrected</th>
                    <th>Confidence</th>
                  </tr>
                </thead>
                <tbody>
              {% if recent_errors_list %}
                {% for err in recent_errors_list %}
                    <tr>
                      <td>{{ err.Timestamp.strftime('%m-%d %H:%M') if err.Timestamp else "N/A" }}</td>
                      <td>{{ err.VehicleName or "N/A" }}</td>
                      <td>
                        <span class="badge bg-{{ 'primary' if err.category == 'navigation' else 'warning' if err.category == 'communication' else 'danger' if err.category == 'system_operations' else 'info' if err.category == 'environmental' else 'secondary' }}">
                          {{ err.category.title() if err.category else 'Unknown' }}
                        </span>
                      </td>
                      <td>
                        <span title="{{ err.ErrorMessage if err.ErrorMessage else 'N/A' }}">
                          {{ err.ErrorMessage[:50] if err.ErrorMessage else "N/A" }}{% if err.ErrorMessage and err.ErrorMessage|length > 50 %}...{% endif %}
                        </span>
                      </td>
                      <td>
                        {% if err.SelfCorrected %}
                          <span class="text-success">✓ Yes</span>
                        {% else %}
                          <span class="text-danger">✗ No</span>
                        {% endif %}
                      </td>
                      <td>
                        <span class="badge bg-{{ 'success' if err.confidence > 0.8 else 'warning' if err.confidence > 0.5 else 'danger' }}">
                          {{ (err.confidence * 100) | round(1) }}%
                        </span>
                      </td>
                    </tr>
                {% endfor %}
              {% else %}
                    <tr>
                      <td colspan="6" class="text-center text-muted">No recent errors.</td>
                    </tr>
              {% endif %}
                </tbody>
              </table>
            </div>
            
            <!-- All Errors Collapsible Section -->
            <div class="mt-4">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>All Mission Errors</h5>
                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#allErrorsCollapse" aria-expanded="false" aria-controls="allErrorsCollapse">
                  <i class="fas fa-chevron-down" id="allErrorsChevron"></i> Toggle All Errors
                </button>
              </div>
              <div class="collapse" id="allErrorsCollapse">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                  <table class="table table-sm table-hover">
                    <thead class="sticky-top bg-light">
                      <tr>
                        <th>Time</th>
                        <th>Vehicle</th>
                        <th>Category</th>
                        <th>Message</th>
                        <th>Self-Corrected</th>
                        <th>Confidence</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% if all_errors_list %}
                        {% for err in all_errors_list %}
                        <tr>
                          <td>{{ err.Timestamp.strftime('%m-%d %H:%M') if err.Timestamp else "N/A" }}</td>
                          <td>{{ err.VehicleName or "N/A" }}</td>
                          <td>
                            <span class="badge bg-{{ 'primary' if err.category == 'navigation' else 'warning' if err.category == 'communication' else 'danger' if err.category == 'system_operations' else 'info' if err.category == 'environmental' else 'secondary' }}">
                              {{ err.category.title() if err.category else 'Unknown' }}
                            </span>
                          </td>
                          <td>
                            <span title="{{ err.ErrorMessage if err.ErrorMessage else 'N/A' }}">
                              {{ err.ErrorMessage[:50] if err.ErrorMessage else "N/A" }}{% if err.ErrorMessage and err.ErrorMessage|length > 50 %}...{% endif %}
                            </span>
                          </td>
                          <td>
                            {% if err.SelfCorrected %}
                              <span class="text-success">✓ Yes</span>
                            {% else %}
                              <span class="text-danger">✗ No</span>
                            {% endif %}
                          </td>
                          <td>
                            <span class="badge bg-{{ 'success' if err.confidence > 0.8 else 'warning' if err.confidence > 0.5 else 'danger' }}">
                              {{ (err.confidence * 100) | round(1) }}%
                            </span>
                          </td>
                        </tr>
                        {% endfor %}
                      {% else %}
                        <tr>
                          <td colspan="6" class="text-center text-muted">No error data available.</td>
                        </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
                {% if all_errors_list %}
                <div class="mt-2 text-muted small">
                  <i class="fas fa-info-circle"></i> Showing {{ all_errors_list | length }} total errors from mission
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="card-footer text-muted small">
            {% if errors_update_info and errors_update_info.latest_timestamp_str != "N/A" %}
              Last data: {{ errors_update_info.latest_timestamp_str }} ({{ errors_update_info.time_ago_str }})
            {% else %}
              Last data: N/A
            {% endif %}
          </div>
        </div>
      </div>
      <!-- Navigation Detail View -->
      <div class="category-detail-view card mb-4" id="detail-navigation" style="display: none;">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="mb-0">{{ mission }} - Navigation</h2>
            <div class="d-flex align-items-center">
              <!-- Date range controls -->
              <div class="input-group input-group-sm me-2" style="width: 200px;">
                <label class="input-group-text" for="start-date-telemetry" title="Start date and time for data visualization.">From</label>
                <input type="datetime-local" class="form-control date-range-input" id="start-date-telemetry" data-report-type="telemetry">
              </div>
              <div class="input-group input-group-sm me-2" style="width: 200px;">
                <label class="input-group-text" for="end-date-telemetry" title="End date and time for data visualization.">To</label>
                <input type="datetime-local" class="form-control date-range-input" id="end-date-telemetry" data-report-type="telemetry">
              </div>
              <button class="btn btn-outline-secondary btn-sm me-2" id="clear-date-telemetry" title="Clear date range and return to hours mode" style="display: none;">
                <i class="fas fa-times"></i> Clear
              </button>
              <!-- Hours back control -->
              <div class="input-group input-group-sm me-2" style="width: 150px;">
                <label class="input-group-text" for="hours-back-telemetry" title="Set the time window for the chart data in hours.">Hours</label>
                <input type="number" class="form-control hours-back-input" id="hours-back-telemetry" value="24" min="1" max="8760" data-report-type="telemetry">
              </div>
              <!-- Granularity control -->
              <div class="input-group input-group-sm" style="width: 150px;">
                <label class="input-group-text" for="granularity-select-telemetry" title="Set the data resampling interval.">Resample</label>
                <select class="form-select granularity-select" id="granularity-select-telemetry" data-report-type="telemetry">
                  <option value="5">5 min</option>
                  <option value="15" selected>15 min</option>
                  <option value="30">30 min</option>
                  <option value="60">60 min</option>
                </select>
              </div>
              <!-- Download Dropdown -->
              <div class="dropdown ms-2">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-download me-1"></i> Download
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item download-csv-btn" href="#" data-report-type="telemetry">Data as CSV</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="navigation" data-high-res="false">Charts as PNG</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="navigation" data-high-res="true">Charts as PNG (High-Res)</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="summary-content-area">
            {% if navigation_info and nav_values %}
              <div class="power-task-manager-summary detail-summary-box mb-3">
                  <div class="row">
                      <!-- Column 1: Position & Waypoint -->
                      <div class="col-md-4 power-summary-column">
                          <div class="text-center">
                              <div class="power-summary-header">Latitude</div>
                              <div class="power-summary-value-large" id="nav-latitude">
                                  {{ "%.5f"|format(nav_values.get('Latitude')) if nav_values.get('Latitude') is not none else 'N/A' }}
                              </div>
                          </div>
                          <div class="text-center mt-3">
                              <div class="power-summary-header">Longitude</div>
                              <div class="power-summary-value-large" id="nav-longitude">
                                  {{ "%.5f"|format(nav_values.get('Longitude')) if nav_values.get('Longitude') is not none else 'N/A' }}
                              </div>
                          </div>
                          <!-- Target Waypoint and last segment distance removed from Column 1 display -->
                      </div>
                      <!-- Column 2: Heading & Speed -->
                      <div class="col-md-4 power-summary-column">
                          <div class="text-center">
                              <div class="power-summary-header">Glider Heading</div>
                              <div class="power-summary-value-large" id="nav-heading">
                                  {{ "%.0f °"|format(nav_values.get('GliderHeading')) if nav_values.get('GliderHeading') is not none else 'N/A' }}
                              </div>
                          </div>
                          <div class="text-center mt-3">
                              <div class="power-summary-header">Glider Speed (SOG)</div>
                              <div class="power-summary-value-large" id="nav-speed">
                                  {{ "%.1f kn"|format(nav_values.get('SpeedOverGround')) if nav_values.get('SpeedOverGround') is not none else 'N/A' }}
                              </div>
                          </div>
                           <div class="text-center mt-3">
                              <div class="power-summary-header">Avg SOG (24h)</div>
                              <div class="power-summary-value-large" id="nav-avg-sog-24h">
                                  {{ "%.1f kn"|format(nav_values.get('AvgSpeedOverGround24h')) if nav_values.get('AvgSpeedOverGround24h') is not none else 'N/A' }}
                              </div>
                          </div>
                      </div>
                      <!-- Column 3: Distance Traveled & Current -->
                      <div class="col-md-4 power-summary-column">
                          <ul class="list-unstyled power-summary-details-list">
                              <li><span class="power-summary-label">Total Dist. Traveled (Mission):</span><span class="power-summary-value-right" id="nav-total-dist-mission">{{ "%.1f NM"|format(nav_values.get('TotalDistanceTraveledMissionNM')) if nav_values.get('TotalDistanceTraveledMissionNM') is not none else 'N/A' }}</span></li>
                              <li><span class="power-summary-label">Dist. Traveled (24h):</span><span class="power-summary-value-right" id="nav-dist-24h">{{ "%.1f NM"|format(nav_values.get('DistanceTraveled24hNM')) if nav_values.get('DistanceTraveled24hNM') is not none else 'N/A' }}</span></li>
                              <li><span class="power-summary-label">Ocean Current Speed:</span><span class="power-summary-value-right" id="nav-current-speed">{{ "%.1f kn"|format(nav_values.get('OceanCurrentSpeed')) if nav_values.get('OceanCurrentSpeed') is not none else 'N/A' }}</span></li>
                              <li><span class="power-summary-label">Ocean Current Dir:</span><span class="power-summary-value-right" id="nav-current-dir">{{ "%.0f °"|format(nav_values.get('OceanCurrentDirection')) if nav_values.get('OceanCurrentDirection') is not none else 'N/A' }}</span></li>
                          </ul>
                      </div>
                  </div>
              </div>
              {% elif navigation_info and navigation_info.latest_timestamp_str == "N/A" %}
              <p>Data unavailable.</p>
              {% else %}
              <p>Loading data...</p>
              {% endif %}
            </div>
            <h5 class="mt-3">Navigation Trends</h5>
            <div class="chart-container" style="position: relative; height: 300px; width: 100%">
              <div class="chart-spinner spinner-border text-light" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <canvas id="telemetryChart"></canvas>
            </div>
            <!-- New Ocean Current Chart -->
            <hr class="my-4">
            <h5 class="mt-3">Ocean Current & SOG</h5>
            <div class="chart-container" style="position: relative; height: 300px; width: 100%">
              <div class="chart-spinner spinner-border text-light" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <canvas id="telemetryCurrentChart"></canvas>
            </div>
            <!-- New Heading Difference Chart -->
            <hr class="my-4">
            <h5 class="mt-3">Sub Heading Difference & Ocean Current</h5>
            <div class="chart-container" style="position: relative; height: 300px; width: 100%">
              <div class="chart-spinner spinner-border text-light" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <canvas id="telemetryHeadingDiffChart"></canvas>
            </div>
          </div>
           <div class="card-footer text-muted small">
            {% if navigation_info and navigation_info.latest_timestamp_str != "N/A" %}
              Last data: {{ navigation_info.latest_timestamp_str }} ({{ navigation_info.time_ago_str }})
            {% else %}
              Last data: N/A
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Power Detail View (Initially Hidden) -->
      <div class="category-detail-view card mb-4" id="detail-power" style="display: none;"> 
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="mb-0">{{ mission }} - Power</h2>
            <div class="d-flex align-items-center">
              <!-- Date range controls -->
              <div class="input-group input-group-sm me-2" style="width: 200px;">
                <label class="input-group-text" for="start-date-power" title="Start date and time for data visualization.">From</label>
                <input type="datetime-local" class="form-control date-range-input" id="start-date-power" data-report-type="power">
              </div>
              <div class="input-group input-group-sm me-2" style="width: 200px;">
                <label class="input-group-text" for="end-date-power" title="End date and time for data visualization.">To</label>
                <input type="datetime-local" class="form-control date-range-input" id="end-date-power" data-report-type="power">
              </div>
              <button class="btn btn-outline-secondary btn-sm me-2" id="clear-date-power" title="Clear date range and return to hours mode" style="display: none;">
                <i class="fas fa-times"></i> Clear
              </button>
              <!-- Hours back control -->
              <div class="input-group input-group-sm me-2" style="width: 150px;">
                <label class="input-group-text" for="hours-back-power" title="Set the time window for the chart data in hours.">Hours</label>
                <input type="number" class="form-control hours-back-input" id="hours-back-power" value="24" min="1" max="8760" data-report-type="power">
              </div>
              <!-- Granularity control -->
              <div class="input-group input-group-sm" style="width: 150px;">
                <label class="input-group-text" for="granularity-select-power" title="Set the data resampling interval.">Resample</label>
                <select class="form-select granularity-select" id="granularity-select-power" data-report-type="power">
                  <option value="5">5 min</option>
                  <option value="15" selected>15 min</option>
                  <option value="30">30 min</option>
                  <option value="60">60 min</option>
                </select>
              </div>
              <!-- Download Dropdown -->
              <div class="dropdown ms-2">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-download me-1"></i> Download
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item download-csv-btn" href="#" data-report-type="power">Power Data as CSV</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="power" data-high-res="false">Charts as PNG</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="power" data-high-res="true">Charts as PNG (High-Res)</a></li>
                </ul>
              </div>
            </div>
        </div>
        <div class="card-body">
          <div class="summary-content-area">
            {% if power_info and power_values %} {# Use bracket notation for checking the item #}
            <div class="power-task-manager-summary detail-summary-box mb-3"> {# Added mb-3 for spacing before chart #}
                <div class="row">
                    <!-- Column 1 -->
                    <div class="col-md-4 power-summary-column">
                        <div class="text-center">
                            <div class="power-summary-header">Battery</div>
                            <div class="power-summary-value-large" id="power-battery-soc">
                                {{ "%.1f%%"|format(power_values.get('BatteryPercentage')) if power_values.get('BatteryPercentage') is not none else 'N/A' }}
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <div class="power-summary-header">Charge Rate</div>
                            <div class="power-summary-value-large" id="power-battery-charge-rate">
                                {{ "%.1f W"|format(power_values.get('BatteryChargeRateW')) if power_values.get('BatteryChargeRateW') is not none else 'N/A' }}
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <div class="power-summary-header">Time to Full</div>
                            <div class="power-summary-value-large {% if power_values.get('TimeToChargeStr') == 'Fully Charged' %}status-text-success{% elif 'Discharging' in (power_values.get('TimeToChargeStr') or '') or 'Stalled' in (power_values.get('TimeToChargeStr') or '') %}status-text-warning{% elif 'h' not in (power_values.get('TimeToChargeStr') or '') and 'm' not in (power_values.get('TimeToChargeStr') or '') and power_values.get('TimeToChargeStr') != 'N/A' %}status-text-info{% endif %}" id="power-time-to-charge">
                                {{ power_values.get('TimeToChargeStr') if power_values.get('TimeToChargeStr') is not none else 'N/A' }}
                            </div>
                        </div>
                    </div>
            
                    <!-- Column 2 -->
                    <div class="col-md-3 power-summary-column">
                        <div class="text-center">
                            <div class="power-summary-header">Capacity</div>
                            <div class="power-summary-value-large" id="power-battery-wh">
                                {{ "%.0f Wh"|format(power_values.get('BatteryWattHours')) if power_values.get('BatteryWattHours') is not none else 'N/A' }}
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <div class="power-summary-header">Avg Output (24h)</div>
                            <div class="power-summary-value-large" id="power-avg-output">
                                {{ "%.1f W"|format(power_values.get('AvgOutputPortPower24hrW')) if power_values.get('AvgOutputPortPower24hrW') is not none else 'N/A' }}
                            </div>
                        </div>
                    </div>
            
                    <!-- Column 3 -->
                    <div class="col-md-5 power-summary-column">
                        <ul class="list-unstyled power-summary-details-list">
                            <li><span class="power-summary-label">Solar (Now):</span><span class="power-summary-value-right" id="power-solar-now">{{ "%.1f W"|format(power_values.get('SolarInputWatts')) if power_values.get('SolarInputWatts') is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Solar (Avg 24h):</span><span class="power-summary-value-right" id="power-solar-avg-24h">{{ "%.1f W"|format(power_values.get('AvgSolarInput24hrW')) if power_values.get('AvgSolarInput24hrW') is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Panel 1:</span><span class="power-summary-value-right" id="power-panel1">{{ "%.1f W"|format(power_values.get('Panel1Power')) if power_values.get('Panel1Power') is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Panel 2:</span><span class="power-summary-value-right" id="power-panel2">{{ "%.1f W"|format(power_values.get('Panel2Power')) if power_values.get('Panel2Power') is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Panel 3:</span><span class="power-summary-value-right" id="power-panel3">{{ "%.1f W"|format(power_values.get('Panel4Power')) if power_values.get('Panel4Power') is not none else 'N/A' }}</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            {% elif power_info and power_info.latest_timestamp_str == "N/A" %} {# Check if info exists but no valid data #}
            <p>Data unavailable.</p>
            {% else %}
            <p>Loading data...</p> {# Or a more general loading state #}
            {% endif %}
          </div>
          <h5 class="mt-3">Power Trends</h5>
          <div class="chart-container" style="position: relative; height: 300px; width: 100%">
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="powerChart"></canvas>
          </div>
          <!-- New Solar Panel Chart -->
          <hr class="my-4">
          <h5 class="mt-3">Individual Solar Panel Power</h5>
          <div class="chart-container" style="position: relative; height: 300px; width: 100%">
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="solarPanelChart"></canvas>
          </div>
        </div>
         <div class="card-footer text-muted small">
          <!-- Ensure this footer content is not affecting the main body height for alignment -->
          {% if power_info and power_info.latest_timestamp_str != "N/A" %}
            Last data: {{ power_info.latest_timestamp_str }} ({{ power_info.time_ago_str }})
          {% else %}
            Last data: N/A
          {% endif %}
        </div>
      </div>
    </div>

      <!-- CTD Detail View (Initially Hidden) -->
      <div class="category-detail-view card mb-4" id="detail-ctd" style="display: none;">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="mb-0">{{ mission }} - CTD</h2>
            <div class="d-flex align-items-center">
              <!-- Date range controls -->
              <div class="input-group input-group-sm me-2" style="width: 200px;">
                <label class="input-group-text" for="start-date-ctd" title="Start date and time for data visualization.">From</label>
                <input type="datetime-local" class="form-control date-range-input" id="start-date-ctd" data-report-type="ctd">
              </div>
              <div class="input-group input-group-sm me-2" style="width: 200px;">
                <label class="input-group-text" for="end-date-ctd" title="End date and time for data visualization.">To</label>
                <input type="datetime-local" class="form-control date-range-input" id="end-date-ctd" data-report-type="ctd">
              </div>
              <button class="btn btn-outline-secondary btn-sm me-2" id="clear-date-ctd" title="Clear date range and return to hours mode" style="display: none;">
                <i class="fas fa-times"></i> Clear
              </button>
              <!-- Hours back control -->
              <div class="input-group input-group-sm me-2" style="width: 150px;">
                <label class="input-group-text" for="hours-back-ctd" title="Set the time window for the chart data in hours.">Hours</label>
                <input type="number" class="form-control hours-back-input" id="hours-back-ctd" value="24" min="1" max="8760" data-report-type="ctd">
              </div>
              <!-- Granularity control -->
              <div class="input-group input-group-sm" style="width: 150px;">
                <label class="input-group-text" for="granularity-select-ctd" title="Set the data resampling interval.">Resample</label>
                <select class="form-select granularity-select" id="granularity-select-ctd" data-report-type="ctd">
                  <option value="5">5 min</option>
                  <option value="15" selected>15 min</option>
                  <option value="30">30 min</option>
                  <option value="60">60 min</option>
                </select>
              </div>
              <!-- Download Dropdown -->
              <div class="dropdown ms-2">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-download me-1"></i> Download
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item download-csv-btn" href="#" data-report-type="ctd">Data as CSV</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="ctd" data-high-res="false">Charts as PNG</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="ctd" data-high-res="true">Charts as PNG (High-Res)</a></li>
                </ul>
              </div>
            </div>
        </div>
        <div class="card-body">
          <div class="summary-content-area">
            {% if ctd_info and ctd_values %} {# Use bracket notation for checking the item #}
            <div class="power-task-manager-summary detail-summary-box mb-3"> {# Reusing power summary class for layout #}
                <div class="row">
                    <!-- Column 1: Water Temp, Conductivity, Salinity -->
                    <div class="col-md-6 power-summary-column"> {# Adjust col-md-X as needed #}
                        <div class="text-center">
                            <div class="power-summary-header">Water Temperature</div>
                            <div class="power-summary-value-large" id="ctd-water-temp">
                                {{ "%.2f °C"|format(ctd_values.get('WaterTemperature')) if ctd_values.get('WaterTemperature') is not none else 'N/A' }}
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <div class="power-summary-header">Conductivity</div>
                            <div class="power-summary-value-large" id="ctd-conductivity">
                                {{ "%.3f S/m"|format(ctd_values.get('Conductivity')) if ctd_values.get('Conductivity') is not none else 'N/A' }}
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <div class="power-summary-header">Salinity</div>
                            <div class="power-summary-value-large" id="ctd-salinity">
                                {{ "%.2f PSU"|format(ctd_values.get('Salinity')) if ctd_values.get('Salinity') is not none else 'N/A' }}
                            </div>
                        </div>
                    </div>
            
                    <!-- Column 2: Dissolved Oxygen, Hi/Lo Temp, Pressure -->
                    <div class="col-md-6 power-summary-column"> {# Adjust col-md-X as needed #}
                        <ul class="list-unstyled power-summary-details-list">
                            <li><span class="power-summary-label">Dissolved Oxygen:</span><span class="power-summary-value-right" id="ctd-do">{{ "%.1f Hz"|format(ctd_values.get('DissolvedOxygen')) if ctd_values.get('DissolvedOxygen') is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Highest Temp (24h):</span><span class="power-summary-value-right" id="ctd-hi-temp">{{ "%.2f °C"|format(ctd_values.get('HighestWaterTemperature24h')) if ctd_values.get('HighestWaterTemperature24h') is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Lowest Temp (24h):</span><span class="power-summary-value-right" id="ctd-lo-temp">{{ "%.2f °C"|format(ctd_values.get('LowestWaterTemperature24h')) if ctd_values.get('LowestWaterTemperature24h') is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Pressure:</span><span class="power-summary-value-right" id="ctd-pressure">{{ "%.1f dbar"|format(ctd_values.get('Pressure')) if ctd_values.get('Pressure') is not none else 'N/A' }}</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            {% elif ctd_info and ctd_info.latest_timestamp_str == "N/A" %} {# Check if info exists but no valid data #}
            <p>Data unavailable.</p>
            {% else %} 
            <p>Loading data...</p> {# Or a more general loading state #}
            {% endif %}
          </div>
          <h5 class="mt-3">CTD Trends</h5>
          <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="ctdChart"></canvas>
          </div>
          <!-- New CTD Profile Chart -->
          <hr class="my-4">
          <h5 class="mt-3">CTD Profile Aux</h5>
          <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="ctdProfileChart"></canvas>
          </div>
        </div>
         <div class="card-footer text-muted small">
          {% if ctd_info and ctd_info.latest_timestamp_str != "N/A" %}
            Last data: {{ ctd_info.latest_timestamp_str }} ({{ ctd_info.time_ago_str }})
          {% else %}
            Last data: N/A
          {% endif %}
        </div>
      </div>
    </div>
  
      <!-- Weather Detail View (Initially Hidden) -->
      <div class="category-detail-view card mb-4" id="detail-weather" style="display: none;">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="mb-0">{{ mission }} - Weather Sensor</h2>
            <div class="d-flex align-items-center">
              <!-- Date range controls -->
              <div class="input-group input-group-sm me-2" style="width: 200px;">
                <label class="input-group-text" for="start-date-weather" title="Start date and time for data visualization.">From</label>
                <input type="datetime-local" class="form-control date-range-input" id="start-date-weather" data-report-type="weather">
              </div>
              <div class="input-group input-group-sm me-2" style="width: 200px;">
                <label class="input-group-text" for="end-date-weather" title="End date and time for data visualization.">To</label>
                <input type="datetime-local" class="form-control date-range-input" id="end-date-weather" data-report-type="weather">
              </div>
              <button class="btn btn-outline-secondary btn-sm me-2" id="clear-date-weather" title="Clear date range and return to hours mode" style="display: none;">
                <i class="fas fa-times"></i> Clear
              </button>
              <!-- Hours back control -->
              <div class="input-group input-group-sm me-2" style="width: 150px;">
                <label class="input-group-text" for="hours-back-weather" title="Set the time window for the chart data in hours.">Hours</label>
                <input type="number" class="form-control hours-back-input" id="hours-back-weather" value="24" min="1" max="8760" data-report-type="weather">
              </div>
              <!-- Granularity control -->
              <div class="input-group input-group-sm" style="width: 150px;">
                <label class="input-group-text" for="granularity-select-weather" title="Set the data resampling interval.">Resample</label>
                <select class="form-select granularity-select" id="granularity-select-weather" data-report-type="weather">
                  <option value="5">5 min</option>
                  <option value="15" selected>15 min</option>
                  <option value="30">30 min</option>
                  <option value="60">60 min</option>
                </select>
              </div>
              <!-- Download Dropdown -->
              <div class="dropdown ms-2">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-download me-1"></i> Download
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item download-csv-btn" href="#" data-report-type="weather">Data as CSV</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="weather" data-high-res="false">Charts as PNG</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="weather" data-high-res="true">Charts as PNG (High-Res)</a></li>
                </ul>
              </div>
            </div>
        </div>
        <div class="card-body">
          <div class="summary-content-area">
            {% if weather_info and weather_values %}
            <div class="power-task-manager-summary detail-summary-box mb-3"> {# Reusing power summary class for layout #}
                <div class="row">
                    <!-- Column 1: Wind Speed, Wind Direction -->
                    <div class="col-md-4 power-summary-column">
                        <div class="text-center">
                            <div class="power-summary-header">Wind Speed</div>
                            <div class="power-summary-value-large" id="weather-wind-speed">
                                {{ "%.1f kt"|format(weather_values.get('WindSpeed')) if weather_values.get('WindSpeed') is not none else 'N/A' }}
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <div class="power-summary-header">Wind Direction</div>
                            <div class="power-summary-value-large" id="weather-wind-dir">
                                {{ "%.0f °"|format(weather_values.get('WindDirection')) if weather_values.get('WindDirection') is not none else 'N/A' }}
                            </div>
                        </div>
                    </div>
            
                    <!-- Column 2: Gust Speed, Gust Direction -->
                    <div class="col-md-4 power-summary-column">
                        <div class="text-center">
                            <div class="power-summary-header">Gust Speed</div>
                            <div class="power-summary-value-large" id="weather-gust-speed">
                                {{ "%.1f kt"|format(weather_values.get('WindGust')) if weather_values.get('WindGust') is not none else 'N/A' }}
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <div class="power-summary-header">Gust Direction</div>
                            <div class="power-summary-value-large" id="weather-gust-dir">
                                {{ "%.0f °"|format(weather_values.get('GustDirection')) if weather_values.get('GustDirection') is not none else 'N/A' }}
                            </div>
                        </div>
                    </div>
            
                    <!-- Column 3: Air Temp & Pressure Details -->
                    <div class="col-md-4 power-summary-column">
                        <ul class="list-unstyled power-summary-details-list">
                            <li><span class="power-summary-label">Air Temp (Now):</span><span class="power-summary-value-right" id="weather-air-temp-now">{{ "%.1f °C"|format(weather_values.get('AirTemperature')) if weather_values.get('AirTemperature') is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Air Temp High (24h):</span><span class="power-summary-value-right" id="weather-air-temp-high">{{ "%.1f °C"|format(weather_values.get('AirTemperatureHigh24h')) if weather_values.get('AirTemperatureHigh24h') is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Air Temp Low (24h):</span><span class="power-summary-value-right" id="weather-air-temp-low">{{ "%.1f °C"|format(weather_values.get('AirTemperatureLow24h')) if weather_values.get('AirTemperatureLow24h') is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Pressure (Now):</span><span class="power-summary-value-right" id="weather-pressure-now">{{ "%.1f mbar"|format(weather_values.get('BarometricPressure')) if weather_values.get('BarometricPressure') is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Pressure High (24h):</span><span class="power-summary-value-right" id="weather-pressure-high">{{ "%.1f mbar"|format(weather_values.get('PressureHigh24h')) if weather_values.get('PressureHigh24h') is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Pressure Low (24h):</span><span class="power-summary-value-right" id="weather-pressure-low">{{ "%.1f mbar"|format(weather_values.get('PressureLow24h')) if weather_values.get('PressureLow24h') is not none else 'N/A' }}</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            {% elif weather_info and weather_info.latest_timestamp_str == "N/A" %} {# Check if info exists but no valid data #}
            <p>Data unavailable.</p> {# Display this if weather_info exists but has no valid data #}
            {% else %}
            <p>Loading data...</p> {# Or a more general loading state #}
            {% endif %}
          </div>
          <h5 class="mt-3">Weather Sensor Trends</h5>
          <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="weatherSensorChart"></canvas>
          </div>
          <!-- Weather Forecast Embedded -->
          <hr class="my-4"> <!-- Add a visual separator -->
          <h4 class="mb-3">Weather Forecast</h4>
          <div id="forecastDisplay">
            <div id="forecastInitial" class="table-responsive" style="display: none;">
                <p class="text-muted">Loading initial forecast...</p>
            </div>
            <button class="btn btn-outline-secondary btn-sm mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#forecastExtended" aria-expanded="false" aria-controls="forecastExtended" id="toggleForecastBtn" style="display: none;">
              Show More
            </button>
            <div class="collapse mt-2" id="forecastExtended">
              <div id="forecastExtendedContent" class="table-responsive">
                <!-- Extended forecast will be rendered here by JS -->
              </div>
            </div>
          </div>
          <div class="text-muted small mt-2" id="forecastMetaInfo" style="display: none;">
            <!-- Forecast metadata will be injected here by JavaScript -->
          </div>
          <!-- End Weather Forecast Embedded -->

        </div>
        <div class="card-footer text-muted small">
          {% if weather_info and weather_info.latest_timestamp_str != "N/A" %}
            Last data: {{ weather_info.latest_timestamp_str }} ({{ weather_info.time_ago_str }})
          {% else %}
            Last data: N/A
          {% endif %}
        </div>
      </div>
    </div>
      <!-- Wave Detail View (Initially Hidden) -->
      <div class="category-detail-view card mb-4" id="detail-waves" style="display: none;">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="mb-0">{{ mission }} - Wave</h2>
            <div class="d-flex align-items-center">
              <!-- Date range controls -->
              <div class="input-group input-group-sm me-2" style="width: 200px;">
                <label class="input-group-text" for="start-date-waves" title="Start date and time for data visualization.">From</label>
                <input type="datetime-local" class="form-control date-range-input" id="start-date-waves" data-report-type="waves">
              </div>
              <div class="input-group input-group-sm me-2" style="width: 200px;">
                <label class="input-group-text" for="end-date-waves" title="End date and time for data visualization.">To</label>
                <input type="datetime-local" class="form-control date-range-input" id="end-date-waves" data-report-type="waves">
              </div>
              <button class="btn btn-outline-secondary btn-sm me-2" id="clear-date-waves" title="Clear date range and return to hours mode" style="display: none;">
                <i class="fas fa-times"></i> Clear
              </button>
              <!-- Hours back control -->
              <div class="input-group input-group-sm me-2" style="width: 150px;">
                <label class="input-group-text" for="hours-back-waves" title="Set the time window for the chart data in hours.">Hours</label>
                <input type="number" class="form-control hours-back-input" id="hours-back-waves" value="24" min="1" max="8760" data-report-type="waves">
              </div>
              <!-- Granularity control -->
              <div class="input-group input-group-sm" style="width: 150px;">
                <label class="input-group-text" for="granularity-select-waves" title="Set the data resampling interval.">Resample</label>
                <select class="form-select granularity-select" id="granularity-select-waves" data-report-type="waves">
                  <option value="5">5 min</option>
                  <option value="15" selected>15 min</option>
                  <option value="30">30 min</option>
                  <option value="60">60 min</option>
                </select>
              </div>
              <!-- Download Dropdown -->
              <div class="dropdown ms-2">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-download me-1"></i> Download
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item download-csv-btn" href="#" data-report-type="waves">Data as CSV</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="waves" data-high-res="false">Charts as PNG</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="waves" data-high-res="true">Charts as PNG (High-Res)</a></li>
                </ul>
              </div>
            </div>
        </div>
        <div class="card-body">
          <div class="summary-content-area">
            {% if wave_info and wave_values %}
            <div class="power-task-manager-summary detail-summary-box mb-3"> {# Reusing power summary class for layout #}
                <div class="row">
                    <!-- Column 1: Wave Height, Wave Height 24hr Avg -->
                    <div class="col-md-4 power-summary-column">
                        <div class="text-center">
                            <div class="power-summary-header">Wave Height (Hs)</div>
                            <div class="power-summary-value-large" id="wave-height-now">
                                {{ "%.2f m"|format(wave_values.get('SignificantWaveHeight')) if wave_values.get('SignificantWaveHeight') is not none else 'N/A' }}
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <div class="power-summary-header">Avg Hs (24h)</div>
                            <div class="power-summary-value-large" id="wave-height-avg-24h">
                                {{ "%.2f m"|format(wave_values.get('SignificantWaveHeightAvg24h')) if wave_values.get('SignificantWaveHeightAvg24h') is not none else 'N/A' }}
                            </div>
                        </div>
                    </div>
            
                    <!-- Column 2: Wave Direction -->
                    <div class="col-md-4 power-summary-column">
                        <div class="text-center">
                            <div class="power-summary-header">Wave Direction (Dp)</div>
                            <div class="power-summary-value-large" id="wave-direction"> {# Use MeanDirectionDisplay for the text #}
                                <span {% if wave_values.get('MeanDirectionStatus') == 'outlier' %}
                                      title="Latest data point was an invalid outlier (e.g., 9999)."
                                      class="text-warning"
                                     {% endif %}>{{ wave_values.get('MeanDirectionDisplay', 'N/A') }}</span>
                            </div>
                            {% if wave_values.get('MeanDirectionNumeric') is not none and wave_values.get('MeanDirectionStatus') == 'valid' %}
                            <div class="wave-propagation-arrow-container">
                                <span class="wave-propagation-arrow" 
                                      style="transform: rotate({{ (wave_values.get('MeanDirectionNumeric') + 180) % 360 }}deg);">
                                    &uarr; {# Unicode for upward arrow #}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
            
                    <!-- Column 3: Amplitude, Period, Sample Gaps -->
                    <div class="col-md-4 power-summary-column">
                        <ul class="list-unstyled power-summary-details-list">
                            <li><span class="power-summary-label">Amplitude (A):</span><span class="power-summary-value-right" id="wave-amplitude">{{ "%.2f m"|format(wave_values.get('WaveAmplitude')) if wave_values.get('WaveAmplitude') is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Period (Tp):</span><span class="power-summary-value-right" id="wave-period">{{ "%.1f s"|format(wave_values.get('WavePeriod')) if wave_values.get('WavePeriod') is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Sample Gaps:</span><span class="power-summary-value-right {% if wave_values.get('SampleGaps') is not none and wave_values.get('SampleGaps') > 10 %}text-danger fw-bold{% elif wave_values.get('SampleGaps') is not none and wave_values.get('SampleGaps') > 2 %}text-warning{% endif %}" id="wave-sample-gaps">{{ "%.0f"|format(wave_values.get('SampleGaps')) if wave_values.get('SampleGaps') is not none else 'N/A' }}</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            {% elif wave_info and wave_info.latest_timestamp_str == "N/A" %} {# Check if info exists but no valid data #}
            <p>Data unavailable.</p>
            {% else %}
            <p>Loading data...</p>
            {% endif %}
          </div>
          <h5 class="mt-3">Wave Trends</h5>
          <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="waveChart"></canvas>
          </div>
          <!-- New Wave Chart: Height vs Direction -->
          <hr class="my-4">
          <h5 class="mt-3">Wave Height & Direction</h5>
          <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="waveHeightDirectionChart"></canvas>
          </div>

          <!-- New Wave Spectrum Chart -->
          <hr class="my-4">
          <h5 class="mt-3">Latest Wave Energy Spectrum (E(f))</h5>
          <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="waveSpectrumChart"></canvas> <!-- Ensure this ID is present -->
          </div>

          <!-- Marine Weather Forecast Embedded -->
          <hr class="my-4"> <!-- Add a visual separator -->
          <h4 class="mb-3">Marine Forecast</h4>
          <div id="marineForecastDisplay">
            <div id="marineForecastInitial" class="table-responsive" style="display: none;">
                <p class="text-muted">Loading marine forecast...</p>
            </div>
            <button class="btn btn-outline-secondary btn-sm mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#marineForecastExtended" aria-expanded="false" aria-controls="marineForecastExtended" id="toggleMarineForecastBtn" style="display: none;">
              Show More
            </button>
            <div class="collapse mt-2" id="marineForecastExtended">
              <div id="marineForecastExtendedContent" class="table-responsive">
                <!-- Extended marine forecast will be rendered here by JS -->
              </div>
            </div>
          </div>
          <div class="text-muted small mt-2" id="marineForecastMetaInfo" style="display: none;">
            <!-- Marine forecast metadata will be injected here by JavaScript -->
          </div>
          <!-- End Marine Weather Forecast Embedded -->
        </div>
        <div class="card-footer text-muted small">
          {% if wave_info and wave_info.latest_timestamp_str != "N/A" %}
            Last data: {{ wave_info.latest_timestamp_str }} ({{ wave_info.time_ago_str }})
          {% else %}
            Last data: N/A
          {% endif %}
        </div>
      </div>
    </div>

      <!-- VR2C Detail View (Initially Hidden) -->
      <div class="category-detail-view card mb-4" id="detail-vr2c" style="display: none;">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="mb-0">{{ mission }} - VR2C-MRx Acoustic Receiver</h2>
            <div class="d-flex align-items-center">
              <!-- Date range controls -->
              <div class="input-group input-group-sm me-2" style="width: 200px;">
                <label class="input-group-text" for="start-date-vr2c" title="Start date and time for data visualization.">From</label>
                <input type="datetime-local" class="form-control date-range-input" id="start-date-vr2c" data-report-type="vr2c">
              </div>
              <div class="input-group input-group-sm me-2" style="width: 200px;">
                <label class="input-group-text" for="end-date-vr2c" title="End date and time for data visualization.">To</label>
                <input type="datetime-local" class="form-control date-range-input" id="end-date-vr2c" data-report-type="vr2c">
              </div>
              <button class="btn btn-outline-secondary btn-sm me-2" id="clear-date-vr2c" title="Clear date range and return to hours mode" style="display: none;">
                <i class="fas fa-times"></i> Clear
              </button>
              <!-- Hours back control -->
              <div class="input-group input-group-sm me-2" style="width: 150px;">
                <label class="input-group-text" for="hours-back-vr2c" title="Set the time window for the chart data in hours.">Hours</label>
                <input type="number" class="form-control hours-back-input" id="hours-back-vr2c" value="24" min="1" max="8760" data-report-type="vr2c">
              </div>
              <!-- Granularity control -->
              <div class="input-group input-group-sm" style="width: 150px;">
                <label class="input-group-text" for="granularity-select-vr2c" title="Set the data resampling interval.">Resample</label>
                <select class="form-select granularity-select" id="granularity-select-vr2c" data-report-type="vr2c">
                  <option value="5">5 min</option>
                  <option value="15" selected>15 min</option>
                  <option value="30">30 min</option>
                  <option value="60">60 min</option>
                </select>
              </div>
              <!-- Download Dropdown -->
              <div class="dropdown ms-2">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-download me-1"></i> Download
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item download-csv-btn" href="#" data-report-type="vr2c">Data as CSV</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="vr2c" data-high-res="false">Charts as PNG</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="vr2c" data-high-res="true">Charts as PNG (High-Res)</a></li>
                </ul>
              </div>
            </div>
        </div>
        <div class="card-body">
          <div class="summary-content-area">
            {% if vr2c_info and vr2c_values %}
            <div class="detail-summary-box mb-3">
              <ul class="list-unstyled">
                <li>
                  Serial Number: {{ vr2c_values.get('SerialNumber') if vr2c_values.get('SerialNumber') is not none else '<span class="na-value">N/A</span>' | safe }}
                </li>
                <li>
                  Detection Count (DC): {{ vr2c_values.get('DetectionCount') if vr2c_values.get('DetectionCount') is not none else '<span class="na-value">N/A</span>' | safe }}
                </li>
                <li>
                  Ping Count (PC): {{ vr2c_values.get('PingCount') if vr2c_values.get('PingCount') is not none else '<span class="na-value">N/A</span>' | safe }}
                </li>
              </ul>
            </div>
            {% elif vr2c_info and vr2c_info.latest_timestamp_str == "N/A" %}
            <p>Data unavailable.</p>
            {% else %}
            <p>Loading data...</p>
            {% endif %}
          </div>
          <h5 class="mt-3">VR2C Trends</h5>
          <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="vr2cChart"></canvas>
          </div>
        </div>
        <div class="card-footer text-muted small">
          {% if vr2c_info and vr2c_info.latest_timestamp_str != "N/A" %}
            Last data: {{ vr2c_info.latest_timestamp_str }} ({{ vr2c_info.time_ago_str }})
          {% else %}
            Last data: N/A
          {% endif %}
        </div>
      </div>
    </div>
    
      <!-- Fluorometer Detail View (Initially Hidden) -->
      <div class="category-detail-view card mb-4" id="detail-fluorometer" style="display: none;">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="mb-0">{{ mission }} - C3 Fluorometer</h2>
            <div class="d-flex align-items-center">
              <!-- Date range controls -->
              <div class="input-group input-group-sm me-2" style="width: 200px;">
                <label class="input-group-text" for="start-date-fluorometer" title="Start date and time for data visualization.">From</label>
                <input type="datetime-local" class="form-control date-range-input" id="start-date-fluorometer" data-report-type="fluorometer">
              </div>
              <div class="input-group input-group-sm me-2" style="width: 200px;">
                <label class="input-group-text" for="end-date-fluorometer" title="End date and time for data visualization.">To</label>
                <input type="datetime-local" class="form-control date-range-input" id="end-date-fluorometer" data-report-type="fluorometer">
              </div>
              <button class="btn btn-outline-secondary btn-sm me-2" id="clear-date-fluorometer" title="Clear date range and return to hours mode" style="display: none;">
                <i class="fas fa-times"></i> Clear
              </button>
              <!-- Hours back control -->
              <div class="input-group input-group-sm me-2" style="width: 150px;">
                <label class="input-group-text" for="hours-back-fluorometer" title="Set the time window for the chart data in hours.">Hours</label>
                <input type="number" class="form-control hours-back-input" id="hours-back-fluorometer" value="24" min="1" max="8760" data-report-type="fluorometer">
              </div>
              <!-- Granularity control -->
              <div class="input-group input-group-sm" style="width: 150px;">
                <label class="input-group-text" for="granularity-select-fluorometer" title="Set the data resampling interval.">Resample</label>
                <select class="form-select granularity-select" id="granularity-select-fluorometer" data-report-type="fluorometer">
                  <option value="5">5 min</option>
                  <option value="15" selected>15 min</option>
                  <option value="30">30 min</option>
                  <option value="60">60 min</option>
                </select>
              </div>
              <!-- Download Dropdown -->
              <div class="dropdown ms-2">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-download me-1"></i> Download
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item download-csv-btn" href="#" data-report-type="fluorometer">Data as CSV</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="fluorometer" data-high-res="false">Charts as PNG</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="fluorometer" data-high-res="true">Charts as PNG (High-Res)</a></li>
                </ul>
              </div>
            </div>
        </div>
        <div class="card-body">
          <div class="summary-content-area">
            {% if fluorometer_info and fluorometer_values %}
            <div class="detail-summary-box mb-3">
              <ul class="list-unstyled">
                <li>
                  C1 Avg: {{ "%.2f"|format(fluorometer_values.get('C1_Avg')) if fluorometer_values.get('C1_Avg') is not none else '<span class="na-value">N/A</span>' | safe }}
                </li>
                <li>
                  C2 Avg: {{ "%.2f"|format(fluorometer_values.get('C2_Avg')) if fluorometer_values.get('C2_Avg') is not none else '<span class="na-value">N/A</span>' | safe }}
                </li>
                <li>
                  C3 Avg: {{ "%.2f"|format(fluorometer_values.get('C3_Avg')) if fluorometer_values.get('C3_Avg') is not none else '<span class="na-value">N/A</span>' | safe }}
                </li>
                <li>
                  Temperature (°C): {{ "%.2f"|format(fluorometer_values.get('Temperature_Fluor')) if fluorometer_values.get('Temperature_Fluor') is not none else '<span class="na-value">N/A</span>' | safe }}
                </li>
              </ul>
            </div>
            {% elif fluorometer_info and fluorometer_info.latest_timestamp_str == "N/A" %}
            <p>Data unavailable.</p>
            {% else %}
            <p>Loading data...</p>
            {% endif %}
          </div>
          <h5 class="mt-3">Fluorometer Trends</h5>
          <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="fluorometerChart"></canvas>
          </div>
        </div>
        <div class="card-footer text-muted small">
          {% if fluorometer_info and fluorometer_info.latest_timestamp_str != "N/A" %}
            Last data: {{ fluorometer_info.latest_timestamp_str }} ({{ fluorometer_info.time_ago_str }})
          {% else %}
            Last data: N/A
          {% endif %}
        </div>
      </div>
    </div>

      <!-- WG-VM4 Detail View (Initially Hidden) -->
      <div class="category-detail-view card mb-4" id="detail-wg_vm4" style="display: none;">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="mb-0">{{ mission }} - WG-VM4 Sensor</h2>
            <div class="d-flex align-items-center">
              <!-- Date range controls -->
              <div class="input-group input-group-sm me-2" style="width: 200px;">
                <label class="input-group-text" for="start-date-wg_vm4" title="Start date and time for data visualization.">From</label>
                <input type="datetime-local" class="form-control date-range-input" id="start-date-wg_vm4" data-report-type="wg_vm4">
              </div>
              <div class="input-group input-group-sm me-2" style="width: 200px;">
                <label class="input-group-text" for="end-date-wg_vm4" title="End date and time for data visualization.">To</label>
                <input type="datetime-local" class="form-control date-range-input" id="end-date-wg_vm4" data-report-type="wg_vm4">
              </div>
              <button class="btn btn-outline-secondary btn-sm me-2" id="clear-date-wg_vm4" title="Clear date range and return to hours mode" style="display: none;">
                <i class="fas fa-times"></i> Clear
              </button>
              <!-- Hours back control -->
              <div class="input-group input-group-sm me-2" style="width: 150px;">
                <label class="input-group-text" for="hours-back-wg_vm4" title="Set the time window for the chart data in hours.">Hours</label>
                <input type="number" class="form-control hours-back-input" id="hours-back-wg_vm4" value="24" min="1" max="8760" data-report-type="wg_vm4">
              </div>
              <!-- Granularity control -->
              <div class="input-group input-group-sm" style="width: 150px;">
                <label class="input-group-text" for="granularity-select-wg_vm4" title="Set the data resampling interval.">Resample</label>
                <select class="form-select granularity-select" id="granularity-select-wg_vm4" data-report-type="wg_vm4">
                  <option value="5">5 min</option>
                  <option value="15" selected>15 min</option>
                  <option value="30">30 min</option>
                  <option value="60">60 min</option>
                </select>
              </div>
              <!-- Download Dropdown -->
              <div class="dropdown ms-2">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-download me-1"></i> Download
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item download-csv-btn" href="#" data-report-type="wg_vm4">Data as CSV</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="wg_vm4" data-high-res="false">Charts as PNG</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="wg_vm4" data-high-res="true">Charts as PNG (High-Res)</a></li>
                </ul>
              </div>
            </div>
        </div>
        <div class="card-body">
          <!-- WG-VM4 Health Summary (existing) -->
          <div class="summary-content-area detail-summary-box mb-3">
            {% if wg_vm4_info and wg_vm4_values %}
            <div>
              <h5>VM4 Health Summary</h5>
              <ul class="list-unstyled">
                <li>Serial Number: {{ wg_vm4_values.get('SerialNumber') if wg_vm4_values.get('SerialNumber') is not none else 'N/A' }}</li>
                <li>Channel 0 Detections: {{ wg_vm4_values.get('Channel0DetectionCount') if wg_vm4_values.get('Channel0DetectionCount') is not none else 'N/A' }}</li>
                <li>Channel 1 Detections: {{ wg_vm4_values.get('Channel1DetectionCount') if wg_vm4_values.get('Channel1DetectionCount') is not none else 'N/A' }}</li>
              </ul>
            </div>
            {% elif wg_vm4_info and wg_vm4_info.latest_timestamp_str == "N/A" %}
            <p class="text-muted">VM4 health data unavailable.</p>
            {% else %}
            <p class="text-muted">Loading VM4 health data...</p>
            {% endif %}
          </div>
          <hr>
          <!-- Station Offload Log Section -->
          <h4 class="mt-4">Station Offload Log</h4>
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="stationIdSearch" class="form-label">Station ID Search:</label>
              <div class="input-group">
                <input type="text" class="form-control form-control-sm" id="stationIdSearch" placeholder="e.g., CBS001">
                <button class="btn btn-sm btn-outline-secondary" type="button" id="fetchStationDataBtn">Load</button>
              </div>
              <div id="stationSearchResults" class="list-group mt-1 position-absolute" style="z-index: 1000; width: calc(100% - 1rem); display:none;"></div>
            </div>
          </div>

          <div id="stationMetadataDisplay" class="mb-3 p-3 border rounded bg-body-tertiary" style="display: none;">
            <h5>Station Details</h5>
            <div class="row">
              <div class="col-md-6">
                <p class="mb-1"><small><strong>Serial Number:</strong> <span id="metaSerial">N/A</span></small></p>
                <p class="mb-1"><small><strong>Modem Address:</strong> <span id="metaModemAddr">N/A</span></small></p>
                <p class="mb-1"><small><strong>Depth (m):</strong> <span id="metaDepth">N/A</span></small></p>
              </div>
              <div class="col-md-6">
                <p class="mb-1"><small><strong>WP #:</strong> <span id="metaWp">N/A</span></small></p>
                <p class="mb-1"><small><strong>Last Offload:</strong> <span id="metaLastOffload">N/A</span></small></p>
                <p class="mb-1"><small><strong>Last Offload Time:</strong> <span id="metaLastOffloadTimestamp">N/A</span></small></p>
                <p class="mb-1"><small><strong>Settings:</strong> <span id="metaSettings">N/A</span></small></p>
              </div>
              <div class="col-12 mt-1" id="metaNotesContainer" style="display:none;">
                 <p class="mb-1"><small><strong>Station Notes:</strong> <span id="metaNotes"></span></small></p>
              </div>
            </div>
          </div>
          <div id="stationMetadataError" class="alert alert-warning" style="display:none;"></div>

          <form id="wgVm4OffloadForm">
            <!-- Offload Parameters & Timings (Dynamically generated by JS based on schema, or hardcoded here) -->
            <!-- For simplicity, we'll add a few key fields here and JS can enhance -->
            <h5 class="mt-3">Offload Details</h5>
             <!-- Input fields will be added here by JS or defined statically -->
            <div id="offloadLogFormFieldsContainer"></div>
            <button type="submit" class="btn btn-primary mt-3" id="submitOffloadLogBtn" disabled>Submit Offload Log</button>
          </form>
          <div id="offloadSubmissionStatus" class="mt-3"></div>

          <h5 class="mt-3">WG-VM4 Trends</h5>
          <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="wgVm4Chart"></canvas>
          </div>
        </div>
        <div class="card-footer text-muted small">
          {% if wg_vm4_info and wg_vm4_info.latest_timestamp_str != "N/A" %}
            Last data: {{ wg_vm4_info.latest_timestamp_str }} ({{ wg_vm4_info.time_ago_str }})
          {% else %}
            Last data: N/A
          {% endif %}
        </div>
      </div>
    </div>
    </div> <!-- End Right Main Display Area -->
  </div> <!-- End New Two-Column Layout / End Right Main Display Area -->
    <!-- --- Footer --- -->
  <hr>

  {% if current_user and current_user.role == 'admin' %}
  <!-- Add/Edit Goal Modal -->
  <div class="modal fade" id="goalModal" tabindex="-1" aria-labelledby="goalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="goalModalLabel">Add Mission Goal</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="goalForm">
            <input type="hidden" id="goalIdInput">
            <div class="mb-3">
              <label for="goalDescriptionInput" class="form-label">Goal Description</label>
              <textarea class="form-control" id="goalDescriptionInput" rows="3" required></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveGoalBtn">Save Goal</button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

{% endblock %}

{% block body_extra_js %}
  <script type="module" src="/static/js/dashboard.js"></script>
  <script type="module" src="/static/js/wg_vm4.js" defer></script> {# Load WG-VM4 specific JS #}
  <script>
    // Pass error analysis data to JavaScript
    window.errorAnalysisData = {{ error_analysis | tojson if error_analysis else '{}' }};
    
    // Handle chevron rotation for All Errors collapsible
    document.addEventListener('DOMContentLoaded', function() {
      const allErrorsButton = document.querySelector('[data-bs-target="#allErrorsCollapse"]');
      const allErrorsChevron = document.getElementById('allErrorsChevron');
      
      if (allErrorsButton && allErrorsChevron) {
        allErrorsButton.addEventListener('click', function() {
          const isExpanded = this.getAttribute('aria-expanded') === 'true';
          if (isExpanded) {
            allErrorsChevron.classList.remove('fa-chevron-up');
            allErrorsChevron.classList.add('fa-chevron-down');
          } else {
            allErrorsChevron.classList.remove('fa-chevron-down');
            allErrorsChevron.classList.add('fa-chevron-up');
          }
        });
      }
      
      // Handle chevron rotation for All AIS Targets collapsible
      const allAisButton = document.querySelector('[data-bs-target="#allAisCollapse"]');
      const allAisChevron = document.getElementById('allAisChevron');
      
      if (allAisButton && allAisChevron) {
        allAisButton.addEventListener('click', function() {
          const isExpanded = this.getAttribute('aria-expanded') === 'true';
          if (isExpanded) {
            allAisChevron.classList.remove('fa-chevron-up');
            allAisChevron.classList.add('fa-chevron-down');
          } else {
            allAisChevron.classList.remove('fa-chevron-down');
            allAisChevron.classList.add('fa-chevron-up');
          }
        });
      }
    });
  </script>
{% endblock %}
