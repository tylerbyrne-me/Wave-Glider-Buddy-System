{% extends "base.html" %}

{% block title %}Wave Glider Status - {{ mission }}{% endblock %}

{% block head_extra_css %}
  {# Chart.js and its adapter are now loaded globally in base.html #}
{% endblock %}

{% block body_class %}container-fluid{% endblock %} {# Removed py-4. Body padding is handled by base.html for fixed-top navbar. #}

{% block body_data_attributes %}
  data-mission-id="{{ mission }}" {# data-is-realtime is now passed directly to _banner.html #}
{% endblock %}

{% block content %}
  {# The main content of index.html starts here. The body padding for fixed-top navbar is handled by base.html #}
  <div class="modal fade" id="dataSourceModal" tabindex="-1" aria-labelledby="dataSourceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="dataSourceModalLabel">Select Data Source</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="alert alert-info small" role="alert">
            <strong>Currently Loading From:</strong><br>
            <span class="font-monospace">{{ display_source_path }}</span>
            {% if current_source_preference %}
              <br><strong>Requested Source Type:</strong> {{ "Local" if current_source_preference == 'local' else "Remote" }}
            {% endif %}
          </div>
          <hr>
          <div class="form-check mb-2"> {# Added margin-bottom #}
            <input class="form-check-input" type="radio" name="dataSourceOption" id="sourceRemote" value="remote" {% if not current_source_preference or current_source_preference == 'remote' %}checked{% endif %}>
            <label class="form-check-label" for="sourceRemote">
              Remote Data (Default: Remote first, then local fallback)
            </label>
          </div>
          <div class="form-check mb-2"> {# Added margin-bottom #}
            <input class="form-check-input" type="radio" name="dataSourceOption" id="sourceLocal" value="local" {% if current_source_preference == 'local' %}checked{% endif %}>
            <label class="form-check-label" for="sourceLocal">
              Local Data Only
            </label>
          </div>
          <div class="mt-3" id="localPathInputGroup" style="display: {% if current_source == 'local' %}block{% else %}none{% endif %};">
            <label for="customLocalPath" class="form-label">Custom Local Data Path (optional):</label>
            <input type="text" class="form-control" id="customLocalPath" placeholder="e.g., C:\my_glider_data" value="{{ current_local_path or '' }}">
            <small class="form-text text-muted">If blank, uses default local path from system config.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="applyDataSource">Apply</button>
        </div>
      </div>
    </div>
  </div>

  <!-- General Error Display Area -->
  <div id="generalErrorDisplay" class="alert alert-danger" style="display: none;" role="alert">
    An error occurred. Please check console for details or try again later.
  </div>

    <!-- New Two-Column Layout for Dashboard Content -->
  <div class="row mt-3" id="dashboard-main-content"> {# Added mt-3 for spacing below new banner #}
    <!-- Left Navigation Panel (Summary Cards) -->
    <div class="col-md-3" id="left-nav-panel">
      <!-- Navigation Summary Card -->
      <div class="summary-card active-card" data-category="navigation" data-mini-trend='{{ navigation_info.mini_trend | tojson | safe if navigation_info and "mini_trend" in navigation_info and navigation_info.mini_trend is not none else "[]" }}'>
        <div class="summary-card-main-content">
          <div class="mini-chart-container">
            <canvas id="miniNavigationChart"></canvas>
          </div>
          <div class="summary-card-text-content">
            <h5>Navigation</h5>
            <div class="mini-summary">
              {% if navigation_info and navigation_info['values'] is not none %}
                SOG: {{ "%.1f kn"|format(navigation_info['values']['SpeedOverGround']) if navigation_info['values']['SpeedOverGround'] is not none else 'N/A' }}<br>
                POG: {{ "%.0f °"|format(navigation_info['values']['GliderHeading']) if navigation_info['values']['GliderHeading'] is not none else 'N/A' }}
              {% else %} N/A {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ navigation_info.time_ago_str if navigation_info else 'N/A' }}
        </div>
      </div>

      <!-- Power Summary Card -->
      <div class="summary-card" data-category="power" data-mini-trend='{{ power_info.mini_trend | tojson | safe if power_info and "mini_trend" in power_info and power_info.mini_trend is not none else "[]" }}'>
        <div class="summary-card-main-content">
          <div class="mini-chart-container">
            <canvas id="miniPowerChart"></canvas>
          </div>
          <div class="summary-card-text-content">
            <h5>Power</h5>
            <div class="mini-summary">
              {% if power_info and power_info['values'] is not none %}
                Batt: {{ "%.0f"|format(power_info['values'].get('BatteryPercentage')) if power_info['values'].get('BatteryPercentage') is not none else 'N/A' }}%<br>
                Net: {{ "%.1f"|format(power_info['values'].get('BatteryChargeRateW')) if power_info['values'].get('BatteryChargeRateW') is not none else 'N/A' }} W
              {% else %} N/A {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ power_info.time_ago_str if power_info else 'N/A' }}
        </div>
      </div>

      <!-- CTD Summary Card -->
      <div class="summary-card" data-category="ctd" data-mini-trend='{{ ctd_info.mini_trend | tojson | safe if ctd_info and "mini_trend" in ctd_info and ctd_info.mini_trend is not none else "[]" }}'>
        <div class="summary-card-main-content">
          <div class="mini-chart-container">
            <canvas id="miniCtdChart"></canvas>
          </div>
          <div class="summary-card-text-content">
            <h5>CTD</h5>
            <div class="mini-summary">
              {% if ctd_info and ctd_info['values'] is not none %}
                Temp: {{ "%.1f"|format(ctd_info['values']['WaterTemperature']) if ctd_info['values']['WaterTemperature'] is not none else 'N/A' }} °C<br>
                Sal: {{ "%.1f"|format(ctd_info['values']['Salinity']) if ctd_info['values']['Salinity'] is not none else 'N/A' }} PSU
              {% else %} N/A {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ ctd_info.time_ago_str if ctd_info else 'N/A' }}
        </div>
      </div>

      <!-- Weather Summary Card -->
      <div class="summary-card" data-category="weather" data-mini-trend='{{ weather_info.mini_trend | tojson | safe if weather_info and "mini_trend" in weather_info and weather_info.mini_trend is not none else "[]" }}'>
        <div class="summary-card-main-content">
          <div class="mini-chart-container">
            <canvas id="miniWeatherChart"></canvas>
          </div>
          <div class="summary-card-text-content">
            <h5>Weather</h5>
            <div class="mini-summary">
              {% if weather_info and weather_info['values'] is not none %}
                Air: {{ "%.1f"|format(weather_info['values']['AirTemperature']) if weather_info['values']['AirTemperature'] is not none else 'N/A' }} °C<br>
                Wind: {{ "%.1f"|format(weather_info['values']['WindSpeed']) if weather_info['values']['WindSpeed'] is not none else 'N/A' }} kt
              {% else %} N/A {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ weather_info.time_ago_str if weather_info else 'N/A' }}
        </div>
      </div>

      <!-- Waves Summary Card -->
      <div class="summary-card" data-category="waves" data-mini-trend='{{ wave_info.mini_trend | tojson | safe if wave_info and "mini_trend" in wave_info and wave_info.mini_trend is not none else "[]" }}'>
        <div class="summary-card-main-content">
          <div class="mini-chart-container">
            <canvas id="miniWaveChart"></canvas>
          </div>
          <div class="summary-card-text-content">
            <h5>Waves</h5>
            <div class="mini-summary">
              {% if wave_info and wave_info['values'] is not none %}
                Hs: {{ "%.1f"|format(wave_info['values']['SignificantWaveHeight']) if wave_info['values']['SignificantWaveHeight'] is not none else 'N/A' }} m<br>
                Dp: <span {% if wave_info['values']['MeanDirectionStatus'] == 'outlier' %}
                          title="Latest data point was an invalid outlier (e.g., 9999)."
                          class="text-warning"
                         {% endif %}>{{ wave_info['values']['MeanDirectionDisplay'] }}</span>
              {% else %} N/A {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ wave_info.time_ago_str if wave_info else 'N/A' }}
        </div>
      </div>

      <!-- VR2C Summary Card -->
      <div class="summary-card" data-category="vr2c" data-mini-trend='{{ vr2c_info.mini_trend | tojson | safe if vr2c_info and "mini_trend" in vr2c_info and vr2c_info.mini_trend is not none else "[]" }}'>
        <div class="summary-card-main-content">
          <div class="mini-chart-container">
            <canvas id="miniVr2cChart"></canvas>
          </div>
          <div class="summary-card-text-content">
            <h5>VR2C-MRx</h5>
            <div class="mini-summary">
              {% if vr2c_info and vr2c_info['values'] is not none %}
                DC: {{ vr2c_info['values']['DetectionCount'] if vr2c_info['values']['DetectionCount'] is not none else 'N/A' }}<br>
                PC: {{ vr2c_info['values']['PingCount'] if vr2c_info['values']['PingCount'] is not none else 'N/A' }}
              {% else %} N/A {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ vr2c_info.time_ago_str if vr2c_info else 'N/A' }}
        </div>
      </div>

      <!-- Fluorometer Summary Card -->
      <div class="summary-card" data-category="fluorometer" data-mini-trend='{{ fluorometer_info.mini_trend | tojson | safe if fluorometer_info and "mini_trend" in fluorometer_info and fluorometer_info.mini_trend is not none else "[]" }}'>
        <div class="summary-card-main-content">
          <div class="mini-chart-container">
            <canvas id="miniFluorometerChart"></canvas>
          </div>
          <div class="summary-card-text-content">
            <h5>Fluorometer</h5>
            <div class="mini-summary">
              {% if fluorometer_info and fluorometer_info['values'] is not none %}
                C1: {{ "%.1f"|format(fluorometer_info['values']['C1_Avg']) if fluorometer_info['values']['C1_Avg'] is not none else 'N/A' }}<br>
                Temp: {{ "%.1f"|format(fluorometer_info['values']['Temperature_Fluor']) if fluorometer_info['values']['Temperature_Fluor'] is not none else 'N/A' }} °C
              {% else %} N/A {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ fluorometer_info.time_ago_str if fluorometer_info else 'N/A' }}
        </div>
      </div>

      <!-- WG-VM4 Summary Card -->
      <div class="summary-card" data-category="wg_vm4" data-mini-trend='{{ wg_vm4_info.mini_trend | tojson | safe if wg_vm4_info and "mini_trend" in wg_vm4_info and wg_vm4_info.mini_trend is not none else "[]" }}'>
        <div class="summary-card-main-content">
          <div class="mini-chart-container">
            <canvas id="miniWgVm4Chart"></canvas>
          </div>
          <div class="summary-card-text-content">
            <h5>WG-VM4</h5>
            <div class="mini-summary">
              {% if wg_vm4_info and wg_vm4_info['values'] is not none %}
                SN: {{ wg_vm4_info['values']['SerialNumber'] if wg_vm4_info['values']['SerialNumber'] is not none else 'N/A' }}<br>
                Ch0 DC: {{ wg_vm4_info['values']['Channel0DetectionCount'] if wg_vm4_info['values']['Channel0DetectionCount'] is not none else 'N/A' }}
              {% else %} N/A {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ wg_vm4_info.time_ago_str if wg_vm4_info else 'N/A' }}
        </div>
      </div>

      <!-- AIS Summary Card -->
      <div class="summary-card" data-category="ais">
        <div class="summary-card-main-content">
          <div class="mini-chart-placeholder"> <!-- Populated with list instead of chart -->
            {% if not ais_summary_data %}
              <span class="no-errors-message">No recent contacts.</span>
            {% else %}
              <ul class="error-message-list"> {# Re-using error list style for consistency #}
                {% for v in ais_summary_data[:2] %} {# Display up to the two most recent contacts #}
                  <li>
                    <small class="text-muted">{{ v.LastSeenTimestamp.strftime('%m-%d %H:%M') if v.LastSeenTimestamp else "N/A" }}:</small>
                    {{ v.ShipName[:25] if v.ShipName else "Unknown" }}{% if v.ShipName and v.ShipName|length > 25 %}...{% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
          </div>
          <div class="summary-card-text-content">   <!-- Removed full-width -->
            <h5>AIS Contacts</h5>
            <div class="mini-summary">
              {% if ais_summary_data %}
                {{ ais_summary_data | length }} recent
              {% else %}
                No recent
              {% endif %}
              {% if has_ais_data %}
                <span class="text-danger ms-1">❗</span>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ ais_update_info.time_ago_str if ais_update_info else 'N/A' }}
        </div>
      </div>

      <!-- Errors Summary Card -->
      <div class="summary-card" data-category="errors">
        <div class="summary-card-main-content">
          <div class="mini-chart-placeholder"> <!-- Error list will go here -->
            {% if not recent_errors_list %}
              <span class="no-errors-message">No recent errors.</span>
            {% else %}
              <ul class="error-message-list">
                {% for err in recent_errors_list[:2] %} {# Display up to the two most recent errors #}
                  <li>
                    <small class="text-muted">{{ err.Timestamp.strftime('%m-%d %H:%M') if err.Timestamp else "N/A" }}:</small>
                    {{ err.ErrorMessage[:25] if err.ErrorMessage else "N/A" }}{% if err.ErrorMessage and err.ErrorMessage|length > 25 %}...{% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
          </div>
          <div class="summary-card-text-content">   <!-- Removed full-width -->
            <h5>Errors {% if has_errors_data %}<span class="text-danger ms-1 position-absolute top-0 end-0 mt-1 me-1">❗</span>{% endif %}</h5>
            <div class="mini-summary">
              {% if recent_errors_list %}
                {{ recent_errors_list | length }} recent
              {% else %}
                0 recent
              {% endif %}
            </div>
          </div>
        </div>
        <div class="summary-card-footer text-muted small">
          {{ errors_update_info.time_ago_str if errors_update_info else 'N/A' }}
        </div>
      </div>

    </div> <!-- End Left Navigation Panel -->

    <!-- Right Main Display Area -->
    <div class="col-md-9" id="main-display-area">
      <div class="category-detail-view card mb-4" id="detail-ais" style="display: none;">
        <div class="card">
          <div class="card-header">
            <h2 class="mb-0">AIS Contacts</h2>
          </div>
          <div class="card-body">
            <ul class="list-unstyled scrollable-list-card">
              {% if ais_summary_data %} {# Updated variable name #}
                {% for v in ais_summary_data %} {# Updated variable name #}
                  <li>{{ v.ShipName or "Unknown Ship" }} (MMSI: {{ v.MMSI or "N/A" }}) — Last Seen: {{ v.LastSeenTimestamp.strftime('%Y-%m-%d %H:%M:%S UTC') if v.LastSeenTimestamp else "N/A" }}</li>
                {% endfor %}
              {% else %}
                <li>No recent AIS contacts.</li>
              {% endif %}
            </ul>
          </div>
          <div class="card-footer text-muted small">
            {% if ais_update_info and ais_update_info.latest_timestamp_str != "N/A" %}
              Last data: {{ ais_update_info.latest_timestamp_str }} ({{ ais_update_info.time_ago_str }})
            {% else %}
              Last data: N/A
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Errors Detail View (Initially Hidden) -->
      <div class="category-detail-view card mb-4" id="detail-errors" style="display: none;">
        <div class="card">
          <div class="card-header">
            <h2 class="mb-0">Errors</h2>
          </div>
          <div class="card-body">
            <ul class="list-unstyled scrollable-list-card">
              {% if recent_errors_list %}
                {% for err in recent_errors_list %}
                  <li>{{ err.Timestamp.strftime('%Y-%m-%d %H:%M:%S UTC') if err.Timestamp else "N/A" }} — {{ err.VehicleName or "N/A" }} — {{ err.ErrorMessage[:60] if err.ErrorMessage else "N/A" }}... (SelfCorrected: {{ err.SelfCorrected }})</li>
                {% endfor %}
              {% else %}
                <li>No recent errors.</li>
              {% endif %}
            </ul>
          </div>
          <div class="card-footer text-muted small">
            {% if errors_update_info and errors_update_info.latest_timestamp_str != "N/A" %}
              Last data: {{ errors_update_info.latest_timestamp_str }} ({{ errors_update_info.time_ago_str }})
            {% else %}
              Last data: N/A
            {% endif %}
          </div>
        </div>
      </div>
      <!-- Navigation Detail View (Initially Displayed or as per JS logic) -->
      <div class="category-detail-view card mb-4" id="detail-navigation" style="display: block;"> <!-- Default visible -->
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="mb-0">Navigation</h2>
            <div class="d-flex align-items-center">
              <!-- Hours back control -->
              <div class="input-group input-group-sm me-2" style="width: 150px;">
                <label class="input-group-text" for="hours-back-telemetry" title="Set the time window for the chart data in hours.">Hours</label>
                <input type="number" class="form-control hours-back-input" id="hours-back-telemetry" value="24" min="1" max="8760" data-report-type="telemetry">
              </div>
              <!-- Granularity control -->
              <div class="input-group input-group-sm" style="width: 150px;">
                <label class="input-group-text" for="granularity-select-telemetry" title="Set the data resampling interval.">Resample</label>
                <select class="form-select granularity-select" id="granularity-select-telemetry" data-report-type="telemetry">
                  <option value="5">5 min</option>
                  <option value="15" selected>15 min</option>
                  <option value="30">30 min</option>
                  <option value="60">60 min</option>
                </select>
              </div>
              <!-- Download Dropdown -->
              <div class="dropdown ms-2">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-download me-1"></i> Download
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item download-csv-btn" href="#" data-report-type="telemetry">Data as CSV</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="navigation">Charts as PNG</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="summary-content-area">
              {% if navigation_info and navigation_info['values'] %}
              <div class="power-task-manager-summary detail-summary-box mb-3">
                  <div class="row">
                      <!-- Column 1: Position & Waypoint -->
                      <div class="col-md-4 power-summary-column">
                          <div class="text-center">
                              <div class="power-summary-header">Latitude</div>
                              <div class="power-summary-value-large" id="nav-latitude">
                                  {{ "%.5f"|format(navigation_info['values'].Latitude) if navigation_info['values'].Latitude is not none else 'N/A' }}
                              </div>
                          </div>
                          <div class="text-center mt-3">
                              <div class="power-summary-header">Longitude</div>
                              <div class="power-summary-value-large" id="nav-longitude">
                                  {{ "%.5f"|format(navigation_info['values'].Longitude) if navigation_info['values'].Longitude is not none else 'N/A' }}
                              </div>
                          </div>
                          <!-- Target Waypoint and last segment distance removed from Column 1 display -->
                      </div>
                      <!-- Column 2: Heading & Speed -->
                      <div class="col-md-4 power-summary-column">
                          <div class="text-center">
                              <div class="power-summary-header">Glider Heading</div>
                              <div class="power-summary-value-large" id="nav-heading">
                                  {{ "%.0f °"|format(navigation_info['values'].GliderHeading) if navigation_info['values'].GliderHeading is not none else 'N/A' }}
                              </div>
                          </div>
                          <div class="text-center mt-3">
                              <div class="power-summary-header">Glider Speed (SOG)</div>
                              <div class="power-summary-value-large" id="nav-speed">
                                  {{ "%.1f kn"|format(navigation_info['values'].SpeedOverGround) if navigation_info['values'].SpeedOverGround is not none else 'N/A' }}
                              </div>
                          </div>
                           <div class="text-center mt-3">
                              <div class="power-summary-header">Avg SOG (24h)</div>
                              <div class="power-summary-value-large" id="nav-avg-sog-24h">
                                  {{ "%.1f kn"|format(navigation_info['values'].AvgSpeedOverGround24h) if navigation_info['values'].AvgSpeedOverGround24h is not none else 'N/A' }}
                              </div>
                          </div>
                      </div>
                      <!-- Column 3: Distance Traveled & Current -->
                      <div class="col-md-4 power-summary-column">
                          <ul class="list-unstyled power-summary-details-list">
                              <li><span class="power-summary-label">Total Dist. Traveled (Mission):</span><span class="power-summary-value-right" id="nav-total-dist-mission">{{ "%.1f NM"|format(navigation_info['values'].TotalDistanceTraveledMissionNM) if navigation_info['values'].TotalDistanceTraveledMissionNM is not none else 'N/A' }}</span></li>
                              <li><span class="power-summary-label">Dist. Traveled (24h):</span><span class="power-summary-value-right" id="nav-dist-24h">{{ "%.1f NM"|format(navigation_info['values'].DistanceTraveled24hNM) if navigation_info['values'].DistanceTraveled24hNM is not none else 'N/A' }}</span></li>
                              <li><span class="power-summary-label">Ocean Current Speed:</span><span class="power-summary-value-right" id="nav-current-speed">{{ "%.1f kn"|format(navigation_info['values'].OceanCurrentSpeed) if navigation_info['values'].OceanCurrentSpeed is not none else 'N/A' }}</span></li>
                              <li><span class="power-summary-label">Ocean Current Dir:</span><span class="power-summary-value-right" id="nav-current-dir">{{ "%.0f °"|format(navigation_info['values'].OceanCurrentDirection) if navigation_info['values'].OceanCurrentDirection is not none else 'N/A' }}</span></li>
                          </ul>
                      </div>
                  </div>
              </div>
              {% elif navigation_info and navigation_info.latest_timestamp_str == "N/A" %}
              <p>Data unavailable.</p>
              {% else %}
              <p>Loading data...</p>
              {% endif %}
            </div>
            <div class="mt-3 chart-container" style="position: relative; height: 300px; width: 100%">
              <h5>Navigation Trends</h5>
              <div class="chart-spinner spinner-border text-light" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <canvas id="telemetryChart"></canvas>
            </div>
            <!-- New Ocean Current Chart -->
            <hr class="my-4">
            <div class="mt-3 chart-container" style="position: relative; height: 300px; width: 100%">
              <h5>Ocean Current & SOG</h5>
              <div class="chart-spinner spinner-border text-light" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <canvas id="telemetryCurrentChart"></canvas>
            </div>
            <!-- New Heading Difference Chart -->
            <hr class="my-4">
            <div class="mt-3 chart-container" style="position: relative; height: 300px; width: 100%">
              <h5>Sub Heading Difference & Ocean Current</h5>
              <div class="chart-spinner spinner-border text-light" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <canvas id="telemetryHeadingDiffChart"></canvas>
            </div>
          </div>
           <div class="card-footer text-muted small">
            {% if navigation_info and navigation_info.latest_timestamp_str != "N/A" %}
              Last data: {{ navigation_info.latest_timestamp_str }} ({{ navigation_info.time_ago_str }})
            {% else %}
              Last data: N/A
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Power Detail View (Initially Hidden) -->
      <div class="category-detail-view card mb-4" id="detail-power" style="display: none;"> 
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="mb-0">Power</h2>
            <div class="d-flex align-items-center">
              <!-- Hours back control -->
              <div class="input-group input-group-sm me-2" style="width: 150px;">
                <label class="input-group-text" for="hours-back-power" title="Set the time window for the chart data in hours.">Hours</label>
                <input type="number" class="form-control hours-back-input" id="hours-back-power" value="24" min="1" max="8760" data-report-type="power">
              </div>
              <!-- Granularity control -->
              <div class="input-group input-group-sm" style="width: 150px;">
                <label class="input-group-text" for="granularity-select-power" title="Set the data resampling interval.">Resample</label>
                <select class="form-select granularity-select" id="granularity-select-power" data-report-type="power">
                  <option value="5">5 min</option>
                  <option value="15" selected>15 min</option>
                  <option value="30">30 min</option>
                  <option value="60">60 min</option>
                </select>
              </div>
              <!-- Download Dropdown -->
              <div class="dropdown ms-2">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-download me-1"></i> Download
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item download-csv-btn" href="#" data-report-type="power">Power Data as CSV</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="power">Charts as PNG</a></li>
                </ul>
              </div>
            </div>
        </div>
        <div class="card-body">
          <div class="summary-content-area">
            {% if power_info and power_info['values'] %} {# Use bracket notation for checking the item #}
            <div class="power-task-manager-summary detail-summary-box mb-3"> {# Added mb-3 for spacing before chart #}
                <div class="row">
                    <!-- Column 1 -->
                    <div class="col-md-4 power-summary-column">
                        <div class="text-center">
                            <div class="power-summary-header">Battery</div>
                            <div class="power-summary-value-large" id="power-battery-soc">
                                {{ "%.1f%%"|format(power_info['values'].BatteryPercentage) if power_info['values'].BatteryPercentage is not none else 'N/A' }}
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <div class="power-summary-header">Charge Rate</div>
                            <div class="power-summary-value-large" id="power-battery-charge-rate">
                                {{ "%.1f W"|format(power_info['values'].BatteryChargeRateW) if power_info['values'].BatteryChargeRateW is not none else 'N/A' }}
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <div class="power-summary-header">Time to Full</div>
                            <div class="power-summary-value-large {% if power_info['values'].TimeToChargeStr == 'Fully Charged' %}status-text-success{% elif 'Discharging' in power_info['values'].TimeToChargeStr or 'Stalled' in power_info['values'].TimeToChargeStr %}status-text-warning{% elif 'h' not in power_info['values'].TimeToChargeStr and 'm' not in power_info['values'].TimeToChargeStr and power_info['values'].TimeToChargeStr != 'N/A' %}status-text-info{% endif %}" id="power-time-to-charge">
                                {{ power_info['values'].TimeToChargeStr if power_info['values'].TimeToChargeStr is not none else 'N/A' }}
                            </div>
                        </div>
                    </div>
            
                    <!-- Column 2 -->
                    <div class="col-md-3 power-summary-column">
                        <div class="text-center">
                            <div class="power-summary-header">Capacity</div>
                            <div class="power-summary-value-large" id="power-battery-wh">
                                {{ "%.0f Wh"|format(power_info['values'].BatteryWattHours) if power_info['values'].BatteryWattHours is not none else 'N/A' }}
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <div class="power-summary-header">Avg Output (24h)</div>
                            <div class="power-summary-value-large" id="power-avg-output">
                                {{ "%.1f W"|format(power_info['values'].AvgOutputPortPower24hrW) if power_info['values'].AvgOutputPortPower24hrW is not none else 'N/A' }}
                            </div>
                        </div>
                    </div>
            
                    <!-- Column 3 -->
                    <div class="col-md-5 power-summary-column">
                        <ul class="list-unstyled power-summary-details-list">
                            <li><span class="power-summary-label">Solar (Now):</span><span class="power-summary-value-right" id="power-solar-now">{{ "%.1f W"|format(power_info['values'].SolarInputWatts) if power_info['values'].SolarInputWatts is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Solar (Avg 24h):</span><span class="power-summary-value-right" id="power-solar-avg-24h">{{ "%.1f W"|format(power_info['values'].AvgSolarInput24hrW) if power_info['values'].AvgSolarInput24hrW is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Panel 1:</span><span class="power-summary-value-right" id="power-panel1">{{ "%.1f W"|format(power_info['values'].Panel1Power) if power_info['values'].Panel1Power is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Panel 2:</span><span class="power-summary-value-right" id="power-panel2">{{ "%.1f W"|format(power_info['values'].Panel2Power) if power_info['values'].Panel2Power is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Panel 3:</span><span class="power-summary-value-right" id="power-panel3">{{ "%.1f W"|format(power_info['values'].Panel4Power) if power_info['values'].Panel4Power is not none else 'N/A' }}</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            {% elif power_info and power_info.latest_timestamp_str == "N/A" %} {# Check if info exists but no valid data #}
            <p>Data unavailable.</p>
            {% else %}
            <p>Loading data...</p> {# Or a more general loading state #}
            {% endif %}
          </div>
          <div class="mt-3 chart-container" style="position: relative; height: 300px; width: 100%">
            <h5>Power Trends</h5>
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="powerChart"></canvas>
          </div>
          <!-- New Solar Panel Chart -->
          <hr class="my-4">
          <div class="mt-3 chart-container" style="position: relative; height: 300px; width: 100%">
            <h5>Individual Solar Panel Power</h5>
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="solarPanelChart"></canvas>
          </div>
        </div>
         <div class="card-footer text-muted small">
          <!-- Ensure this footer content is not affecting the main body height for alignment -->
          {% if power_info and power_info.latest_timestamp_str != "N/A" %}
            Last data: {{ power_info.latest_timestamp_str }} ({{ power_info.time_ago_str }})
          {% else %}
            Last data: N/A
          {% endif %}
        </div>
      </div>
    </div>

      <!-- CTD Detail View (Initially Hidden) -->
      <div class="category-detail-view card mb-4" id="detail-ctd" style="display: none;">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="mb-0">CTD</h2>
            <div class="d-flex align-items-center">
              <!-- Hours back control -->
              <div class="input-group input-group-sm me-2" style="width: 150px;">
                <label class="input-group-text" for="hours-back-ctd" title="Set the time window for the chart data in hours.">Hours</label>
                <input type="number" class="form-control hours-back-input" id="hours-back-ctd" value="24" min="1" max="8760" data-report-type="ctd">
              </div>
              <!-- Granularity control -->
              <div class="input-group input-group-sm" style="width: 150px;">
                <label class="input-group-text" for="granularity-select-ctd" title="Set the data resampling interval.">Resample</label>
                <select class="form-select granularity-select" id="granularity-select-ctd" data-report-type="ctd">
                  <option value="5">5 min</option>
                  <option value="15" selected>15 min</option>
                  <option value="30">30 min</option>
                  <option value="60">60 min</option>
                </select>
              </div>
              <!-- Download Dropdown -->
              <div class="dropdown ms-2">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-download me-1"></i> Download
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item download-csv-btn" href="#" data-report-type="ctd">Data as CSV</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="ctd">Charts as PNG</a></li>
                </ul>
              </div>
            </div>
        </div>
        <div class="card-body">
          <div class="summary-content-area">
            {% if ctd_info and ctd_info['values'] %} {# Use bracket notation for checking the item #}
            <div class="power-task-manager-summary detail-summary-box mb-3"> {# Reusing power summary class for layout #}
                <div class="row">
                    <!-- Column 1: Water Temp, Conductivity, Salinity -->
                    <div class="col-md-6 power-summary-column"> {# Adjust col-md-X as needed #}
                        <div class="text-center">
                            <div class="power-summary-header">Water Temperature</div>
                            <div class="power-summary-value-large" id="ctd-water-temp">
                                {{ "%.2f °C"|format(ctd_info['values'].WaterTemperature) if ctd_info['values'].WaterTemperature is not none else 'N/A' }}
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <div class="power-summary-header">Conductivity</div>
                            <div class="power-summary-value-large" id="ctd-conductivity">
                                {{ "%.3f S/m"|format(ctd_info['values'].Conductivity) if ctd_info['values'].Conductivity is not none else 'N/A' }}
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <div class="power-summary-header">Salinity</div>
                            <div class="power-summary-value-large" id="ctd-salinity">
                                {{ "%.2f PSU"|format(ctd_info['values'].Salinity) if ctd_info['values'].Salinity is not none else 'N/A' }}
                            </div>
                        </div>
                    </div>
            
                    <!-- Column 2: Dissolved Oxygen, Hi/Lo Temp, Pressure -->
                    <div class="col-md-6 power-summary-column"> {# Adjust col-md-X as needed #}
                        <ul class="list-unstyled power-summary-details-list">
                            <li><span class="power-summary-label">Dissolved Oxygen:</span><span class="power-summary-value-right" id="ctd-do">{{ "%.1f Hz"|format(ctd_info['values'].DissolvedOxygen) if ctd_info['values'].DissolvedOxygen is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Highest Temp (24h):</span><span class="power-summary-value-right" id="ctd-hi-temp">{{ "%.2f °C"|format(ctd_info['values'].HighestWaterTemperature24h) if ctd_info['values'].HighestWaterTemperature24h is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Lowest Temp (24h):</span><span class="power-summary-value-right" id="ctd-lo-temp">{{ "%.2f °C"|format(ctd_info['values'].LowestWaterTemperature24h) if ctd_info['values'].LowestWaterTemperature24h is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Pressure:</span><span class="power-summary-value-right" id="ctd-pressure">{{ "%.1f dbar"|format(ctd_info['values'].Pressure) if ctd_info['values'].Pressure is not none else 'N/A' }}</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            {% elif ctd_info and ctd_info.latest_timestamp_str == "N/A" %} {# Check if info exists but no valid data #}
            <p>Data unavailable.</p>
            {% else %} 
            <p>Loading data...</p> {# Or a more general loading state #}
            {% endif %}
          </div>
          <div class="mt-3 chart-container" style="position: relative; height: 300px; width: 100%;">
            <h5>CTD Trends</h5>
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="ctdChart"></canvas>
          </div>
          <!-- New CTD Profile Chart -->
          <hr class="my-4">
          <div class="mt-3 chart-container" style="position: relative; height: 300px; width: 100%;">
            <h5>CTD Profile Aux</h5>
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="ctdProfileChart"></canvas>
          </div>
        </div>
         <div class="card-footer text-muted small">
          {% if ctd_info and ctd_info.latest_timestamp_str != "N/A" %}
            Last data: {{ ctd_info.latest_timestamp_str }} ({{ ctd_info.time_ago_str }})
          {% else %}
            Last data: N/A
          {% endif %}
        </div>
      </div>
    </div>
  
      <!-- Weather Detail View (Initially Hidden) -->
      <div class="category-detail-view card mb-4" id="detail-weather" style="display: none;">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="mb-0">Weather Sensor</h2>
            <div class="d-flex align-items-center">
              <!-- Hours back control -->
              <div class="input-group input-group-sm me-2" style="width: 150px;">
                <label class="input-group-text" for="hours-back-weather" title="Set the time window for the chart data in hours.">Hours</label>
                <input type="number" class="form-control hours-back-input" id="hours-back-weather" value="24" min="1" max="8760" data-report-type="weather">
              </div>
              <!-- Granularity control -->
              <div class="input-group input-group-sm" style="width: 150px;">
                <label class="input-group-text" for="granularity-select-weather" title="Set the data resampling interval.">Resample</label>
                <select class="form-select granularity-select" id="granularity-select-weather" data-report-type="weather">
                  <option value="5">5 min</option>
                  <option value="15" selected>15 min</option>
                  <option value="30">30 min</option>
                  <option value="60">60 min</option>
                </select>
              </div>
              <!-- Download Dropdown -->
              <div class="dropdown ms-2">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-download me-1"></i> Download
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item download-csv-btn" href="#" data-report-type="weather">Data as CSV</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="weather">Charts as PNG</a></li>
                </ul>
              </div>
            </div>
        </div>
        <div class="card-body">
          <div class="summary-content-area">
            {% if weather_info and weather_info['values'] %}
            <div class="power-task-manager-summary detail-summary-box mb-3"> {# Reusing power summary class for layout #}
                <div class="row">
                    <!-- Column 1: Wind Speed, Wind Direction -->
                    <div class="col-md-4 power-summary-column">
                        <div class="text-center">
                            <div class="power-summary-header">Wind Speed</div>
                            <div class="power-summary-value-large" id="weather-wind-speed">
                                {{ "%.1f kt"|format(weather_info['values'].WindSpeed) if weather_info['values'].WindSpeed is not none else 'N/A' }}
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <div class="power-summary-header">Wind Direction</div>
                            <div class="power-summary-value-large" id="weather-wind-dir">
                                {{ "%.0f °"|format(weather_info['values'].WindDirection) if weather_info['values'].WindDirection is not none else 'N/A' }}
                            </div>
                        </div>
                    </div>
            
                    <!-- Column 2: Gust Speed, Gust Direction -->
                    <div class="col-md-4 power-summary-column">
                        <div class="text-center">
                            <div class="power-summary-header">Gust Speed</div>
                            <div class="power-summary-value-large" id="weather-gust-speed">
                                {{ "%.1f kt"|format(weather_info['values'].WindGust) if weather_info['values'].WindGust is not none else 'N/A' }}
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <div class="power-summary-header">Gust Direction</div>
                            <div class="power-summary-value-large" id="weather-gust-dir">
                                {{ "%.0f °"|format(weather_info['values'].GustDirection) if weather_info['values'].GustDirection is not none else 'N/A' }}
                            </div>
                        </div>
                    </div>
            
                    <!-- Column 3: Air Temp & Pressure Details -->
                    <div class="col-md-4 power-summary-column">
                        <ul class="list-unstyled power-summary-details-list">
                            <li><span class="power-summary-label">Air Temp (Now):</span><span class="power-summary-value-right" id="weather-air-temp-now">{{ "%.1f °C"|format(weather_info['values'].AirTemperature) if weather_info['values'].AirTemperature is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Air Temp High (24h):</span><span class="power-summary-value-right" id="weather-air-temp-high">{{ "%.1f °C"|format(weather_info['values'].AirTemperatureHigh24h) if weather_info['values'].AirTemperatureHigh24h is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Air Temp Low (24h):</span><span class="power-summary-value-right" id="weather-air-temp-low">{{ "%.1f °C"|format(weather_info['values'].AirTemperatureLow24h) if weather_info['values'].AirTemperatureLow24h is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Pressure (Now):</span><span class="power-summary-value-right" id="weather-pressure-now">{{ "%.1f mbar"|format(weather_info['values'].BarometricPressure) if weather_info['values'].BarometricPressure is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Pressure High (24h):</span><span class="power-summary-value-right" id="weather-pressure-high">{{ "%.1f mbar"|format(weather_info['values'].PressureHigh24h) if weather_info['values'].PressureHigh24h is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Pressure Low (24h):</span><span class="power-summary-value-right" id="weather-pressure-low">{{ "%.1f mbar"|format(weather_info['values'].PressureLow24h) if weather_info['values'].PressureLow24h is not none else 'N/A' }}</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            {% elif weather_info and weather_info.latest_timestamp_str == "N/A" %} {# Check if info exists but no valid data #}
            <p>Data unavailable.</p> {# Display this if weather_info exists but has no valid data #}
            {% else %}
            <p>Loading data...</p> {# Or a more general loading state #}
            {% endif %}
          </div>
          <div class="mt-3 chart-container" style="position: relative; height: 300px; width: 100%;">
            <h5>Weather Sensor Trends</h5>
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="weatherSensorChart"></canvas>
          </div>
          <!-- Weather Forecast Embedded -->
          <hr class="my-4"> <!-- Add a visual separator -->
          <h4 class="mb-3">Weather Forecast</h4>
          <div id="forecastDisplay">
            <div id="forecastInitial" class="table-responsive" style="display: none;">
                <p class="text-muted">Loading initial forecast...</p>
            </div>
            <button class="btn btn-outline-secondary btn-sm mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#forecastExtended" aria-expanded="false" aria-controls="forecastExtended" id="toggleForecastBtn" style="display: none;">
              Show More
            </button>
            <div class="collapse mt-2" id="forecastExtended">
              <div id="forecastExtendedContent" class="table-responsive">
                <!-- Extended forecast will be rendered here by JS -->
              </div>
            </div>
          </div>
          <div class="text-muted small mt-2" id="forecastMetaInfo" style="display: none;">
            <!-- Forecast metadata will be injected here by JavaScript -->
          </div>
          <!-- End Weather Forecast Embedded -->

        </div>
        <div class="card-footer text-muted small">
          {% if weather_info and weather_info.latest_timestamp_str != "N/A" %}
            Last data: {{ weather_info.latest_timestamp_str }} ({{ weather_info.time_ago_str }})
          {% else %}
            Last data: N/A
          {% endif %}
        </div>
      </div>
    </div>
      <!-- Wave Detail View (Initially Hidden) -->
      <div class="category-detail-view card mb-4" id="detail-waves" style="display: none;">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="mb-0">Wave</h2>
            <div class="d-flex align-items-center">
              <!-- Hours back control -->
              <div class="input-group input-group-sm me-2" style="width: 150px;">
                <label class="input-group-text" for="hours-back-waves" title="Set the time window for the chart data in hours.">Hours</label>
                <input type="number" class="form-control hours-back-input" id="hours-back-waves" value="24" min="1" max="8760" data-report-type="waves">
              </div>
              <!-- Granularity control -->
              <div class="input-group input-group-sm" style="width: 150px;">
                <label class="input-group-text" for="granularity-select-waves" title="Set the data resampling interval.">Resample</label>
                <select class="form-select granularity-select" id="granularity-select-waves" data-report-type="waves">
                  <option value="5">5 min</option>
                  <option value="15" selected>15 min</option>
                  <option value="30">30 min</option>
                  <option value="60">60 min</option>
                </select>
              </div>
              <!-- Download Dropdown -->
              <div class="dropdown ms-2">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-download me-1"></i> Download
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item download-csv-btn" href="#" data-report-type="waves">Data as CSV</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="waves">Charts as PNG</a></li>
                </ul>
              </div>
            </div>
        </div>
        <div class="card-body">
          <div class="summary-content-area">
            {% if wave_info and wave_info['values'] %}
            <div class="power-task-manager-summary detail-summary-box mb-3"> {# Reusing power summary class for layout #}
                <div class="row">
                    <!-- Column 1: Wave Height, Wave Height 24hr Avg -->
                    <div class="col-md-4 power-summary-column">
                        <div class="text-center">
                            <div class="power-summary-header">Wave Height (Hs)</div>
                            <div class="power-summary-value-large" id="wave-height-now">
                                {{ "%.2f m"|format(wave_info['values'].SignificantWaveHeight) if wave_info['values'].SignificantWaveHeight is not none else 'N/A' }}
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <div class="power-summary-header">Avg Hs (24h)</div>
                            <div class="power-summary-value-large" id="wave-height-avg-24h">
                                {{ "%.2f m"|format(wave_info['values'].SignificantWaveHeightAvg24h) if wave_info['values'].SignificantWaveHeightAvg24h is not none else 'N/A' }}
                            </div>
                        </div>
                    </div>
            
                    <!-- Column 2: Wave Direction -->
                    <div class="col-md-4 power-summary-column">
                        <div class="text-center">
                            <div class="power-summary-header">Wave Direction (Dp)</div>
                            <div class="power-summary-value-large" id="wave-direction"> {# Use MeanDirectionDisplay for the text #}
                                <span {% if wave_info['values']['MeanDirectionStatus'] == 'outlier' %}
                                      title="Latest data point was an invalid outlier (e.g., 9999)."
                                      class="text-warning"
                                     {% endif %}>{{ wave_info['values']['MeanDirectionDisplay'] }}</span>
                            </div>
                            {% if wave_info['values'].MeanDirectionNumeric is not none and wave_info['values'].MeanDirectionStatus == 'valid' %}
                            <div class="wave-propagation-arrow-container">
                                <span class="wave-propagation-arrow" 
                                      style="transform: rotate({{ (wave_info['values'].MeanDirectionNumeric + 180) % 360 }}deg);">
                                    &uarr; {# Unicode for upward arrow #}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
            
                    <!-- Column 3: Amplitude, Period, Sample Gaps -->
                    <div class="col-md-4 power-summary-column">
                        <ul class="list-unstyled power-summary-details-list">
                            <li><span class="power-summary-label">Amplitude (A):</span><span class="power-summary-value-right" id="wave-amplitude">{{ "%.2f m"|format(wave_info['values'].WaveAmplitude) if wave_info['values'].WaveAmplitude is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Period (Tp):</span><span class="power-summary-value-right" id="wave-period">{{ "%.1f s"|format(wave_info['values'].WavePeriod) if wave_info['values'].WavePeriod is not none else 'N/A' }}</span></li>
                            <li><span class="power-summary-label">Sample Gaps:</span><span class="power-summary-value-right {% if wave_info['values'].SampleGaps is not none and wave_info['values'].SampleGaps > 10 %}text-danger fw-bold{% elif wave_info['values'].SampleGaps is not none and wave_info['values'].SampleGaps > 2 %}text-warning{% endif %}" id="wave-sample-gaps">{{ "%.0f"|format(wave_info['values'].SampleGaps) if wave_info['values'].SampleGaps is not none else 'N/A' }}</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            {% elif wave_info and wave_info.latest_timestamp_str == "N/A" %} {# Check if info exists but no valid data #}
            <p>Data unavailable.</p>
            {% else %}
            <p>Loading data...</p>
            {% endif %}
          </div>
          <div class="mt-3 chart-container" style="position: relative; height: 300px; width: 100%;">
            <h5>Wave Trends</h5>
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="waveChart"></canvas>
          </div>
          <!-- New Wave Chart: Height vs Direction -->
          <hr class="my-4">
          <div class="mt-3 chart-container" style="position: relative; height: 300px; width: 100%;">
            <h5>Wave Height & Direction</h5>
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="waveHeightDirectionChart"></canvas>
          </div>

          <!-- New Wave Spectrum Chart -->
          <hr class="my-4">
          <div class="mt-3 chart-container" style="position: relative; height: 300px; width: 100%;">
            <h5>Latest Wave Energy Spectrum (E(f))</h5>
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="waveSpectrumChart"></canvas> <!-- Ensure this ID is present -->
          </div>

          <!-- Marine Weather Forecast Embedded -->
          <hr class="my-4"> <!-- Add a visual separator -->
          <h4 class="mb-3">Marine Forecast</h4>
          <div id="marineForecastDisplay">
            <div id="marineForecastInitial" class="table-responsive" style="display: none;">
                <p class="text-muted">Loading marine forecast...</p>
            </div>
            <button class="btn btn-outline-secondary btn-sm mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#marineForecastExtended" aria-expanded="false" aria-controls="marineForecastExtended" id="toggleMarineForecastBtn" style="display: none;">
              Show More
            </button>
            <div class="collapse mt-2" id="marineForecastExtended">
              <div id="marineForecastExtendedContent" class="table-responsive">
                <!-- Extended marine forecast will be rendered here by JS -->
              </div>
            </div>
          </div>
          <div class="text-muted small mt-2" id="marineForecastMetaInfo" style="display: none;">
            <!-- Marine forecast metadata will be injected here by JavaScript -->
          </div>
          <!-- End Marine Weather Forecast Embedded -->
        </div>
        <div class="card-footer text-muted small">
          {% if wave_info and wave_info.latest_timestamp_str != "N/A" %}
            Last data: {{ wave_info.latest_timestamp_str }} ({{ wave_info.time_ago_str }})
          {% else %}
            Last data: N/A
          {% endif %}
        </div>
      </div>
    </div>

      <!-- VR2C Detail View (Initially Hidden) -->
      <div class="category-detail-view card mb-4" id="detail-vr2c" style="display: none;">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="mb-0">VR2C-MRx Acoustic Receiver</h2>
            <div class="d-flex align-items-center">
              <!-- Hours back control -->
              <div class="input-group input-group-sm me-2" style="width: 150px;">
                <label class="input-group-text" for="hours-back-vr2c" title="Set the time window for the chart data in hours.">Hours</label>
                <input type="number" class="form-control hours-back-input" id="hours-back-vr2c" value="24" min="1" max="8760" data-report-type="vr2c">
              </div>
              <!-- Granularity control -->
              <div class="input-group input-group-sm" style="width: 150px;">
                <label class="input-group-text" for="granularity-select-vr2c" title="Set the data resampling interval.">Resample</label>
                <select class="form-select granularity-select" id="granularity-select-vr2c" data-report-type="vr2c">
                  <option value="5">5 min</option>
                  <option value="15" selected>15 min</option>
                  <option value="30">30 min</option>
                  <option value="60">60 min</option>
                </select>
              </div>
              <!-- Download Dropdown -->
              <div class="dropdown ms-2">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-download me-1"></i> Download
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item download-csv-btn" href="#" data-report-type="vr2c">Data as CSV</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="vr2c">Charts as PNG</a></li>
                </ul>
              </div>
            </div>
        </div>
        <div class="card-body">
          <div class="summary-content-area">
            {% if vr2c_info and vr2c_info['values'] is not none %}
            <div class="detail-summary-box mb-3">
              <ul class="list-unstyled">
                <li>
                  Serial Number: {{ vr2c_info['values']['SerialNumber'] if vr2c_info['values']['SerialNumber'] is not none else '<span class="na-value">N/A</span>' | safe }}
                </li>
                <li>
                  Detection Count (DC): {{ vr2c_info['values']['DetectionCount'] if vr2c_info['values']['DetectionCount'] is not none else '<span class="na-value">N/A</span>' | safe }}
                </li>
                <li>
                  Ping Count (PC): {{ vr2c_info['values']['PingCount'] if vr2c_info['values']['PingCount'] is not none else '<span class="na-value">N/A</span>' | safe }}
                </li>
              </ul>
            </div>
            {% elif vr2c_info and vr2c_info.latest_timestamp_str == "N/A" %}
            <p>Data unavailable.</p>
            {% else %}
            <p>Loading data...</p>
            {% endif %}
          </div>
          <div class="mt-3 chart-container" style="position: relative; height: 300px; width: 100%;">
            <h5>VR2C Trends</h5>
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="vr2cChart"></canvas>
          </div>
        </div>
        <div class="card-footer text-muted small">
          {% if vr2c_info and vr2c_info.latest_timestamp_str != "N/A" %}
            Last data: {{ vr2c_info.latest_timestamp_str }} ({{ vr2c_info.time_ago_str }})
          {% else %}
            Last data: N/A
          {% endif %}
        </div>
      </div>
    </div>
    
      <!-- Fluorometer Detail View (Initially Hidden) -->
      <div class="category-detail-view card mb-4" id="detail-fluorometer" style="display: none;">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="mb-0">C3 Fluorometer</h2>
            <div class="d-flex align-items-center">
              <!-- Hours back control -->
              <div class="input-group input-group-sm me-2" style="width: 150px;">
                <label class="input-group-text" for="hours-back-fluorometer" title="Set the time window for the chart data in hours.">Hours</label>
                <input type="number" class="form-control hours-back-input" id="hours-back-fluorometer" value="24" min="1" max="8760" data-report-type="fluorometer">
              </div>
              <!-- Granularity control -->
              <div class="input-group input-group-sm" style="width: 150px;">
                <label class="input-group-text" for="granularity-select-fluorometer" title="Set the data resampling interval.">Resample</label>
                <select class="form-select granularity-select" id="granularity-select-fluorometer" data-report-type="fluorometer">
                  <option value="5">5 min</option>
                  <option value="15" selected>15 min</option>
                  <option value="30">30 min</option>
                  <option value="60">60 min</option>
                </select>
              </div>
              <!-- Download Dropdown -->
              <div class="dropdown ms-2">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-download me-1"></i> Download
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item download-csv-btn" href="#" data-report-type="fluorometer">Data as CSV</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="fluorometer">Charts as PNG</a></li>
                </ul>
              </div>
            </div>
        </div>
        <div class="card-body">
          <div class="summary-content-area">
            {% if fluorometer_info and fluorometer_info['values'] is not none %}
            <div class="detail-summary-box mb-3">
              <ul class="list-unstyled">
                <li>
                  C1 Avg: {{ "%.2f"|format(fluorometer_info['values']['C1_Avg']) if fluorometer_info['values']['C1_Avg'] is not none else '<span class="na-value">N/A</span>' | safe }}
                </li>
                <li>
                  C2 Avg: {{ "%.2f"|format(fluorometer_info['values']['C2_Avg']) if fluorometer_info['values']['C2_Avg'] is not none else '<span class="na-value">N/A</span>' | safe }}
                </li>
                <li>
                  C3 Avg: {{ "%.2f"|format(fluorometer_info['values']['C3_Avg']) if fluorometer_info['values']['C3_Avg'] is not none else '<span class="na-value">N/A</span>' | safe }}
                </li>
                <li>
                  Temperature (°C): {{ "%.2f"|format(fluorometer_info['values']['Temperature_Fluor']) if fluorometer_info['values']['Temperature_Fluor'] is not none else '<span class="na-value">N/A</span>' | safe }}
                </li>
              </ul>
            </div>
            {% elif fluorometer_info and fluorometer_info.latest_timestamp_str == "N/A" %}
            <p>Data unavailable.</p>
            {% else %}
            <p>Loading data...</p>
            {% endif %}
          </div>
          <div class="mt-3 chart-container" style="position: relative; height: 300px; width: 100%;">
            <h5>Fluorometer Trends</h5>
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="fluorometerChart"></canvas>
          </div>
        </div>
        <div class="card-footer text-muted small">
          {% if fluorometer_info and fluorometer_info.latest_timestamp_str != "N/A" %}
            Last data: {{ fluorometer_info.latest_timestamp_str }} ({{ fluorometer_info.time_ago_str }})
          {% else %}
            Last data: N/A
          {% endif %}
        </div>
      </div>
    </div>

      <!-- WG-VM4 Detail View (Initially Hidden) -->
      <div class="category-detail-view card mb-4" id="detail-wg_vm4" style="display: none;">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="mb-0">WG-VM4 Sensor</h2>
            <div class="d-flex align-items-center">
              <!-- Hours back control -->
              <div class="input-group input-group-sm me-2" style="width: 150px;">
                <label class="input-group-text" for="hours-back-wg_vm4" title="Set the time window for the chart data in hours.">Hours</label>
                <input type="number" class="form-control hours-back-input" id="hours-back-wg_vm4" value="24" min="1" max="8760" data-report-type="wg_vm4">
              </div>
              <!-- Granularity control -->
              <div class="input-group input-group-sm" style="width: 150px;">
                <label class="input-group-text" for="granularity-select-wg_vm4" title="Set the data resampling interval.">Resample</label>
                <select class="form-select granularity-select" id="granularity-select-wg_vm4" data-report-type="wg_vm4">
                  <option value="5">5 min</option>
                  <option value="15" selected>15 min</option>
                  <option value="30">30 min</option>
                  <option value="60">60 min</option>
                </select>
              </div>
              <!-- Download Dropdown -->
              <div class="dropdown ms-2">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-download me-1"></i> Download
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item download-csv-btn" href="#" data-report-type="wg_vm4">Data as CSV</a></li>
                  <li><a class="dropdown-item save-charts-btn" href="#" data-report-type="wg_vm4">Charts as PNG</a></li>
                </ul>
              </div>
            </div>
        </div>
        <div class="card-body">
          <!-- WG-VM4 Health Summary (existing) -->
          <div class="summary-content-area detail-summary-box mb-3">
            {% if wg_vm4_info and wg_vm4_info['values'] is not none %}
            <div>
              <h5>VM4 Health Summary</h5>
              <ul class="list-unstyled">
                <li>Serial Number: {{ wg_vm4_info['values']['SerialNumber'] if wg_vm4_info['values']['SerialNumber'] is not none else 'N/A' }}</li>
                <li>Channel 0 Detections: {{ wg_vm4_info['values']['Channel0DetectionCount'] if wg_vm4_info['values']['Channel0DetectionCount'] is not none else 'N/A' }}</li>
                <li>Channel 1 Detections: {{ wg_vm4_info['values']['Channel1DetectionCount'] if wg_vm4_info['values']['Channel1DetectionCount'] is not none else 'N/A' }}</li>
              </ul>
            </div>
            {% elif wg_vm4_info and wg_vm4_info.latest_timestamp_str == "N/A" %}
            <p class="text-muted">VM4 health data unavailable.</p>
            {% else %}
            <p class="text-muted">Loading VM4 health data...</p>
            {% endif %}
          </div>
          <hr>
          <!-- Station Offload Log Section -->
          <h4 class="mt-4">Station Offload Log</h4>
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="stationIdSearch" class="form-label">Station ID Search:</label>
              <div class="input-group">
                <input type="text" class="form-control form-control-sm" id="stationIdSearch" placeholder="e.g., CBS001">
                <button class="btn btn-sm btn-outline-secondary" type="button" id="fetchStationDataBtn">Load</button>
              </div>
              <div id="stationSearchResults" class="list-group mt-1 position-absolute" style="z-index: 1000; width: calc(100% - 1rem); display:none;"></div>
            </div>
          </div>

          <div id="stationMetadataDisplay" class="mb-3 p-3 border rounded bg-body-tertiary" style="display: none;">
            <h5>Station Details</h5>
            <div class="row">
              <div class="col-md-6">
                <p class="mb-1"><small><strong>Serial Number:</strong> <span id="metaSerial">N/A</span></small></p>
                <p class="mb-1"><small><strong>Modem Address:</strong> <span id="metaModemAddr">N/A</span></small></p>
                <p class="mb-1"><small><strong>Depth (m):</strong> <span id="metaDepth">N/A</span></small></p>
              </div>
              <div class="col-md-6">
                <p class="mb-1"><small><strong>WP #:</strong> <span id="metaWp">N/A</span></small></p>
                <p class="mb-1"><small><strong>Last Offload:</strong> <span id="metaLastOffload">N/A</span></small></p>
                <p class="mb-1"><small><strong>Last Offload Time:</strong> <span id="metaLastOffloadTimestamp">N/A</span></small></p>
                <p class="mb-1"><small><strong>Settings:</strong> <span id="metaSettings">N/A</span></small></p>
              </div>
              <div class="col-12 mt-1" id="metaNotesContainer" style="display:none;">
                 <p class="mb-1"><small><strong>Station Notes:</strong> <span id="metaNotes"></span></small></p>
              </div>
            </div>
          </div>
          <div id="stationMetadataError" class="alert alert-warning" style="display:none;"></div>

          <form id="wgVm4OffloadForm">
            <!-- Offload Parameters & Timings (Dynamically generated by JS based on schema, or hardcoded here) -->
            <!-- For simplicity, we'll add a few key fields here and JS can enhance -->
            <h5 class="mt-3">Offload Details</h5>
             <!-- Input fields will be added here by JS or defined statically -->
            <div id="offloadLogFormFieldsContainer"></div>
            <button type="submit" class="btn btn-primary mt-3" id="submitOffloadLogBtn" disabled>Submit Offload Log</button>
          </form>
          <div id="offloadSubmissionStatus" class="mt-3"></div>

          <div class="mt-3 chart-container" style="position: relative; height: 300px; width: 100%;">
            <h5>WG-VM4 Trends</h5>
            <div class="chart-spinner spinner-border text-light" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="wgVm4Chart"></canvas>
          </div>
        </div>
        <div class="card-footer text-muted small">
          {% if wg_vm4_info and wg_vm4_info.latest_timestamp_str != "N/A" %}
            Last data: {{ wg_vm4_info.latest_timestamp_str }} ({{ wg_vm4_info.time_ago_str }})
          {% else %}
            Last data: N/A
          {% endif %}
        </div>
      </div>
    </div>
    </div> <!-- End Right Main Display Area -->
  </div> <!-- End New Two-Column Layout / End Right Main Display Area -->
    <!-- --- Footer --- -->
  <hr>

{% endblock %}

{% block body_extra_js %}
  <script type="module" src="/static/js/dashboard.js"></script>
  <script src="/static/js/wg_vm4.js" defer></script> {# Load WG-VM4 specific JS #}
{% endblock %}
