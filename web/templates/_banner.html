<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top" style="height: var(--banner-height);">
  <div class="container-fluid">
    <div class="d-flex flex-column w-100"> {# New wrapper div to stack rows vertically #}
      <!-- Top Row -->
      <div class="navbar-top-row d-flex align-items-center position-relative" style="height: var(--banner-top-row-height);"> {# Added position-relative for absolute positioning #}
        <div class="d-flex align-items-center" style="padding-left: var(--banner-padding-x);"> {# Left aligned title #}
          <a class="navbar-brand d-flex align-items-center" href="/home.html" style="padding-top: 0; padding-bottom: 0; margin-right: 0;">
            <img src="/static/images/wgbs_logo.svg" alt="Wave Glider Buddy System Logo" class="navbar-logo me-2">
            <h3 class="navbar-title mb-0">Wave Glider Buddy System</h3>
          </a>
        </div>
        <!-- Centered UTC Clock - positioned absolutely to stay centered -->
        <div class="position-absolute top-50 start-50 translate-middle">
          <span id="utcClockBanner" class="navbar-text"></span>
        </div>
        <ul class="navbar-nav ms-auto" style="padding-right: var(--banner-padding-x);"> {# Right aligned user dropdown #}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false"> {# Removed text-align:right, as it's handled by flexbox #}
              <span id="usernameDisplayBanner">{{ current_user.username if current_user else 'User' }}</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
              <li><a class="dropdown-item" href="/user_settings.html">User Settings</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" id="logoutBtnBanner">Logout</a></li>
              <li><hr class="dropdown-divider"></li>
              <li>
                <div class="px-3 py-1">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="themeSwitch">
                    <label class="form-check-label small" for="themeSwitch">Dark Mode</label>
                  </div>
                </div>
              </li>
            </ul>
          </li>
        </ul>
      </div>

      <!-- Bottom Row -->
      <div class="navbar-bottom-row" style="height: var(--banner-bottom-row-height);">
        <ul class="navbar-nav d-flex" style="padding-left: var(--banner-padding-x); width:100%;"> {# Removed justify-content-start for individual item control #}
          <li class="nav-item dropdown me-3"> {# Added me-3 for spacing #}
            <a class="nav-link dropdown-toggle" href="#" id="activeMissionDashboardDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Active Mission Dashboard
            </a>
            <ul class="dropdown-menu" aria-labelledby="activeMissionDashboardDropdown" id="activeMissionSelectorDropdownMenu">
              <!-- Active mission options populated by JS -->
              <li><a class="dropdown-item" href="/">Loading Missions...</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown me-3"> {# Added me-3 for spacing #}
            <a class="nav-link dropdown-toggle" href="#" id="historicalMissionDashboardDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Historical Mission Dashboard
            </a>
            <ul class="dropdown-menu" aria-labelledby="historicalMissionDashboardDropdown" id="historicalMissionSelectorDropdownMenu">
              <!-- Historical mission options populated by JS -->
              <li><a class="dropdown-item" href="/historical">Loading Missions...</a></li>
            </ul>
          </li>
          {% if features.schedule %}
          <li class="nav-item me-3"> {# Added me-3 for spacing #}
            <a class="nav-link" href="/schedule.html">Schedule</a>
          </li>
          {% endif %}
          {% if features.station_offloads %}
          <li class="nav-item me-3"> {# Added me-3 for spacing #}
            <a class="nav-link" href="/view_station_status.html">Station Offloads</a>
          </li>
          {% endif %}
          <li class="nav-item dropdown me-3">
            <a class="nav-link dropdown-toggle" href="#" id="knowledgeBaseDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fas fa-book"></i> Knowledge Base
            </a>
            <ul class="dropdown-menu" aria-labelledby="knowledgeBaseDropdown">
              <li><a class="dropdown-item" href="/chatbot.html">
                <i class="fas fa-robot"></i> Ask Chatbot
              </a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="/knowledge_base.html">
                <i class="fas fa-book"></i> Documents
              </a></li>
              <li><a class="dropdown-item" href="/my_notes.html">
                <i class="fas fa-sticky-note"></i> My Notes
              </a></li>
              <li><a class="dropdown-item" href="/shared_tips.html">
                <i class="fas fa-lightbulb"></i> Shared Tips
              </a></li>
              <li><a class="dropdown-item" href="/admin_faqs.html">
                <i class="fas fa-question-circle"></i> Manage FAQs
              </a></li>
            </ul>
          </li>
          {% if features.payroll %}
          <li class="nav-item dropdown me-3" id="payrollDropdown" style="display: none;">
            <a class="nav-link dropdown-toggle" href="#" id="payrollDropdownLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Payroll
            </a>
            <ul class="dropdown-menu" aria-labelledby="payrollDropdownLink">
              <li><a class="dropdown-item" href="/payroll/submit.html">Submit Timesheet</a></li>
              <li><a class="dropdown-item" href="/payroll/my_timesheets.html">My Timesheets</a></li>
            </ul>
          </li>
          {% endif %}
          {% if features.pic_management %}
          <li class="nav-item dropdown me-3" id="picManagementDropdown" style="display: none;"> {# Added me-3 for spacing #}
            <a class="nav-link dropdown-toggle" href="#" id="picManagementDropdownLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              PIC Management
            </a>
            <ul class="dropdown-menu" aria-labelledby="picManagementDropdownLink">
              <li><a class="dropdown-item" id="submitNewPicHandoffLink" href="#">Submit New PIC Handoff</a></li>
              <li><a class="dropdown-item" href="/my_pic_handoffs.html">My PIC Handoffs</a></li>
              <li><a class="dropdown-item" href="/view_pic_handoffs.html">Recent PIC Handoffs (24h)</a></li>
            </ul>
          </li>
          {% endif %}
          {% if features.admin_management %}
          <li class="nav-item dropdown me-3" id="adminManagementDropdown" style="display: none;"> {# Added me-3 for spacing #}
            <a class="nav-link dropdown-toggle" href="#" id="adminManagementDropdownLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Admin Management
            </a>
            <ul class="dropdown-menu" aria-labelledby="adminManagementDropdownLink">
              <li><a class="dropdown-item" href="/admin/announcements.html">Manage Announcements</a></li>
              <li><a class="dropdown-item" href="/admin/mission_overviews.html">Manage Mission Overviews</a></li>
              <li><a class="dropdown-item" href="/admin/user_management.html">User Management</a></li>
              <li><a class="dropdown-item" href="/admin/pay_periods.html">Manage Pay Periods</a></li>
              <li><a class="dropdown-item" href="/admin/timesheets.html">View Submitted Timesheets</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="/api/admin/scheduler_status.html">Scheduler Status</a></li>
            </ul>
          </li>
          {% endif %}
          <!-- Auto-refresh toggle, only visible on dashboard page -->
          {% if is_current_mission_realtime %}
          <li class="nav-item ms-auto me-3"> {# ms-auto pushes this to the right #}
            <div class="form-check form-switch d-flex align-items-center"> {# Removed float:right #}
              <input class="form-check-input me-2" type="checkbox" role="switch" id="autoRefreshToggleBanner" checked>
              <label class="form-check-label small text-white" for="autoRefreshToggleBanner" title="Enable/disable auto-refresh. Page will refresh when cache updates (every ~10 minutes).">Auto-Refresh <span id="refreshCountdown"></span></label>
            </div>
          </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>
</nav>
<script>
  (function() {
    document.addEventListener('DOMContentLoaded', function() {
      var rootEl = document.documentElement;
      var switchEl = document.getElementById('themeSwitch');

      if (!rootEl || !switchEl) { return; }

      // Determine initial theme: localStorage -> existing data-theme -> system preference -> 'light'
      var stored = localStorage.getItem('theme');
      var current = rootEl.getAttribute('data-theme');
      var systemPrefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      var initial = stored || current || (systemPrefersDark ? 'dark' : 'light');

      // Apply and sync toggle state
      rootEl.setAttribute('data-theme', initial);
      switchEl.checked = initial === 'dark';

      // Persist on toggle
      switchEl.addEventListener('change', function() {
        var nextTheme = switchEl.checked ? 'dark' : 'light';
        rootEl.setAttribute('data-theme', nextTheme);
        try { localStorage.setItem('theme', nextTheme); } catch (e) {}
      });

      // Optional: react to system theme changes if user hasn't explicitly chosen
      if (!stored && window.matchMedia) {
        try {
          var mq = window.matchMedia('(prefers-color-scheme: dark)');
          mq.addEventListener('change', function(ev) {
            var autoTheme = ev.matches ? 'dark' : 'light';
            rootEl.setAttribute('data-theme', autoTheme);
            switchEl.checked = autoTheme === 'dark';
          });
        } catch (e) {}
      }
    });
  })();
</script>