{% extends "base.html" %}

{% block title %}Home - Wave Glider Buddy{% endblock %}

{% block content %}
<div class="container mt-4" 
     data-user-role="{{ current_user.role if current_user.is_authenticated else '' }}"
     data-user-id="{{ current_user.id if current_user.is_authenticated else '' }}">
    {% set has_sidebar = is_schedule_enabled or is_payroll_enabled %}
    {% set main_col_class = 'col-lg-9' if has_sidebar else 'col-lg-10 col-xl-8' %}
    <div class="row {% if not has_sidebar %}justify-content-center{% endif %}">
        <!-- Main Content Area -->
        <div class="{{ main_col_class }} mx-auto">
            <h1>Welcome, {{ current_user.full_name or current_user.username }}!</h1>

            <!-- Announcements Panel -->
            <div id="announcementsPanel" class="mb-4">
                <!-- Active announcements will be loaded here by home.js -->
                <div class="d-flex justify-content-center"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading announcements...</span></div></div>
            </div>

            <!-- Tabbed Interface for Mission Briefings -->
            <!-- DEBUG: active_missions = {{ active_missions }} -->
            <!-- DEBUG: active_mission_data keys = {{ active_mission_data.keys() if active_mission_data else 'None' }} -->
            {% if active_missions %}
                <!-- Nav tabs -->
                <ul class="nav nav-tabs mt-4" id="missionBriefingTabs" role="tablist">
                    {% for mission_id in active_missions %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if loop.first %}active{% endif %}" id="tab-{{ mission_id }}" data-bs-toggle="tab" data-bs-target="#pane-{{ mission_id }}" type="button" role="tab" aria-controls="pane-{{ mission_id }}" aria-selected="{{ 'true' if loop.first else 'false' }}">
                            Mission {{ mission_id }}
                        </button>
                    </li>
                    {% endfor %}
                </ul>

                <!-- Tab panes -->
                <div class="tab-content" id="missionBriefingTabsContent">
                    {% for mission_id, mission_info in active_mission_data.items() %}
                    <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="pane-{{ mission_id }}" role="tabpanel" aria-labelledby="tab-{{ mission_id }}" tabindex="0">
                        <!-- This is the entire mission briefing card, now inside a tab pane -->
                        <div class="card border-top-0 rounded-0 rounded-bottom mt-0 mb-4 mission-info-section" data-mission-id="{{ mission_id }}">
                            <div class="card-body">
                                <div class="row">
                                    <!-- Left side: Overview and Notes -->
                                    <div class="col-lg-7">
                                        <!-- Mission Overview Section -->
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h4 class="mb-0">Mission Overview</h4>
                                            {% if current_user and current_user.role == 'admin' %}
                                                <a href="/admin/mission_overviews.html" class="btn btn-sm btn-outline-secondary" title="Edit Mission Overview"><i class="fas fa-pencil-alt"></i> Edit</a>
                                            {% endif %}
                                        </div>
                                        <div class="mission-overview-content">
                                            {% if mission_info.overview and mission_info.overview.document_url %}
                                                <p>A detailed overview is available. <a href="{{ mission_info.overview.document_url }}" target="_blank">View Document</a></p>
                                            {% else %}
                                                <p class="text-muted">No mission overview has been defined.</p>
                                            {% endif %}
                                        </div>

                                        <!-- Mission Media Section -->
                                        <div class="mission-media-section mt-4">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h5 class="mb-0">Deployment & Recovery Media</h5>
                                            </div>
                                            {% if current_user and current_user.role == 'admin' %}
                                            <div class="alert alert-warning small mission-media-pending-alert" style="display: none;">
                                                Pending media approvals: <span class="pending-count">0</span>
                                            </div>
                                            {% endif %}
                                            {% if current_user %}
                                            <form class="mission-media-upload-form mb-3">
                                                <div class="row g-2">
                                                    <div class="col-md-5">
                                                        <input type="file" class="form-control form-control-sm mission-media-file" accept="image/*,video/*" required>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <select class="form-select form-select-sm mission-media-operation">
                                                            <option value="">Operation type</option>
                                                            <option value="deployment">Deployment</option>
                                                            <option value="recovery">Recovery</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <input type="text" class="form-control form-control-sm mission-media-caption" placeholder="Caption (optional)">
                                                    </div>
                                                </div>
                                                <div class="mt-2 d-flex align-items-center gap-2">
                                                    <button type="submit" class="btn btn-sm btn-primary">Upload</button>
                                                    <small class="text-muted">Images up to 10MB, videos up to 50MB.</small>
                                                </div>
                                            </form>
                                            {% endif %}
                                            <div class="row g-2 mission-media-gallery" data-mission-id="{{ mission_id }}">
                                                {% if mission_info.media %}
                                                    {% for media in mission_info.media %}
                                                    <div class="col-6 col-md-4 mission-media-item" data-media-id="{{ media.id }}">
                                                        <div class="card h-100">
                                                            {% if media.media_type == 'photo' %}
                                                            <a href="{{ media.file_url }}" target="_blank" rel="noopener noreferrer">
                                                                <img src="{{ media.file_url }}" class="card-img-top" alt="{{ media.caption or 'Mission media' }}" style="object-fit: cover; height: 140px;">
                                                            </a>
                                                            {% else %}
                                                            <video class="card-img-top" controls preload="metadata" style="height: 140px; object-fit: cover;">
                                                                <source src="{{ media.file_url }}">
                                                            </video>
                                                            {% endif %}
                                                            <div class="card-body p-2">
                                                                <div class="small text-muted mb-1">
                                                                    {{ (media.operation_type or 'Unspecified')|title }} â€¢ {{ media.uploaded_by_username }}
                                                                </div>
                                                                {% if media.caption %}
                                                                <div class="small">{{ media.caption }}</div>
                                                                {% endif %}
                                                                {% if current_user and (current_user.role == 'admin' or current_user.username == media.uploaded_by_username) %}
                                                                <button type="button" class="btn btn-sm btn-outline-danger mt-2 mission-media-delete-btn" data-media-id="{{ media.id }}">Delete</button>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                {% else %}
                                                    <div class="col-12 text-muted small mission-media-empty">No media uploaded yet.</div>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- Sensor Tracker Metadata Section -->
                                        {% if mission_info.sensor_tracker_deployment %}
                                        <hr>
                                        <div class="mt-3">
                                            <h5 class="mb-3">Sensor Tracker Metadata</h5>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <dl class="row mb-0">
                                                        {% if mission_info.sensor_tracker_deployment.title %}
                                                        <dt class="col-sm-5">Title:</dt>
                                                        <dd class="col-sm-7">{{ mission_info.sensor_tracker_deployment.title }}</dd>
                                                        {% endif %}
                                                        
                                                        {% if mission_info.sensor_tracker_deployment.start_time %}
                                                        <dt class="col-sm-5">Start:</dt>
                                                        <dd class="col-sm-7">{{ mission_info.sensor_tracker_deployment.start_time.strftime('%Y-%m-%d %H:%M UTC') }}</dd>
                                                        {% endif %}
                                                        
                                                        {% if mission_info.sensor_tracker_deployment.end_time %}
                                                        <dt class="col-sm-5">End:</dt>
                                                        <dd class="col-sm-7">{{ mission_info.sensor_tracker_deployment.end_time.strftime('%Y-%m-%d %H:%M UTC') }}</dd>
                                                        {% endif %}
                                                        
                                                        {% if mission_info.sensor_tracker_deployment.data_repository_link %}
                                                        <dt class="col-sm-5">Data Repository:</dt>
                                                        <dd class="col-sm-7">
                                                            <a href="{{ mission_info.sensor_tracker_deployment.data_repository_link }}" target="_blank" rel="noopener noreferrer">
                                                                {{ mission_info.sensor_tracker_deployment.data_repository_link }}
                                                            </a>
                                                        </dd>
                                                        {% endif %}
                                                    </dl>
                                                </div>
                                                <div class="col-md-6">
                                                    <dl class="row mb-0">
                                                        {% if mission_info.sensor_tracker_deployment.deployment_comment %}
                                                        <dt class="col-sm-12 mb-2">Deployment Description:</dt>
                                                        <dd class="col-sm-12">
                                                            <p class="text-muted small mb-0" style="white-space: pre-wrap;">{{ mission_info.sensor_tracker_deployment.deployment_comment }}</p>
                                                        </dd>
                                                        {% endif %}
                                                    </dl>
                                                </div>
                                            </div>
                                            
                                            <!-- Instruments Section -->
                                            {% set platform_instruments = [] %}
                                            {% set science_instruments = [] %}
                                            {% for inst in mission_info.sensor_tracker_instruments if inst %}
                                                {% if inst.is_platform_direct %}
                                                    {% set _ = platform_instruments.append(inst) %}
                                                {% elif inst.data_logger_type == "science" %}
                                                    {% set _ = science_instruments.append(inst) %}
                                                {% endif %}
                                            {% endfor %}
                                            
                                            {% if platform_instruments or science_instruments %}
                                            <div class="row mt-3">
                                                {% if platform_instruments %}
                                                <div class="col-md-6">
                                                    <h6 class="mb-2">Platform Direct Instruments</h6>
                                                    <ul class="list-unstyled small">
                                                        {% for inst in platform_instruments %}
                                                        <li class="mb-1">
                                                            <strong>{{ inst.instrument_name or inst.instrument_identifier }}</strong>
                                                            {% if inst.instrument_serial %}
                                                            <span class="text-muted">({{ inst.instrument_serial }})</span>
                                                            {% endif %}
                                                        </li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                                {% endif %}
                                                
                                                {% if science_instruments %}
                                                <div class="col-md-6">
                                                    <h6 class="mb-2">Science Computer Instruments</h6>
                                                    <ul class="list-unstyled small">
                                                        {% for inst in science_instruments %}
                                                        <li class="mb-1">
                                                            <strong>{{ inst.instrument_name or inst.instrument_identifier }}</strong>
                                                            {% if inst.instrument_serial %}
                                                            <span class="text-muted">({{ inst.instrument_serial }})</span>
                                                            {% endif %}
                                                        </li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% endif %}

                                        <hr>

                                        <!-- Mission Notes Section -->
                                        <div class="mt-4">
                                            <h4 class="mb-3">Mission Notes</h4>
                                            <div class="mission-notes-container">
                                                <ul class="list-group mission-notes-list">
                                                    {% if mission_info.notes %}
                                                        {% for note in mission_info.notes %}
                                                            <li class="list-group-item d-flex justify-content-between align-items-start" data-note-id="{{ note.id }}">
                                                              <div>
                                                                <p class="mb-1">{{ note.content | e }}</p>
                                                                <small class="text-muted">
                                                                    &mdash; {{ note.created_by_username or 'Unknown' }} on {{ note.created_at_utc.strftime('%Y-%m-%d %H:%M UTC') }}
                                                                </small>
                                                              </div>
                                                              {% if current_user and (current_user.role == 'admin' or current_user.id == note.created_by_user_id) %}
                                                              <button class="btn btn-sm btn-outline-danger delete-note-btn ms-2" title="Delete Note" data-note-id="{{ note.id }}"><i class="fas fa-trash-alt"></i></button>
                                                              {% endif %}
                                                            </li>
                                                        {% endfor %}
                                                    {% else %}
                                                        <li class="list-group-item text-muted no-mission-notes-placeholder">No mission notes have been added.</li>
                                                    {% endif %}
                                                </ul>
                                                {% if current_user %} {# Any authenticated user can add a note #}
                                                <div class="card mt-3">
                                                  <div class="card-body p-2">
                                                      <textarea class="form-control new-mission-note-content" rows="2" placeholder="Add a new mission note..."></textarea>
                                                      <button class="btn btn-sm btn-primary mt-2 add-mission-note-btn">Add Note</button>
                                                  </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Right side: Goals -->
                                    <div class="col-lg-5">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                          <h4 class="mb-0">Mission Goals</h4>
                                          {% if current_user and current_user.role == 'admin' %}
                                              <button class="btn btn-sm btn-primary add-goal-btn" title="Add New Goal"><i class="fas fa-plus"></i> Add Goal</button>
                                          {% endif %}
                                        </div>
                                        <ul class="list-group mission-goals-list">
                                            {% if mission_info.goals %}
                                                {% for goal in mission_info.goals %}
                                                    <li class="list-group-item d-flex justify-content-between align-items-start" data-goal-id="{{ goal.id }}">
                                                        <div class="form-check flex-grow-1">
                                                            <input class="form-check-input mission-goal-checkbox" type="checkbox" value="" id="goal-{{ mission_id }}-{{ goal.id }}" data-goal-id="{{ goal.id }}" {% if goal.is_completed %}checked{% endif %}>
                                                            <label class="form-check-label {% if goal.is_completed %}text-decoration-line-through text-muted{% endif %}" for="goal-{{ mission_id }}-{{ goal.id }}">
                                                                {{ goal.description | e }}
                                                            </label>
                                                            {% if current_user and current_user.role == 'admin' %}
                                                              <button class="btn btn-sm btn-link p-0 ms-2 edit-goal-btn" title="Edit Goal" data-goal-id="{{ goal.id }}" data-description="{{ goal.description | e }}"><i class="fas fa-pencil-alt"></i></button>
                                                              <button class="btn btn-sm btn-link p-0 ms-2 text-danger delete-goal-btn" title="Delete Goal" data-goal-id="{{ goal.id }}"><i class="fas fa-trash-alt"></i></button>
                                                            {% endif %}
                                                        </div>
                                                        {% if goal.is_completed %}
                                                            <span class="badge bg-success rounded-pill small ms-2" title="Completed at {{ goal.completed_at_utc.strftime('%Y-%m-%d %H:%M UTC') if goal.completed_at_utc else '' }}">
                                                                By: {{ goal.completed_by_username }}
                                                            </span>
                                                        {% endif %}
                                                    </li>
                                                {% endfor %}
                                            {% else %}
                                                <li class="list-group-item text-muted no-mission-goals-placeholder">No mission goals have been defined.</li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                </div> <!-- /.row -->
                            </div> <!-- /.card-body -->
                            <div class="card-footer text-end">
                                {# This button is only rendered for admins and opens the report modal #}
                                {% if current_user.role.value == 'admin' %}
                                    <button class="btn btn-sm btn-outline-secondary generate-report-modal-btn" data-mission-id="{{ mission_id }}">
                                        <i class="fas fa-file-pdf"></i> Generate Report
                                    </button>
                                {% endif %}
                            
                                {# This link is shown if a report URL already exists, and will be made visible by JS when a new one is generated #}
                                <a href="{{ mission_info.overview.weekly_report_url if mission_info.overview and mission_info.overview.weekly_report_url else '#' }}" 
                                   class="btn btn-sm btn-outline-info view-report-link" 
                                   style="display: {{ 'inline-block' if mission_info.overview and mission_info.overview.weekly_report_url else 'none' }};" 
                                   target="_blank" data-mission-id="{{ mission_id }}">
                                    <i class="fas fa-eye"></i> View Report
                                </a>
                            </div>
                        </div> <!-- /.card -->
                    </div> <!-- /.tab-pane -->
                    {% endfor %}
                </div> <!-- /.tab-content -->
            {% else %}
            <div class="alert alert-info">No missions are currently available to display.</div>
            {% endif %}

            <hr>
            
            <!-- Quick Links -->
            <div class="row justify-content-center">
                {# Mission Dashboard quick link temporarily removed (redundant until historical data returns) #}
                {% if feature_enabled('schedule') %}
                <div class="col-md-8 col-lg-6 mb-3" data-feature="schedule">
                    <div class="card h-100">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">Daily Schedule</h5>
                            <p class="card-text">View and sign up for piloting shifts for all ongoing missions.</p>
                            <a href="/schedule.html" class="btn btn-primary mt-auto">View Schedule</a>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Mission Map Section -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-map-marked-alt"></i> Mission Track Map</h5>
                </div>
                <div class="card-body" 
                     data-active-missions='{{ active_missions | tojson }}'
                     data-default-hours="24">
                    <!-- Map Controls -->
                    <div class="row mb-3">
                        <div class="col-md-6 mb-2">
                            <label for="mapMissionSelect" class="form-label small">Select Mission</label>
                            <select id="mapMissionSelect" class="form-select form-select-sm">
                                <option value="all" selected>All Active Missions</option>
                                {% for mission_id in active_missions %}
                                <option value="{{ mission_id }}">Mission {{ mission_id }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label for="mapHoursBack" class="form-label small">Time Range</label>
                            <select id="mapHoursBack" class="form-select form-select-sm">
                                <option value="24" selected>Last 24 hours</option>
                                <option value="72">Last 72 hours</option>
                                <option value="168">Last week</option>
                                <option value="720">Last month</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-2 d-flex align-items-end">
                            <button id="generateMapBtn" class="btn btn-primary btn-sm w-100">Generate Map</button>
                        </div>
                    </div>
                    
                    <!-- Track Info -->
                    <div id="mapTrackInfo" class="mb-3"></div>
                    
                    <!-- Map Container -->
                    <div id="missionMapContainer" style="height: 400px; border: 1px solid #ddd; border-radius: 4px;"></div>
                    
                    <!-- Download Buttons -->
                    <div class="mt-3 text-center">
                        <button id="downloadKMLBtn" class="btn btn-outline-secondary btn-sm me-2">
                            <i class="fas fa-download"></i> Download KML
                        </button>
                        <button id="downloadLiveKMLBtn" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-satellite-dish"></i> Generate Live KML
                        </button>
                    </div>
                    
                    <!-- Live KML Status -->
                    <div id="liveKMLStatus" class="mt-2"></div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar: User-Specific Information -->
        {% if has_sidebar %}
        <div class="col-lg-3">
            {% if feature_enabled('schedule') %}
            <div class="card sticky-top" style="top: 130px;" data-feature="schedule">
                <div class="card-header"><h5 class="mb-0">My Upcoming Shifts</h5></div>
                <div class="card-body" id="upcomingShiftsContent" style="max-height: 400px; overflow-y: auto;">
                    <div class="d-flex justify-content-center"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></div>
                </div>
                <div class="card-footer text-center">
                    <a href="/schedule.html" class="btn btn-sm btn-outline-primary">View Full Schedule</a>
                </div>
            </div>
            {% endif %}
            <!-- New Timesheet Status Panel -->
            {% if feature_enabled('payroll') %}
            <div class="card mt-4" data-feature="payroll">
                <div class="card-header"><h5 class="mb-0">My Timesheet Status</h5></div>
                <div class="card-body" id="timesheetStatusContent" style="max-height: 400px; overflow-y: auto;">
                    <div class="d-flex justify-content-center"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></div>
                </div>
                <div class="card-footer text-center">
                    <a href="/payroll/my_timesheets.html" class="btn btn-sm btn-outline-primary">View My Timesheets</a>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Modals for Admin Actions -->
    {% if current_user and current_user.role == 'admin' %}
    <!-- Add/Edit Goal Modal -->
    <div class="modal fade" id="goalModal" tabindex="-1" aria-labelledby="goalModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="goalModalLabel">Add Mission Goal</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="goalForm">
              <input type="hidden" id="goalIdInput">
              <div class="mb-3">
                <label for="goalDescriptionInput" class="form-label">Goal Description</label>
                <textarea class="form-control" id="goalDescriptionInput" rows="3" required></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="saveGoalBtn">Save Goal</button>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block body_extra_js %}
  <!-- Include the Showdown library for Markdown rendering in announcements -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <script src="{{ url_for('static', path='js/home.js') }}" type="module"></script>
    <script src="{{ url_for('static', path='js/map_generator.js') }}" type="module"></script>
{% endblock %}